---
title: 'Section B: State of Washington School Finance Systems and Structures'
author: "Katherine Chang"
date: "`r format(Sys.Date(), format = '%B %d, %Y')`"
output: 
  html_document:
    toc: true
    toc_float: true
    fig_width: 10
knit: (function(input, encoding) rmarkdown::render(input, output_file = "section_b_analysis.html"))
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE,
                      comment = NA, 
                      cache = TRUE,
                      warning = FALSE,
                      message = FALSE, 
                      cache.lazy = FALSE,
                      fig.align = "center"
                      )
```

# Introduction

```{r data_read, include=FALSE}
library(tidyverse)
library(googledrive)
library(haven)

id_f196 <- drive_get(as_id("https://drive.google.com/file/d/1sGIIj3hplOHq7qPL7S7YTmQByzuCcHVU/view?usp=sharing"))

id_f196_expenditures <- drive_get(as_id("https://drive.google.com/file/d/17FERYE8eHgc1WPRoMZV42UC5aeE17SGC/view?usp=sharing")) #2015-2020

id_f195 <- drive_get(as_id("https://drive.google.com/file/d/10XytJG-r2zfM3vpbClTJP9Jnz-6nX0Ef/view?usp=sharing"))

id_demos <- drive_get(as_id("https://drive.google.com/file/d/1coJ9kMZUpRmxNyli6xZ31WITaZdyJXIk/view?usp=sharing"))

id_cwi <- drive_get(as_id("https://drive.google.com/file/d/1--RKu4geGLO9sOxag7pyJtkw40ZYYkeI/view?usp=sharing"))

df_f196 <- id_f196 %>%
  drive_read_raw() %>%
  read_dta()

df_f196_expenditures <- id_f196_expenditures %>%
  drive_read_raw() %>%
  read_dta()

df_demos <- id_demos %>%
  drive_read_raw() %>%
  read_dta()

df_cwi <- id_cwi %>%
  drive_read_raw() %>%
  read_csv()

df_f195 <- id_f195 %>%
  drive_read_raw() %>%
  read_dta()
```


```{r data_cleaning, include=FALSE}

library(collapse)

df_demos_dist <- df_demos %>%
  mutate(coudis_s = str_pad(as.character(CountyDistrictNumber), 5, side="left", pad="0"),
         schyear = paste("20", gsub("[0-9]+-", "", SchoolYear), sep=""))%>%
  group_by(coudis_s, schyear)%>%
  summarise_at(c("TotalEnrollment",
                 "NumberAmericanIndianOrAlaskan",
                 "NumberAsian",
                 "NumberBlack",
                 "NumberHispanic",
                 "NumberAsianPacificIslander",
                 "NumberMultirac",
                 "NumberWhite",
                 "NumberFreeorReducedPricedMeals",
                 "NumberSpecialEducation",
                 "NumberTransitionalBilingual"), 
               sum)%>% 
  mutate(schyear=as.numeric(schyear))

df_demos_dist <- df_demos_dist%>%
  mutate(PctAmericanIndianOrAlaskan = NumberAmericanIndianOrAlaskan/TotalEnrollment,
         PctAsian = NumberAsian/TotalEnrollment,
         PctBlack = NumberBlack/TotalEnrollment,
         PctHispanic = NumberHispanic/TotalEnrollment,
         PctAsianPacificIslander = NumberAsianPacificIslander/TotalEnrollment,
         PctMultirac = NumberMultirac/TotalEnrollment,
         PctWhite = NumberWhite/TotalEnrollment,
         PctFreeorReducedPricedMeals = NumberFreeorReducedPricedMeals/TotalEnrollment,
         PctSpecialEducation = NumberSpecialEducation/TotalEnrollment,
         PctTransitionalBilingual = NumberTransitionalBilingual/TotalEnrollment
         )%>%
  mutate_at(vars(PctAmericanIndianOrAlaskan:PctTransitionalBilingual), ~replace_na(., 0))

df_demos_dist$dist_nstu_soc = rowSums((df_demos_dist[,c("NumberAsian", "NumberBlack", "NumberHispanic", "NumberAmericanIndianOrAlaskan", "NumberAsianPacificIslander", "NumberMultirac")]), na.rm = TRUE)

df_demos_dist <- df_demos_dist%>%
  mutate(dist_pctstu_soc = as.numeric(dist_nstu_soc/TotalEnrollment),
         dist_group_soc = case_when(dist_pctstu_soc >= 0  & dist_pctstu_soc < 0.25 ~ '1',
                                    dist_pctstu_soc >= 0.25  & dist_pctstu_soc < 0.50 ~ '2',
                                    dist_pctstu_soc >= 0.50  & dist_pctstu_soc < 0.75 ~ '3',
                                    dist_pctstu_soc >= 0.75  & dist_pctstu_soc <= 1 ~ '4')
  )

df_e_merge_raw <- full_join(df_f196_expenditures, df_demos_dist, by=c("coudis_s"="coudis_s", "schyear"="schyear"))

df_f195_fed <- df_f195%>%
  group_by(CCDDD, year)%>%
  filter(item_desc=="TOTAL FEDERAL, GENERAL PURPOSE" | item_desc=="TOTAL FEDERAL, SPECIAL PURPOSE")

df_f195_fed <- collap(df_f195_fed, amount~ CCDDD + year, 
                           FUN = list(fsum))

df_f195_fed <- df_f195_fed%>%
  rename(coudis=CCDDD,
         schyear=year,
         rev_fed=amount)

df_cwi <- df_cwi%>%
  mutate(coudis_s = str_pad(as.character(dist_id), 5, side="left", pad="0"))

df_f196_merge_raw <- full_join(df_f196, df_demos_dist, by=c("coudis"="coudis_s", "schyear"="schyear"))

df_f196_merge_raw<- full_join(df_f196_merge_raw, df_cwi, by=c("coudis"="coudis_s", "schyear"="year"))

df_f196_merge_raw<- full_join(df_f196_merge_raw, df_f195_fed, by=c("coudis"="coudis", "schyear"="schyear"))

```

Our guiding research questions include:

- How have Washington public schools been funded in the past few years (NEED YEARS), particularly for districts serving high-poverty and students of color? 
- How have McCleary school finance reforms changed schools funding sources per pupil? 
- How have these changes varied across districts? 
- How do schools spend their resources?

# B1: Revenue source for high- and low-poverty districts

```{r B1_revenue_data, include=FALSE}

library(caret)
library(car)

#Pull revenue categories fron F195: Federal, State, Local, and Other
df_f195_all <- df_f195%>%
  filter(
    item_desc=="TOTAL FEDERAL, GENERAL PURPOSE" |                                        
      item_desc=="TOTAL FEDERAL, SPECIAL PURPOSE" |                                     
      item_desc=="TOTAL LOCAL SUPPORT NONTAX" |                                         
      item_desc=="TOTAL LOCAL TAXES" |                                                  
      item_desc=="TOTAL STATE, GENERAL PURPOSE" |                                       
      item_desc=="TOTAL STATE, SPECIAL PURPOSE")%>%
  mutate(rev_source = case_when(str_detect(item_desc, 'FEDERAL') ~ "Federal",
                                str_detect(item_desc, 'STATE') ~ "State",
                                str_detect(item_desc, 'LOCAL') ~ "Local",
                                TRUE ~ 'NA'))

df_f195_collapse <- collap(df_f195_all, amount~ CCDDD + year + rev_source, 
                           FUN = list(fsum))

df_f195_collapse <- df_f195_collapse%>%
  rename(coudis=CCDDD,
         schyear=year,
         revenue_amount=amount)

#df_f195_collapse_total <- collap(df_f195_collapse, revenue_amount~ coudis + schyear, 
#                           FUN = list(fsum))

#df_f195_collapse_total <- df_f195_collapse_total%>%
#  mutate(rev_source ="Total")

#df_f195_bind<- rbind(df_f195_collapse, df_f195_collapse_total)

#Bring in NCES Geographic designation.
#https://nces.ed.gov/programs/edge/Geographic/SchoolLocations

id_nces_geo <-drive_get(as_id("https://drive.google.com/file/d/1YXv-RxZMVEO3YiIF-RS4IFTClFgUOHgh/view?usp=sharing"))

df_nces_geo <- id_nces_geo %>%
  drive_read_raw() %>%
  read_csv()

df_locale_wa <- df_nces_geo%>%
  filter(STATE=="WA")%>%
  select(LEAID, NAME, LOCALE, SCHOOLYEAR)%>%
  mutate(LOCALE=as.character(LOCALE),
         LEAID=as.numeric(LEAID))

#Calculate poverty rate by school district and census

#Add CPI (Generated by Chris's package) and CWI (Generated by Pooya)
df_cpi18 <- df_f196%>%
  select(schyear, cpi18)%>%
  distinct()

df_cwi_cpi<- merge(df_cpi18, df_cwi, by.x = "schyear", by.y = "year")

df_f195_cwi<- full_join(df_f195_collapse, df_cwi_cpi, by=c("coudis"="coudis_s", "schyear"="schyear"))
df_f195_merge <- full_join(df_f195_cwi, df_demos_dist, by=c("coudis"="coudis_s", "schyear"="schyear"))

df_f195_merge <- left_join(df_f195_merge, df_locale_wa, by=c("leaid"="LEAID"))

#Adjust dollars by CWI
df_f195_merge <- df_f195_merge%>%
  mutate(rev_cwi=revenue_amount/cwi,
         rev_pp_cwi=rev_cwi/TotalEnrollment,
         rev_pp_cwi_18d=rev_pp_cwi*cpi18, 
         dist_group_soc = as.factor(dist_group_soc))%>%
    drop_na(dist_group_soc)

levels(df_f195_merge$dist_group_soc) <- c("0-24%","25-49%","50-74%", "75-100%")

#QUESTION: I adjusted the values by revenue category separately and then total the adjusted values together
#is this the right approach?

#Build figures by revenue source
##FEDERAL
df_f195_fed <- df_f195_merge%>%
  filter(rev_source=="Federal")

model_fed <- lm(rev_pp_cwi_18d ~ TotalEnrollment + LOCALE + PctSpecialEducation + PctTransitionalBilingual,
             data=df_f195_fed)

df_f195_fed$rev_adjusted <- predict.lm(model_fed, newdata=df_f195_fed)

#STATE
df_f195_state <- df_f195_merge%>%
  filter(rev_source=="State")

model_state <- lm(rev_pp_cwi_18d ~ TotalEnrollment + LOCALE + PctSpecialEducation + PctTransitionalBilingual,
             data=df_f195_state)

df_f195_state$rev_adjusted <- predict.lm(model_state, newdata=df_f195_state)

#LOCAL
df_f195_loc <- df_f195_merge%>%
  filter(rev_source=="Local")

model_loc <- lm(rev_pp_cwi_18d ~ TotalEnrollment + LOCALE + PctSpecialEducation + PctTransitionalBilingual,
             data=df_f195_loc)

df_f195_loc$rev_adjusted <- predict.lm(model_loc, newdata=df_f195_loc)


#Adjust for district size (TotalEnrollment), urbanicity (using LOCALE codes), average cost of labor (cwi), and the percent of students enrolled in special education (PctSpecialEducation) and classified as limited English proficient (PctTransitionalBilingual).

```

Federal, state, and local revenue source for high- and low-poverty districts

```{r B1_revenue_pov, include=FALSE, eval=FALSE}

#QUESTION: Annual poverty rate from 2015-2020? 
#Calculate poverty rate by school district and ACS?

library(tidycensus)
readRenviron("~/.Renviron")
Sys.getenv("CENSUS_API_KEY")

df_var <- load_variables(2018, "acs5", cache = TRUE)

df_dist_pov_raw <- get_acs("school district",
                             variables = "B17001_002",
                             summary_var = "B01003_001",
                             year=2018,
                             state = "WA", #FIPS code 53
                             county = "King", #FIPS code 033
                             geometry = FALSE, 
                             moe = 95, #margin of error
                             cache_table = TRUE)
```

# B2: Revenue source for districts serving students of color

```{r B2_revenue_soc}

#NOTE: NEED AT ADD 2020

df_f195_fed_figure = df_f195_fed%>%
  group_by(dist_group_soc, schyear)%>%
  summarize(rev_adjusted_total=mean(rev_adjusted, na.rm = TRUE))

ggplot(df_f195_fed_figure, 
       aes(x=schyear, y=rev_adjusted_total, group=dist_group_soc)) +
  geom_line(aes(colour = dist_group_soc))+
  theme(panel.background = element_blank(), 
        axis.line.x = element_line(color = "#D3D3D3"),
        panel.grid.major.x = element_line(color = "#D3D3D3"),
        plot.title.position = "plot"
        ) +
  labs(title="Figure. Federal Revenue Amount Per Student",
       subtitle = "Regression adjusted for difference of cost factors including district size, 
       urbanicity/locale, average cost of labor, and percent of students enrolled in 
       special education and classified as limited English proficient")+
  xlab("School Year (Spring)") + 
  ylab("2018 Dollars") + 
  geom_vline(xintercept = 2018, colour='#FFFFFF', linetype="dashed")+
  labs(color="Student of Color \nPercentage") 

####

df_f195_state_figure = df_f195_state%>%
  group_by(dist_group_soc, schyear)%>%
  summarize(rev_adjusted_total=mean(rev_adjusted, na.rm = TRUE))

ggplot(df_f195_state_figure, 
       aes(x=schyear, y=rev_adjusted_total, group=dist_group_soc)) +
  geom_line(aes(colour = dist_group_soc))+
  theme(panel.background = element_blank(), 
        axis.line.x = element_line(color = "#D3D3D3"),
        panel.grid.major.x = element_line(color = "#D3D3D3"),
        plot.title.position = "plot"
        ) +
  labs(title="Figure. State Revenue Amount Per Student",
       subtitle = "Regression adjusted for difference of cost factors including district size, 
       urbanicity/locale, average cost of labor, and percent of students enrolled in 
       special education and classified as limited English proficient")+
  xlab("School Year (Spring)") + 
  ylab("2018 Dollars") + 
  geom_vline(xintercept = 2018, colour='#FFFFFF', linetype="dashed")+
  labs(color="Student of Color \nPercentage") 

####

df_f195_loc_figure = df_f195_loc%>%
  group_by(dist_group_soc, schyear)%>%
  summarize(rev_adjusted_total=mean(rev_adjusted, na.rm = TRUE))

ggplot(df_f195_loc_figure, 
       aes(x=schyear, y=rev_adjusted_total, group=dist_group_soc)) +
  geom_line(aes(colour = dist_group_soc))+
  theme(panel.background = element_blank(), 
        axis.line.x = element_line(color = "#D3D3D3"),
        panel.grid.major.x = element_line(color = "#D3D3D3"),
        plot.title.position = "plot"
        ) +
  labs(title="Figure. Local Revenue Amount Per Student",
       subtitle = "Regression adjusted for difference of cost factors including district size, 
       urbanicity/locale, average cost of labor, and percent of students enrolled in 
       special education and classified as limited English proficient")+
  xlab("School Year (Spring)") + 
  ylab("2018 Dollars") + 
  geom_vline(xintercept = 2018, colour='#FFFFFF', linetype="dashed")+
  labs(color="Student of Color \nPercentage") 



```

Federal, state, and local revenue source for districts serving students of color

# B3: Spatial distribution of school funding

```{r B3_maps_data}

library(leaidr)
library(sf)

wa <- lea_get("wa")%>% 
  sf::st_as_sf() 

df_f196_merge <- df_f196_merge_raw%>%
  filter(schyear >= 2016 & schyear <=2020)%>%
  mutate(leaid = as.character(leaid),
         rev_fed_18d_Total = rev_fed*cpi18,
         rev_fed_pp_18d=(rev_fed_18d_Total/dis_enroll),
         rev_st_pp_18d=(rev_st_18d_Total/dis_enroll),
         rev_loc_pp_18d=(localrev_201819Spring_18d/dis_enroll),
         post_mcl_reform = ifelse(schyear>= 2019, "1", "0"))

df_f196_merge <- df_f196_merge%>%
  group_by(schyear)%>%
  mutate(
    rev_fed_mean = mean(rev_fed_pp_18d, na.rm = TRUE),
    rev_st_mean = mean(rev_st_pp_18d, na.rm = TRUE), 
    rev_loc_mean = mean(rev_loc_pp_18d, na.rm = TRUE))

df_f196_merge <- df_f196_merge%>%
  group_by(coudis, post_mcl_reform)%>%
  mutate(rev_fed_mean_reform = mean(rev_fed_pp_18d, na.rm = TRUE), 
         rev_st_mean_reform = mean(rev_st_pp_18d, na.rm = TRUE), 
         rev_loc_mean_reform = mean(rev_loc_pp_18d, na.rm = TRUE))

df_f196_merge <- df_f196_merge%>%
  mutate(
    rev_fed_diff= (rev_fed_pp_18d-rev_fed_mean),
    rev_st_diff= (rev_st_pp_18d-rev_st_mean),
    rev_loc_diff=(rev_loc_pp_18d-rev_loc_mean))

mccleary_revenue <- collap(df_f196_merge, rev_fed_mean_reform + rev_st_mean_reform + rev_loc_mean_reform~ leaid + post_mcl_reform, 
                           FUN = list(fmean))

mccleary_rev_wide <- mccleary_revenue%>%
  group_by(leaid)%>% 
  pivot_wider(names_from = post_mcl_reform, 
              values_from = c(rev_fed_mean_reform, rev_st_mean_reform, rev_loc_mean_reform))

mccleary_rev_wide <- mccleary_rev_wide%>%
  mutate(
    rev_fed_mean_reform_diff = (rev_fed_mean_reform_1 - rev_fed_mean_reform_0),
    rev_st_mean_reform_diff = (rev_st_mean_reform_1 - rev_st_mean_reform_0),
    rev_loc_mean_reform_diff = (rev_loc_mean_reform_1 - rev_loc_mean_reform_0))

wa_df196 <- left_join(df_f196_merge, wa, by = c("leaid" = "GEOID"), copy=TRUE) 

wa_mccleary_rev_wide <- left_join(mccleary_rev_wide, wa, by = c("leaid" = "GEOID"), copy=TRUE) 

#What percentage higher than lower than state average for the state/local revenue
#Distribution of dollars -> district that serve large % of SOC/low-income

```

## Demographic Maps
```{r B3_maps_demo}

#Demographic Maps

wa_df196 %>%
  sf::st_as_sf() %>% 
  filter(schyear==2019)%>%
  ggplot() +
  geom_sf(aes(fill = PctHispanic), size = .25) +
  scale_fill_gradient2(low="#FFFFFF", high="#4b2e83", name="Percentage") +
  theme_void() +
  labs(title="Figure. Latinx Students Percentage of Total Student Enrollment, 2018-2019 ")+
  theme(plot.title = element_text(hjust = 0.5))

wa_df196 %>%
  sf::st_as_sf() %>% 
  filter(schyear==2019)%>%
  ggplot() +
  geom_sf(aes(fill = PctBlack), size = .25) +
  scale_fill_gradient2(low="#FFFFFF", high="#4b2e83", name="Percentage") +
  theme_void() +
  labs(title="Figure. Black Students Percentage of Total Student Enrollment, 2018-2019 ")+
  theme(plot.title = element_text(hjust = 0.5))

wa_df196 %>%
  sf::st_as_sf() %>% 
  filter(schyear==2019)%>%
  ggplot() +
  geom_sf(aes(fill = PctAmericanIndianOrAlaskan), size = .25) +
  scale_fill_gradient2(low="#FFFFFF", high="#4b2e83", name="Percentage") +
  theme_void() +
  labs(title="Figure. Indigenous Students Percentage of Total Student Enrollment, 2018-2019 ")+
  theme(plot.title = element_text(hjust = 0.5))

wa_df196 %>%
  sf::st_as_sf() %>% 
  filter(schyear==2019)%>%
  ggplot() +
  geom_sf(aes(fill = PctAsian), size = .25) +
  scale_fill_gradient2(low="#FFFFFF", high="#4b2e83", name="Percentage") +
  theme_void() +
  labs(title="Figure. Asian Students Percentage of Total Student Enrollment, 2018-2019 ")+
  theme(plot.title = element_text(hjust = 0.5))

wa_df196 %>%
  sf::st_as_sf() %>% 
  filter(schyear==2019)%>%
  ggplot() +
  geom_sf(aes(fill = PctMultirac), size = .25) +
  scale_fill_gradient2(low="#FFFFFF", high="#4b2e83", name="Percentage") +
  theme_void() +
  labs(title="Figure. Multiracial Students Percentage of Total Student Enrollment, 2018-2019 ")+
  theme(plot.title = element_text(hjust = 0.5))

```

## Revenue Maps
```{r B3_maps_rev}

#Need to figure out what colors work best with this map to make it pop

wa_df196 %>%
  sf::st_as_sf() %>% 
  filter(schyear==2019)%>%
  ggplot() +
  geom_sf(aes(fill = rev_fed_pp_18d), size = .25) +
  scale_fill_gradient2(low="#FFFFFF", high="#4b2e83", name="2018 Dollars") +
  theme_void() +
  labs(title="Figure. Federal Revenue Per Pupil, 2018-2019")+
  theme(plot.title = element_text(hjust = 0.5))

wa_df196 %>%
  sf::st_as_sf() %>% 
  filter(schyear==2019)%>%
  ggplot() +
  geom_sf(aes(fill = rev_st_pp_18d), size = .25) +
  scale_fill_gradient2(low="#FFFFFF", high="#4b2e83", name="2018 Dollars") +
  theme_void() +
  labs(title="Figure. State Revenue Per Pupil, 2018-2019")+
  theme(plot.title = element_text(hjust = 0.5))

wa_df196 %>%
  sf::st_as_sf() %>% 
  filter(schyear==2019)%>%
  ggplot() +
  geom_sf(aes(fill = rev_loc_pp_18d), size = .25) +
  scale_fill_gradient2(low="#FFFFFF", high="#4b2e83", name="2018 Dollars") +
  theme_void() +
  labs(title="Figure. Local Levy Revenue Per Pupil, 2018-2019")+
  theme(plot.title = element_text(hjust = 0.5))

wa_df196 %>%
  sf::st_as_sf() %>% 
  filter(schyear==2019)%>%
  ggplot() +
  geom_sf(aes(fill = rev_fed_diff), size = .25) +
  scale_fill_gradient2(low="#FF0000", midpoint = 0, mid="#FFFFFF", high="#4b2e83", name="2018 Dollars") +
  theme_void() +
  labs(title="Figure. Federal Revenue Per Pupil, 2018-2019",
       subtitle = "Dollar Difference Against State Mean for the School Year")+
  theme(plot.title = element_text(hjust = 0.5),
        plot.subtitle = element_text(hjust = 0.5))

wa_df196 %>%
  sf::st_as_sf() %>% 
  filter(schyear==2019)%>%
  ggplot() +
  geom_sf(aes(fill = rev_st_diff), size = .25) +
  scale_fill_gradient2(low="#FF0000", midpoint = 0, mid="#FFFFFF", high="#4b2e83", name="2018 Dollars") +
  theme_void() +
  labs(title="Figure. State Revenue Per Pupil, 2018-2019",
       subtitle = "Dollar Difference Against State Mean for the School Year")+
  theme(plot.title = element_text(hjust = 0.5),
        plot.subtitle = element_text(hjust = 0.5))

wa_df196 %>%
  sf::st_as_sf() %>% 
  filter(schyear==2019)%>%
  ggplot() +
  geom_sf(aes(fill = rev_loc_diff), size = .25) +
  scale_fill_gradient2(low="#FF0000", midpoint = 0, mid="#FFFFFF", high="#4b2e83", name="2018 Dollars") +
  theme_void() +
  labs(title="Figure. Local Levy Revenue Per Pupil, 2018-2019",
       subtitle = "Dollar Difference Against State Mean for the School Year")+
  theme(plot.title = element_text(hjust = 0.5),
        plot.subtitle = element_text(hjust = 0.5))
```


## McCleary Maps
```{r B3_maps_mccleary}

wa_mccleary_rev_wide %>%
  sf::st_as_sf() %>% 
  ggplot() +
  geom_sf(aes(fill = rev_fed_mean_reform_diff), size = .25) +
  scale_fill_gradient2(low="#FF0000", midpoint = 0, mid="#FFFFFF", high="#4b2e83", name="2018 Dollars") +
  theme_void() +
  labs(title="Figure. Federal Revenue Difference Post-McCleary Reform",
       subtitle = "Between Spring SY 2016-2018 (3 Year Average) and 2019-2020 (2 Year Average)")+
  theme(plot.title = element_text(hjust = 0.5),
        plot.subtitle = element_text(hjust = 0.5))

wa_mccleary_rev_wide %>%
  sf::st_as_sf() %>% 
  ggplot() +
  geom_sf(aes(fill = rev_st_mean_reform_diff), size = .25) +
  scale_fill_gradient2(low="#FF0000", midpoint = 0, mid="#FFFFFF", high="#4b2e83", name="2018 Dollars") +
  theme_void() +
  labs(title="Figure. State Revenue Difference Post-McCleary Reform",
       subtitle = "Between Spring SY 2016-2018 (3 Year Average) and 2019-2020 (2 Year Average)")+
  theme(plot.title = element_text(hjust = 0.5),
        plot.subtitle = element_text(hjust = 0.5))

wa_mccleary_rev_wide %>%
  sf::st_as_sf() %>% 
  ggplot() +
  geom_sf(aes(fill = rev_loc_mean_reform_diff), size = .25) +
  scale_fill_gradient2(low="#FF0000", midpoint = 0, mid="#FFFFFF", high="#4b2e83", name="2018 Dollars") +
  theme_void() +
  labs(title="Figure. Local Revenue Difference Post-McCleary Reform",
       subtitle = "Between Spring SY 2016-2018 (3 Year Average) and 2019-2020 (2 Year Average)")+
  theme(plot.title = element_text(hjust = 0.5),
        plot.subtitle = element_text(hjust = 0.5))

```

Maps of (1) state revenue per pupil; (2) federal revenue per pupil; and (3) local revenue per pupil; (4) total revenue per-pupil

% change in revenue per pupil over 3 year period (2015-16, 2016-17, 2017-18, 3 year average) to difference of the two year average (2018-19 and 19-2020), divided by average of pre-McCleary as base to get percentage change

# B4: Expenditure categories 

```{r B4_expenditures}

df_e_2020 <- df_e_merge%>%
  filter(schyear == 2020)%>% 
  drop_na(dist_group_soc)%>%
  mutate(dist_group_soc = as.factor(dist_group_soc),
         amount_pp = (amount/TotalEnrollment))

levels(df_e_2020$dist_group_soc) <- c("0-24%","25-49%","50-74%", "75-100%")

df_e_2020_sum = df_e_2020%>%
  group_by(coudis_s, prog_desc, dist_group_soc)%>%
  summarize(amount_pp_total=sum(amount_pp))

df_e_2020_avg = df_e_2020_sum %>%
  group_by(dist_group_soc, prog_desc)%>%
  summarize(amount_pp_avg=mean(amount_pp_total))

df_e_2020_avg%>%
  filter(prog_desc!="NA")%>%
  ggplot(
    aes(reorder(prog_desc, amount_pp_avg, sum), 
        amount_pp_avg)) +
  geom_bar(position="dodge", stat="identity")+
  coord_flip()+
  theme(panel.background = element_blank(), 
        axis.line.x = element_line(color = "#D3D3D3"),
        panel.grid.major.x = element_line(color = "#D3D3D3"),
        plot.title.position = "plot"
        ) +
  labs(title="Figure. Average Per-Student Dollar Amount by All Expenditure Categories, 2019-2020")+
  xlab("") + 
  ylab("")

df_e_2020_avg%>%
  filter(prog_desc!="Basic Education" & prog_desc!="Districtwide Support")%>% #Remove basic education program and Districtwide support
  ggplot(
    aes(reorder(prog_desc, amount_pp_avg, sum), 
        amount_pp_avg)) +
  geom_bar(position="dodge", stat="identity")+
  coord_flip()+
  theme(panel.background = element_blank(), 
        axis.line.x = element_line(color = "#D3D3D3"),
        panel.grid.major.x = element_line(color = "#D3D3D3"),
        plot.title.position = "plot"
        ) +
  labs(title="Figure. Average Per-Student Dollar Amount by Expenditure Category, 2019-2020",
       subtitle = "Excluding Top Two Categories (Basic Education and Districtwide Support) ")+
  xlab("") + 
  ylab("")

#REVIEW: 
#Which expenditure category to focus on (filter by federal, state, others)? 
#Do we want to cut off the categories with minimal amounts? 
#Group the bottom chunk with OTHER category
#look a regionalization factor

df_e_2020_avg%>%
  filter(prog_desc!="NA")%>% 
  ggplot(
    aes(reorder(prog_desc, amount_pp_avg, sum), 
        amount_pp_avg, 
        group=dist_group_soc,
        fill=dist_group_soc)) +
  geom_bar(position="dodge", stat="identity")+
  coord_flip()+
  theme(panel.background = element_blank(), 
        axis.line.x = element_line(color = "#D3D3D3"),
        panel.grid.major.x = element_line(color = "#D3D3D3"),
        plot.title.position = "plot",
        legend.position="none") +
  labs(title = "Figure. Average Per-Student Dollar Amount by Expenditure Category, 2019-2020",
       subtitle = "By District Percentage Student of Color")+
  xlab("") + 
  ylab("") +
  facet_wrap(~dist_group_soc,
             nrow=1)

df_e_2020_avg%>%
  filter(prog_desc!="Basic Education" & prog_desc!="Districtwide Support")%>% #Remove basic education program and Districtwide support
  ggplot(
    aes(reorder(prog_desc, amount_pp_avg, sum), 
        amount_pp_avg, 
        group=dist_group_soc,
        fill=dist_group_soc)) +
  geom_bar(position="dodge", stat="identity")+
  coord_flip()+
  theme(panel.background = element_blank(), 
        axis.line.x = element_line(color = "#D3D3D3"),
        panel.grid.major.x = element_line(color = "#D3D3D3"),
        plot.title.position = "plot",
        legend.position="none") +
  labs(title = "Figure. Average Per-Student Dollar Amount by Expenditure Category, 2019-2020",
       subtitle = "By District Percentage Student of Color and Excluding Top Two Categories ")+
  xlab("") + 
  ylab("") +
  facet_wrap(~dist_group_soc,
             nrow=1)
#REVIEW:
#Same questions as above.
#I separated SOC into quartiles, do we want to categorize them differently? What's both interesting and consumable? 

```

In Section B4, we present information about expenditure category by two students groups: low- and high-poverty and students of color and white students.

We focus on the 2019-2020 school year, the second year of the McCleary reform.



```{r other, include=FALSE}

x <- df_f196_merge_raw%>%
  filter(schyear>=2019)%>%
  select(
    rfactor_cis_2019,
    PctAmericanIndianOrAlaskan,
    PctAsian,
    PctAsianPacificIslander,
    PctBlack,
    PctHispanic,
    PctMultirac,
    PctWhite
    )                   

y <- x%>%
  pivot_longer(!rfactor_cis_2019, names_to = "race", values_to = "pct")%>%
  mutate(rfactor_cis_2019=as.character(rfactor_cis_2019),
         race=as.character(race))

z <- collap(y, pct ~ rfactor_cis_2019 + race, 
                           FUN = list(fmean))

ggplot(z, aes(x = rfactor_cis_2019, y=pct, fill=race, label = format(round(pct, 2), nsmall = 2) )) + 
  geom_bar(stat = "identity")+
  geom_text(size = 3, position = position_stack(vjust = 0.5))




```

