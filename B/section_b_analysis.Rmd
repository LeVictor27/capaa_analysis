---
title: 'Section B: State of Washington School Finance Systems and Structures'
author: "Katherine Chang"
date: "`r format(Sys.Date(), format = '%B %d, %Y')`"
output: 
  html_document:
    toc: true
    toc_float: true
    fig_width: 10
knit: (function(input, encoding) rmarkdown::render(input, output_file = "section_b_analysis.html"))
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE,
                      comment = NA, 
                      cache = TRUE,
                      warning = FALSE,
                      message = FALSE, 
                      cache.lazy = FALSE,
                      fig.align = "center"
                      )

#Session -> Set Working Directory -> To Source File Location
setwd('..')
library(here)
source("theme_uw.R")
```

# Introduction

```{r data_read, include=FALSE}
library(tidyverse)
library(googledrive)
library(haven)
library(ggtext)
library(caret)
library(car)
library(ggeffects)
library(margins) #R version of Stata's margins
#https://cran.r-project.org/web/packages/margins/vignettes/Introduction.html

id_f196_expenditures <- drive_get(as_id("https://drive.google.com/file/d/17AZv1i2plWBko1HYKhZz6NdJimfxnj0c/view?usp=sharing"))
#2015-2020

id_f196_revenues <- drive_get(as_id("https://drive.google.com/file/d/13bZJ6QuJmY-vgBgIZO1Dme5e3qwRgVHx/view?usp=sharing"))

id_f196_rev_dict <- drive_get(as_id("https://drive.google.com/file/d/1NK3PJXYMrcKaZUQuE2bWLqkwK0XjeVnX/view?usp=sharing"))

id_f195_revenues <- drive_get(as_id("https://drive.google.com/file/d/10XytJG-r2zfM3vpbClTJP9Jnz-6nX0Ef/view?usp=sharing"))

id_demos <- drive_get(as_id("https://drive.google.com/file/d/1coJ9kMZUpRmxNyli6xZ31WITaZdyJXIk/view?usp=sharing"))

id_demos_2021 <- drive_get(as_id("https://drive.google.com/file/d/1L8CS0KH1_CvGr7mC61ooOU9JdmG1My86/view?usp=sharing"))

id_cwi <- drive_get(as_id("https://drive.google.com/file/d/1--RKu4geGLO9sOxag7pyJtkw40ZYYkeI/view?usp=sharing"))

df_f196_expenditures <- id_f196_expenditures %>%
  drive_read_raw() %>%
  read_dta()

df_f196_revenues <- id_f196_revenues %>%
  drive_read_raw() %>%
  read_dta()

df_f196_rev_dict <- id_f196_rev_dict %>%
  drive_read_raw() %>%
  read_dta()

df_f195_revenues <- id_f195_revenues %>%
  drive_read_raw() %>%
  read_dta()

df_demos <- id_demos %>%
  drive_read_raw() %>%
  read_dta()

df_demos_2021 <- id_demos_2021 %>%
  drive_read_raw() %>%
  read_csv()

df_cwi <- id_cwi %>%
  drive_read_raw() %>%
  read_csv()

```


```{r data_cleaning, include=FALSE}

library(collapse)
library(purrr)

df_demos_dist <- df_demos_2021%>%
  filter(OrganizationLevel=="District")%>%
  filter(Gradelevel=="AllGrades")%>%
  drop_na(ESDOrganizationID)%>%
  filter(!str_detect(ESDName, "Charter School"))%>%
  filter(!str_detect(DistrictName, "Charter"))%>%
  select(-OrganizationLevel, -County, ESDName, ESDOrganizationID,
         -DistrictOrganizationId, -SchoolCode, -SchoolName,
         -SchoolOrganizationid, -CurrentSchoolType, -Gradelevel,
         -DataAsOf)%>%
  mutate(coudis_s = str_pad(as.character(DistrictCode), 5, side="left", pad="0"),
         schyear = paste("20", gsub("[0-9]+-", "", SchoolYear), sep=""))%>%
  rename("TotalEnrollment" = "All Students",
         "NumberFemales" = "Female",
         "NumberMales" = "Male",
         "NumberGenderX" = "Gender X",
         "NumberAmericanIndianOrAlaskan" = "American Indian/ Alaskan Native",
         "NumberAsian" = "Asian",
         "NumberBlack" = "Black/ African American",
         "NumberHispanic" = "Hispanic/ Latino of any race(s)",
         "NumberAsianPacificIslander" = "Native Hawaiian/ Other Pacific Islander",
         "NumberMultirac" = "Two or More Races",
         "NumberWhite" = "White",
         "NumberFreeorReducedPricedMeals" = "Low-Income",
         "NumberSpecialEducation" = "Students with Disabilities",
         "NumberTransitionalBilingual" = "English Language Learners")

df_demos_dist <- df_demos_dist%>%
  select(coudis_s,
         schyear,
         "TotalEnrollment",
         "NumberAmericanIndianOrAlaskan",
         "NumberAsian",
         "NumberBlack",
         "NumberHispanic",
         "NumberAsianPacificIslander",
         "NumberMultirac",
         "NumberWhite",
         "NumberFreeorReducedPricedMeals",
         "NumberSpecialEducation",
         "NumberTransitionalBilingual")

df_demos_dist <- df_demos_dist%>%
  mutate(PctAmericanIndianOrAlaskan = NumberAmericanIndianOrAlaskan/TotalEnrollment,
         PctAsian = NumberAsian/TotalEnrollment,
         PctBlack = NumberBlack/TotalEnrollment,
         PctHispanic = NumberHispanic/TotalEnrollment,
         PctAsianPacificIslander = NumberAsianPacificIslander/TotalEnrollment,
         PctMultirac = NumberMultirac/TotalEnrollment,
         PctWhite = NumberWhite/TotalEnrollment,
         PctFreeorReducedPricedMeals = NumberFreeorReducedPricedMeals/TotalEnrollment,
         PctSpecialEducation = NumberSpecialEducation/TotalEnrollment,
         PctTransitionalBilingual = NumberTransitionalBilingual/TotalEnrollment
         )%>%
  mutate_at(vars(PctAmericanIndianOrAlaskan:PctTransitionalBilingual), ~replace_na(., 0))

df_demos_dist$dist_nstu_soc = rowSums((df_demos_dist[,c("NumberAsian", "NumberBlack", "NumberHispanic", "NumberAmericanIndianOrAlaskan", "NumberAsianPacificIslander", "NumberMultirac")]), na.rm = TRUE)

df_demos_dist <- df_demos_dist%>%
  mutate(dist_pctstu_soc = as.numeric(dist_nstu_soc/TotalEnrollment),
         dist_group_soc = case_when(dist_pctstu_soc >= 0  & dist_pctstu_soc < 0.25 ~ '1',
                                    dist_pctstu_soc >= 0.25  & dist_pctstu_soc < 0.50 ~ '2',
                                    dist_pctstu_soc >= 0.50  & dist_pctstu_soc < 0.75 ~ '3',
                                    dist_pctstu_soc >= 0.75  & dist_pctstu_soc <= 1 ~ '4')
  )

df_demos_dist$deciles_frpl <- ntile(df_demos_dist$PctFreeorReducedPricedMeals, 10)

df_f196_expenditures <- df_f196_expenditures%>%
  mutate(coudis_s=as.character(coudis_s),
         schyear=as.character(schyear))

df_e_merge_raw <- full_join(df_f196_expenditures, df_demos_dist, by=c("coudis_s"="coudis_s", "schyear"="schyear"))

df_f196_revenues <- df_f196_revenues%>%
  mutate(rev_type_s = haven::as_factor(df_f196_revenues$rev_type, levels="label"))%>%
  mutate(fund_s = haven::as_factor(df_f196_revenues$fund, levels="label"))

df_cwi <- df_cwi%>%
  mutate(coudis_s = str_pad(as.character(dist_id), 5, side="left", pad="0"))



```


# B1: Revenue source for high- and low-poverty districts

```{r B1_revenue_data, include=FALSE}

#Pull revenue categories: Federal, State, Local, and Other
df_rev_merge_source <- df_f196_revenues%>%
  mutate(rev_source = case_when(str_detect(rev_type_s, 'Federal') ~ "Federal",
                                str_detect(rev_type_s, 'State') ~ "State",
                                str_detect(rev_type_s, 'Local') ~ "Local",
                                TRUE ~ 'Other'))

df_rev_collapse <- collap(df_rev_merge_source, rev~ coudis + schyear + rev_source, 
                           FUN = list(fsum))

df_rev_collapse <- df_rev_collapse%>%
  rename(revenue_amount=rev)

#Bring in NCES Geographic designation.
#https://nces.ed.gov/programs/edge/Geographic/SchoolLocations

id_nces_geo <-drive_get(as_id("https://drive.google.com/file/d/1YXv-RxZMVEO3YiIF-RS4IFTClFgUOHgh/view?usp=sharing"))

df_nces_geo <- id_nces_geo %>%
  drive_read_raw() %>%
  read_csv()

df_locale_wa <- df_nces_geo%>%
  filter(STATE=="WA")%>%
  select(LEAID, NAME, LOCALE)%>%
  mutate(LOCALE=as.character(LOCALE),
         LEAID=as.numeric(LEAID))

#Add CPI (Generated by Chris)
df_cpi18 <- df_f196_revenues%>%
  select(schyear, cpi18)%>%
  mutate(schyear=as.character(schyear))%>%
  distinct()

df_leaid <- df_cwi%>%
  select(-cwi, -cwi_se, -cwi_2020_extrapolated, -year)%>%
  distinct()

df_rev_leaid<- full_join(df_rev_collapse, df_leaid, by=c("coudis"="coudis_s"))

df_rev_leaid <- df_rev_leaid%>%
  mutate(schyear=as.character(schyear))

df_rev_leaid_cpi<- full_join(df_rev_leaid, df_cpi18, by=c("schyear"="schyear"))

df_rev_merge<- full_join(df_rev_leaid_cpi, df_demos_dist, by=c("coudis"="coudis_s", "schyear"="schyear"))

df_rev_merge<- full_join(df_rev_merge, df_locale_wa, by=c("leaid"="LEAID"))

#Adjust dollars by CWI
df_rev_merge <- df_rev_merge%>%
  mutate(
    rev_pp = revenue_amount/TotalEnrollment,
    #rev_pp_cwi=rev_pp/cwi_2020_extrapolated,
    rev_pp_18d=rev_pp*cpi18, 
    #rev_pp_cwi_18d=rev_pp_cwi*cpi18, 
    LOCALE = as.factor(LOCALE),
    dist_group_soc = as.factor(dist_group_soc),
    TotalEnrollment_log = log(TotalEnrollment))%>%
    drop_na(dist_group_soc)

levels(df_rev_merge$dist_group_soc) <- c("0-24%","25-49%","50-74%", "75-100%")

#Inlcude the main effect and the year fixed effect in the model

##FEDERAL (CWI_18D)
df_rev_fed <- df_rev_merge%>%
  filter(rev_source=="Federal")

model_fed <- lm(rev_pp_18d ~ log(TotalEnrollment) + LOCALE + PctSpecialEducation + PctTransitionalBilingual  + PctFreeorReducedPricedMeals + schyear, data=df_rev_fed) 
#Brief model has main effect of school year and indicator of perctile FRL (.1, 0.9) and add interaction term between the 0.1 and 0.9
#Coefficient is the difference between the 90th from state average and the 10th from the state average

df_rev_fed$rev_adjusted <- predict.lm(model_fed, newdata=df_rev_fed)

#Have poverty as part of predictor and have marginal estimate as part of the predictor
#Have poverty as a continuous variable and estimate marginal effect at .1 and .9 percentile (30/70% poverty)

#STATE
df_rev_state <- df_rev_merge%>%
  filter(rev_source=="State")

model_state <- lm(rev_pp_18d ~ log(TotalEnrollment) + LOCALE + PctSpecialEducation + PctTransitionalBilingual + PctFreeorReducedPricedMeals + schyear, data=df_rev_state)

df_rev_state$rev_adjusted <- predict.lm(model_state, newdata=df_rev_state)

#LOCAL
df_rev_loc <- df_rev_merge%>%
  filter(rev_source=="Local")

model_loc <- lm(rev_pp_18d ~ log(TotalEnrollment) + LOCALE + PctSpecialEducation + PctTransitionalBilingual + PctFreeorReducedPricedMeals + schyear, data=df_rev_loc)

df_rev_loc$rev_adjusted <- predict.lm(model_loc, newdata=df_rev_loc)

df_rev_total <- data.frame(
  df_rev_fed$schyear,
  df_rev_fed$leaid,
  df_rev_fed$coudis,
  df_rev_fed$rev_adjusted,
  df_rev_state$rev_adjusted,
  df_rev_loc$rev_adjusted)

df_rev_total <- df_rev_total%>%
  mutate(rev_adjusted = df_rev_fed.rev_adjusted + df_rev_state.rev_adjusted + df_rev_loc.rev_adjusted)%>%
  select(-c(df_rev_fed.rev_adjusted, df_rev_state.rev_adjusted, df_rev_loc.rev_adjusted))%>%
  rename(coudis=df_rev_fed.coudis,
         schyear=df_rev_fed.schyear,
         leaid=df_rev_fed.leaid)
  #rename_with(~paste0(sub("^([^.]+\\.)", "", .)), -1)

df_rev_total <- full_join(df_rev_total, df_demos_dist, by=c("coudis"="coudis_s", "schyear"="schyear"))

```

Federal, state, and local revenue source for high- and low-poverty districts

## Revenue Source by Time

```{r B1_revenue_time_pov}

#FED FRPL

df_rev_fed_figure_pov_frpl <- df_rev_fed%>%
  filter(deciles_frpl==1 | deciles_frpl == 9)%>%
  mutate(deciles_frpl = as.factor(deciles_frpl))

levels(df_rev_fed_figure_pov_frpl$deciles_frpl) <- c("Low-Poverty", "High-Poverty")

ggplot(df_rev_fed_figure_pov_frpl, 
       aes(x=schyear, y=rev_adjusted, group=deciles_frpl)) + 
  stat_summary(geom="line", fun="mean", alpha=0.5) +
  stat_summary(geom="ribbon", 
               fun.data = mean_se, #mean_cl_normal
               aes(fill=deciles_frpl), alpha=0.25) +
  labs(title="Federal Revenue Amount Per Student",
       subtitle = "Regression adjusted for difference of cost factors including district size, 
       urbanicity/locale, and percent of students enrolled in free and reduced lunch, 
       special education and classified as limited English proficient",
       caption="Note: High and low-poverty districts estimated at the 10th and 90th percentile 
       of district percentage of students qualifying for free and reduced price lunch, 
       with an equal number of districts in each quantile\n\n Data Source: F-196")+
  xlab("School Year (Spring)") + 
  ylab("2018 Dollars") + 
  geom_vline(xintercept = "2018", colour='#FFFFFF', linetype="dashed")+
  theme_uw() +
  scale_fill_manual(values=c("#4b2e83", "#85754d"), 
                    name="fill")

#STATE FRPL

df_rev_state_figure_pov_frpl <- df_rev_state%>%
  filter(deciles_frpl==1 | deciles_frpl == 9)%>%
  mutate(deciles_frpl = as.factor(deciles_frpl))

levels(df_rev_state_figure_pov_frpl$deciles_frpl) <- c("Low-Poverty", "High-Poverty")

ggplot(df_rev_state_figure_pov_frpl, 
       aes(x=schyear, y=rev_adjusted, group=deciles_frpl)) + 
  stat_summary(geom="line", fun="mean", alpha=0.5) +
  stat_summary(geom="ribbon", 
               fun.data = mean_se, #mean_cl_normal
               aes(fill=deciles_frpl), alpha=0.25) +
  labs(title="State Revenue Amount Per Student",
       subtitle = "Regression adjusted for difference of cost factors including district size, 
       urbanicity/locale, and percent of students enrolled in free and reduced lunch, 
       special education and classified as limited English proficient",
       caption="Note: High and low-poverty districts estimated at the 10th and 90th percentile 
       of district percentage of students qualifying for free and reduced price lunch, 
       with an equal number of districts in each quantile\n\n Data Source: F-196")+
  xlab("School Year (Spring)") + 
  ylab("2018 Dollars") + 
  geom_vline(xintercept = "2018", colour='#FFFFFF', linetype="dashed")+
  theme_uw() +
  scale_fill_manual(values=c("#4b2e83", "#85754d"), 
                    name="fill")

#LOCAL FRPL

df_rev_loc_figure_pov <- df_rev_loc%>%
  filter(deciles_frpl==1 | deciles_frpl == 9)%>%
  mutate(deciles_frpl = as.factor(deciles_frpl))

levels(df_rev_loc_figure_pov$deciles_frpl) <- c("Low-Poverty", "High-Poverty")

ggplot(df_rev_loc_figure_pov, 
       aes(x=schyear, y=rev_adjusted, group=deciles_frpl)) + 
  stat_summary(geom="line", fun="mean", alpha=0.5) +
  stat_summary(geom="ribbon", 
               fun.data = mean_se, #mean_cl_normal
               aes(fill=deciles_frpl), alpha=0.25) +
  labs(title="Local Revenue Amount Per Student",
       subtitle = "Regression adjusted for difference of cost factors including district size, 
       urbanicity/locale, and percent of students enrolled in free and reduced lunch, 
       special education and classified as limited English proficient",
       caption="Note: High and low-poverty districts estimated at the 10th and 90th percentile 
       of district percentage of students qualifying for free and reduced price lunch, 
       with an equal number of districts in each quantile\n\n Data Source: F-196")+
  xlab("School Year (Spring)") + 
  ylab("2018 Dollars") + 
  geom_vline(xintercept = "2018", colour='#FFFFFF', linetype="dashed")+
  theme_uw() +
  scale_fill_manual(values=c("#4b2e83", "#85754d"), 
                    name="fill")

#TOTAL FRPL

df_rev_total_figure_pov <- df_rev_total%>%
  filter(deciles_frpl==1 | deciles_frpl == 9)%>%
  mutate(deciles_frpl = as.factor(deciles_frpl))

levels(df_rev_total_figure_pov$deciles_frpl) <- c("Low-Poverty", "High-Poverty")

ggplot(df_rev_total_figure_pov, 
       aes(x=schyear, y=rev_adjusted, group=deciles_frpl)) + 
  stat_summary(geom="line", fun="mean", alpha=0.5) +
  stat_summary(geom="ribbon", 
               fun.data = mean_se, #mean_cl_normal
               aes(fill=deciles_frpl), alpha=0.25) +
  labs(title="Total Revenue Amount Per Student",
       subtitle = "Regression adjusted for difference of cost factors including district size, 
       urbanicity/locale, and percent of students enrolled in 
       special education and classified as limited English proficient",
       caption="Note: High and low-poverty districts estimated at the 10th and 90th percentile 
       of district percentage of students qualifying for free and reduced price lunch, 
       with an equal number of districts in each quantile\n\n Data Source: F-196")+
  xlab("School Year (Spring)") + 
  ylab("2018 Dollars") + 
  geom_vline(xintercept = "2018", colour='#FFFFFF', linetype="dashed")+
  theme_uw() +
  scale_fill_manual(values=c("#4b2e83", "#85754d"), 
                    name="fill")

```

## Revenue Breakdown by Category

```{r B1_revenue_breakdown_pov}

#ACCOUNTING GUIDEBOOKS FROM THE STATE
#AVERAGE STUDENT, WEIGHT BY STUDENTS WITHIN
#FOR THE AVERAGE STUDENT WITHIN THE BIN 
#INCLUDE 3 YEAR AVERAGE VS 3 DIFFERNT GRAPHS, LOOK TO THIS CONTEXT
#SO CAN MAKE A COMPARISON TO SEE WHAT THE IMPACT OF A SINGLE YEAR IS
#UNWEIGHTED AVERAGES WITHIN THE DISTRICT AND THEN WEIGHTED AVERAGES ACROSS THE DISTRICTS

df_f195_cat <- df_f195%>%
  mutate(rev_category = case_when(
    str_detect(item_desc, regex("\\bTOTAL FEDERAL, GENERAL PURPOSE\\b", ignore_case=FALSE)) ~ "Federal",                          
    str_detect(item_desc, regex("\\bTOTAL FEDERAL, SPECIAL PURPOSE\\b", ignore_case=FALSE)) ~ "Federal",
    str_detect(item_desc, regex("\\bTOTAL STATE, GENERAL PURPOSE\\b", ignore_case=FALSE)) ~ "State",                                
    str_detect(item_desc, regex("\\bTOTAL STATE, SPECIAL PURPOSE\\b", ignore_case=FALSE)) ~ "State",
    str_detect(item_desc, regex("\\bTOTAL LOCAL SUPPORT NONTAX\\b", ignore_case=FALSE)) ~ "Local",                                    
    str_detect(item_desc, regex("\\bTOTAL LOCAL TAXES\\b", ignore_case=FALSE)) ~ "Local",                                             
    str_detect(item_desc, regex("\\bTOTAL OTHER FINANCING SOURCES\\b", ignore_case=FALSE)) ~ "Other",                           
    str_detect(item_desc, regex("\\bTOTAL REVENUES FROM OTHER ENTITIES\\b", ignore_case=FALSE)) ~ "Other",                            
    str_detect(item_desc, regex("\\bTOTAL REVENUES FROM OTHER SCHOOL DISTRICTS\\b", ignore_case=FALSE)) ~ "Other",   
    TRUE ~ NA_character_
    )
  )

df_f195_cat <- df_f195_cat%>%
  fill(rev_category, .direction = "down")%>%
  filter(amount>0)

df_f195_all_cwi<- full_join(df_f195_cat, df_cwi_cpi, by=c("CCDDD"="coudis_s", "year"="schyear"))
df_f195_all_merge_raw <- full_join(df_f195_all_cwi, df_demos_dist, by=c("CCDDD"="coudis_s", "year"="schyear"))

df_f195_all_merge <- df_f195_all_merge_raw%>%
  filter(!str_detect(item_desc, "\\bTOTAL FEDERAL, GENERAL PURPOSE\\b"),
         !str_detect(item_desc, "\\bTOTAL FEDERAL, SPECIAL PURPOSE\\b"),
         !str_detect(item_desc, "\\bTOTAL LOCAL SUPPORT NONTAX\\b"),
         !str_detect(item_desc, "\\bTOTAL LOCAL TAXES\\b"),
         !str_detect(item_desc, "\\bTOTAL STATE, GENERAL PURPOSE\\b"),
         !str_detect(item_desc, "\\bTOTAL STATE, SPECIAL PURPOSE\\b"),
         !str_detect(item_desc, "\\TOTAL OTHER FINANCING SOURCES\\b"),
         !str_detect(item_desc, "\\TOTAL REVENUES FROM OTHER ENTITIES\\b"),
         !str_detect(item_desc, "\\TOTAL REVENUES FROM OTHER SCHOOL DISTRICTS\\b"))

#### POV

df_f195_all_merge_pov <- df_f195_all_merge%>%
  drop_na(deciles_frpl)%>%
  filter(year == 2019 | year == 2018)%>%
  filter(deciles_frpl==1 | deciles_frpl == 9)%>%
  mutate(deciles_frpl = as.factor(deciles_frpl),
         amount_pp = (amount/TotalEnrollment))

levels(df_f195_all_merge_pov$deciles_frpl) <- c("Low-Poverty", "High-Poverty")

df_f195_all_merge_pov_sum <- df_f195_all_merge_pov%>%
  group_by(CCDDD, item_desc, deciles_frpl, rev_category)%>%
  summarize(amount_pp_total=sum(amount_pp))

df_f195_all_merge_pov_avg <- df_f195_all_merge_pov_sum %>%
  group_by(deciles_frpl, item_desc)%>%
  summarize(amount_pp_avg=mean(amount_pp_total),
            rev_category=rev_category)

df_f195_all_merge_pov_avg%>%
  filter(item_desc!="NA",
         amount_pp_avg > 100)%>%
    ggplot(aes(reorder(item_desc, amount_pp_avg), 
        y=amount_pp_avg, fill=rev_category, group=deciles_frpl)) +
  geom_bar(position = position_dodge(width=0.5), stat="identity")+
  coord_flip()+
  labs(title="Two Year Average Per-Student Dollar Amount\n by All Revenue Categories, 2018/2019",
       caption="Note: High and low-poverty districts estimated at the 10th and 90th percentile 
       of district percentage of students qualifying for free and reduced price lunch, 
       with an equal number of districts in each quantile")+
  scale_fill_manual(values = palette_uw(4), limits=c("Federal","State","Local","Other")) + 
  xlab("") + 
  ylab("") + 
  facet_wrap(~deciles_frpl,
             nrow=1)+
  theme_uw() 

```

# B2: Revenue source for districts serving students of color

## Revenue Source by Time
```{r B2_revenue_time_soc}

ggplot(df_rev_fed, 
       aes(x=schyear, y=rev_adjusted, group=dist_group_soc)) + 
  stat_summary(geom="line", fun="mean", alpha=0.5) +
  stat_summary(geom="ribbon", 
               fun.data = mean_se, #mean_cl_normal
               aes(fill=dist_group_soc), alpha=0.25) +
  labs(title="Federal Revenue Amount Per Student",
       subtitle = "Regression adjusted for difference of cost factors including district size, 
       urbanicity/locale, average cost of labor, and percent of students enrolled in 
       free and reduced lunch, special education and classified as limited English proficient",
       caption="Data Source: F-196")+
  xlab("School Year (Spring)") + 
  ylab("2018 Dollars") + 
  geom_vline(xintercept = "2018", colour='#FFFFFF', linetype="dashed")+
  theme_uw() +
  scale_fill_manual(values=c("#85754d", "#a6611a", "#c2a5cf","#7b3294"), 
                    name="fill")

####

ggplot(df_rev_state, 
       aes(x=schyear, y=rev_adjusted, group=dist_group_soc)) + 
  stat_summary(geom="line", fun="mean", alpha=0.5) +
  stat_summary(geom="ribbon", 
               fun.data = mean_se, #mean_cl_normal
               aes(fill=dist_group_soc), alpha=0.25) +
  labs(title="State Revenue Amount Per Student",
       subtitle = "Regression adjusted for difference of cost factors including district size, 
       urbanicity/locale, average cost of labor, and percent of students enrolled in 
       free and reduced lunch, special education and classified as limited English proficient",
       caption="Data Source: F-196")+
  xlab("School Year (Spring)") + 
  ylab("2018 Dollars") + 
  geom_vline(xintercept = "2018", colour='#FFFFFF', linetype="dashed")+
  theme_uw() +
  scale_fill_manual(values=c("#85754d", "#a6611a", "#c2a5cf","#7b3294"), 
                    name="fill")


####

ggplot(df_rev_loc, 
       aes(x=schyear, y=rev_adjusted, group=dist_group_soc)) + 
  stat_summary(geom="line", fun="mean", alpha=0.5) +
  stat_summary(geom="ribbon", 
               fun.data = mean_se, #mean_cl_normal
               aes(fill=dist_group_soc), alpha=0.25) +
  labs(title="Local Revenue Amount Per Student",
       subtitle = "Regression adjusted for difference of cost factors including district size, 
       urbanicity/locale, average cost of labor, and percent of students enrolled in 
       free and reduced lunch, special education and classified as limited English proficient",
       caption="Data Source: F-196")+
  xlab("School Year (Spring)") + 
  ylab("2018 Dollars") + 
  geom_vline(xintercept = "2018", colour='#FFFFFF', linetype="dashed")+
  theme_uw() +
  scale_fill_manual(values=c("#85754d", "#a6611a", "#c2a5cf","#7b3294"), 
                    name="fill")

####

ggplot(df_rev_total, 
       aes(x=schyear, y=rev_adjusted, group=dist_group_soc)) + 
  stat_summary(geom="line", fun="mean", alpha=0.5) +
  stat_summary(geom="ribbon", 
               fun.data = mean_se, #mean_cl_normal
               aes(fill=dist_group_soc), alpha=0.25) +
  labs(title="Total Revenue Amount Per Student",
       subtitle = "Regression adjusted for difference of cost factors including district size, 
       urbanicity/locale, average cost of labor, and percent of students enrolled in 
       free and reduced lunch, special education and classified as limited English proficient",
       caption="Data Source: F-196")+
  xlab("School Year (Spring)") + 
  ylab("2018 Dollars") + 
  geom_vline(xintercept = "2018", colour='#FFFFFF', linetype="dashed")+
  theme_uw() +
  scale_fill_manual(values=c("#85754d", "#a6611a", "#c2a5cf","#7b3294"), 
                    name="fill")

```

## Revenue Breakdown by Category

```{r B2_revenue_breakdown_soc}

df_f195_all_merge <- df_f195_all_merge%>%
  filter(year == 2019 | year==2018)%>% 
  drop_na(dist_group_soc)%>%
  mutate(dist_group_soc = as.factor(dist_group_soc),
         amount_pp = (amount/TotalEnrollment))

levels(df_f195_all_merge$dist_group_soc) <- c("0-24%","25-49%","50-74%", "75-100%")

df_f195_all_merge_sum <- df_f195_all_merge%>%
  group_by(CCDDD, item_desc, dist_group_soc, rev_category)%>%
  summarize(amount_pp_total=sum(amount_pp))

df_f195_all_merge_avg <- df_f195_all_merge_sum %>%
  group_by(dist_group_soc, item_desc)%>%
  summarize(amount_pp_avg=mean(amount_pp_total),
            rev_category=rev_category)

df_f195_all_merge_avg%>%
  filter(item_desc!="NA",
         amount_pp_avg > 100)%>%
  ggplot(aes(reorder(item_desc, amount_pp_avg), 
        y=amount_pp_avg, fill=rev_category)) +
  geom_bar(position = position_dodge(width=0.5), stat="identity")+
  coord_flip()+
  labs(title="Two Year Average Per-Student Dollar Amount\n by All Revenue Categories, 2018/2019 ")+
  scale_fill_manual(values = palette_uw(4), limits=c("Federal","State","Local","Other")) + 
  xlab("") + 
  ylab("") +
  theme_uw()

df_f195_all_merge_avg%>%
  filter(item_desc!="NA",
         amount_pp_avg > 100)%>%
    ggplot(aes(reorder(item_desc, amount_pp_avg), 
        y=amount_pp_avg, fill=rev_category, group=dist_group_soc)) +
  geom_bar(position = position_dodge(width=0.5), stat="identity")+
  coord_flip()+
  labs(title="Two Year Average Per-Student Dollar Amount\n by All Revenue Categories, 2018/2019",
       subtitle="By District Ratio Student of Color")+
  scale_fill_manual(values = palette_uw(4), limits=c("Federal","State","Local","Other")) + 
  xlab("") + 
  ylab("") + 
  facet_wrap(~dist_group_soc,
             nrow=1) +
  theme_uw()
```
        

# B3: Spatial distribution of school funding

```{r B3_maps_data}

library(leaidr)
library(sf)

wa <- lea_get("wa")%>% 
  sf::st_as_sf() 

df_rev_map <- df_rev_merge%>%
  filter(rev_source!="Other")%>%
  filter(schyear!="2021")%>%
  filter(schyear!="2015")%>%
  select(coudis, schyear, rev_source, rev_pp_18d)

df_rev_map <- df_rev_map%>%
  group_by(coudis, schyear, rev_source)%>%
  summarise(rev_pp_18d_sum = sum(rev_pp_18d))

df_rev_map_wide <- df_rev_map %>%
  pivot_wider(names_from = rev_source, values_from = rev_pp_18d_sum)

df_rev_map_merge <- df_rev_map_wide%>%
  rename(rev_fed_pp_18d = Federal,
         rev_st_pp_18d = State,
         rev_loc_pp_18d = Local)%>%
  mutate(rev_total_pp_18d = rev_fed_pp_18d + rev_st_pp_18d + rev_loc_pp_18d)%>%
  mutate(schyear_n = as.numeric(schyear),
         post_mcl_reform = ifelse(schyear>= 2018, "1", "0"))

df_rev_map_merge <- df_rev_map_merge%>%
  group_by(schyear)%>%
  mutate(
    rev_fed_mean = mean(rev_fed_pp_18d, na.rm = TRUE),
    rev_st_mean = mean(rev_st_pp_18d, na.rm = TRUE), 
    rev_loc_mean = mean(rev_loc_pp_18d, na.rm = TRUE),
    rev_total_mean = mean(rev_total_pp_18d, na.rm = TRUE))

df_rev_map_merge <- df_rev_map_merge%>%
  group_by(coudis, post_mcl_reform)%>%
  mutate(rev_fed_mean_reform = mean(rev_fed_pp_18d, na.rm = TRUE), 
         rev_st_mean_reform = mean(rev_st_pp_18d, na.rm = TRUE), 
         rev_loc_mean_reform = mean(rev_loc_pp_18d, na.rm = TRUE),
         rev_total_mean_reform = mean(rev_total_pp_18d, na.rm = TRUE))

df_rev_map_merge <- df_rev_map_merge%>%
  mutate(
    rev_fed_diff= (rev_fed_pp_18d-rev_fed_mean),
    rev_st_diff= (rev_st_pp_18d-rev_st_mean),
    rev_loc_diff=(rev_loc_pp_18d-rev_loc_mean),
    rev_total_diff=(rev_total_pp_18d-rev_total_mean))

df_rev_map_merge <- full_join(df_rev_map_merge, df_leaid, by=c("coudis"="coudis_s"))

df_rev_map_merge <- df_rev_map_merge%>%
  mutate(leaid=as.character(leaid))

mccleary_revenue <- collap(df_rev_map_merge, rev_fed_mean_reform + rev_st_mean_reform + rev_loc_mean_reform + rev_total_mean_reform~ leaid + post_mcl_reform, FUN = list(fmean))

mccleary_rev_wide <- mccleary_revenue%>%
  group_by(leaid)%>% 
  pivot_wider(names_from = post_mcl_reform, 
              values_from = c(rev_fed_mean_reform, rev_st_mean_reform, rev_loc_mean_reform, rev_total_mean_reform))

mccleary_rev_wide <- mccleary_rev_wide%>%
  mutate(
    rev_fed_mean_reform_diff = (rev_fed_mean_reform_1 - rev_fed_mean_reform_0),
    rev_st_mean_reform_diff = (rev_st_mean_reform_1 - rev_st_mean_reform_0),
    rev_loc_mean_reform_diff = (rev_loc_mean_reform_1 - rev_loc_mean_reform_0),
    rev_total_mean_reform_diff = (rev_total_mean_reform_1 - rev_total_mean_reform_0))

wa_rev_map_merge <- left_join(df_rev_map_merge, wa, by = c("leaid" = "GEOID"), copy=TRUE) 

wa_mccleary_rev_wide <- left_join(mccleary_rev_wide, wa, by = c("leaid" = "GEOID"), copy=TRUE) 

#What percentage higher than lower than state average for the state/local revenue
#Distribution of dollars -> district that serve large % of SOC/low-income

```

## Demographic Maps
```{r B3_maps_demo}

#Demographic Maps

wa_df196 %>%
  sf::st_as_sf() %>% 
  filter(schyear==2019)%>%
  ggplot() +
  geom_sf(aes(fill = PctHispanic), size = .25) +
  scale_fill_gradient2(low="#FFFFFF", high="#4b2e83", name="Percentage") +
  labs(title="Latinx Students Percentage of Total Student Enrollment, 2018-2019 ")+
  theme_uw_map()

wa_df196 %>%
  sf::st_as_sf() %>% 
  filter(schyear==2019)%>%
  ggplot() +
  geom_sf(aes(fill = PctBlack), size = .25) +
  scale_fill_gradient2(low="#FFFFFF", high="#4b2e83", name="Percentage") +
  labs(title="Black Students Percentage of Total Student Enrollment, 2018-2019 ")+
  theme_uw_map()

wa_df196 %>%
  sf::st_as_sf() %>% 
  filter(schyear==2019)%>%
  ggplot() +
  geom_sf(aes(fill = PctAmericanIndianOrAlaskan), size = .25) +
  scale_fill_gradient2(low="#FFFFFF", high="#4b2e83", name="Percentage") +
  labs(title="Indigenous Students Percentage of Total Student Enrollment, 2018-2019 ")+
  theme_uw_map()

wa_df196 %>%
  sf::st_as_sf() %>% 
  filter(schyear==2019)%>%
  ggplot() +
  geom_sf(aes(fill = PctAsian), size = .25) +
  scale_fill_gradient2(low="#FFFFFF", high="#4b2e83", name="Percentage") +
  labs(title="Asian Students Percentage of Total Student Enrollment, 2018-2019 ")+
  theme_uw_map()

wa_df196 %>%
  sf::st_as_sf() %>% 
  filter(schyear==2019)%>%
  ggplot() +
  geom_sf(aes(fill = PctMultirac), size = .25) +
  scale_fill_gradient2(low="#FFFFFF", high="#4b2e83", name="Percentage") +
  labs(title="Multiracial Students Percentage \nof Total Student Enrollment, 2018-2019")+
  theme_uw_map()

```

## Revenue Maps
```{r B3_maps_rev}

### ADD REGIONALIZATION FACTOR AND CWI NEXT TO EACH OTHER
### ADD COMMUTING ZONES ON THE MAP
### OLD CWI (LABOR MARKET VARIABLE), perfectly links to school districts, boundaries of districts and labor markets

#DRAW SAME GRAPH USING TERCILES 

wa_df196$rfactor_cis_2019 <- as.factor(wa_df196$rfactor_cis_2019)

wa_df196 %>%
  sf::st_as_sf() %>% 
  filter(schyear==2019)%>%
  ggplot() +
  geom_sf(aes(fill = rfactor_cis_2019), size = .25) +
  labs(title="Regionalization Factor, 2019")+
  theme_uw_map()

#Need to figure out what colors work best with this map to make it pop

wa_rev_map_merge %>%
  sf::st_as_sf() %>% 
  filter(schyear==2019)%>%
  ggplot() +
  geom_sf(aes(fill = rev_fed_pp_18d), size = .25) +
  scale_fill_gradient2(low="#FFFFFF", high="#4b2e83", name="2018 Dollars") +
  labs(title="Federal Revenue Per Pupil, 2018-2019")+
  theme_uw_map()

wa_rev_map_merge %>%
  sf::st_as_sf() %>% 
  filter(schyear==2019)%>%
  ggplot() +
  geom_sf(aes(fill = rev_st_pp_18d), size = .25) +
  scale_fill_gradient2(low="#FFFFFF", high="#4b2e83", name="2018 Dollars") +
  labs(title="State Revenue Per Pupil, 2018-2019")+
  theme_uw_map()

wa_rev_map_merge %>%
  sf::st_as_sf() %>% 
  filter(schyear==2019)%>%
  ggplot() +
  geom_sf(aes(fill = rev_loc_pp_18d), size = .25) +
  scale_fill_gradient2(low="#FFFFFF", high="#4b2e83", name="2018 Dollars") +
  labs(title="Local  Revenue Per Pupil, 2018-2019")+
  theme_uw_map()

wa_rev_map_merge %>%
  sf::st_as_sf() %>% 
  filter(schyear==2019)%>%
  ggplot() +
  geom_sf(aes(fill = rev_total_pp_18d), size = .25) +
  scale_fill_gradient2(low="#FFFFFF", high="#4b2e83", name="2018 Dollars") +
  labs(title="Total Revenue Per Pupil, 2018-2019")+
  theme_uw_map()

wa_rev_map_merge %>%
  sf::st_as_sf() %>% 
  filter(schyear==2019)%>%
  ggplot() +
  geom_sf(aes(fill = rev_fed_diff), size = .25) +
  scale_fill_gradient2(low="#FF0000", midpoint = 0, mid="#FFFFFF", high="#4b2e83", name="2018 Dollars") +
  labs(title="Federal Revenue Per Pupil, 2018-2019",
       subtitle = "Dollar Difference Against State Mean for the School Year")+
  theme_uw_map()

wa_rev_map_merge %>%
  sf::st_as_sf() %>% 
  filter(schyear==2019)%>%
  ggplot() +
  geom_sf(aes(fill = rev_st_diff), size = .25) +
  scale_fill_gradient2(low="#FF0000", midpoint = 0, mid="#FFFFFF", high="#4b2e83", name="2018 Dollars") +
  labs(title="State Revenue Per Pupil, 2018-2019",
       subtitle = "Dollar Difference Against State Mean for the School Year")+
  theme_uw_map()

wa_rev_map_merge %>%
  sf::st_as_sf() %>% 
  filter(schyear==2019)%>%
  ggplot() +
  geom_sf(aes(fill = rev_loc_diff), size = .25) +
  scale_fill_gradient2(low="#FF0000", midpoint = 0, mid="#FFFFFF", high="#4b2e83", name="2018 Dollars") +
  labs(title="Local Revenue Per Pupil, 2018-2019",
       subtitle = "Dollar Difference Against State Mean for the School Year")+
  theme_uw_map()

wa_rev_map_merge %>%
  sf::st_as_sf() %>% 
  filter(schyear==2019)%>%
  ggplot() +
  geom_sf(aes(fill = rev_total_diff), size = .25) +
  scale_fill_gradient2(low="#FF0000", midpoint = 0, mid="#FFFFFF", high="#4b2e83", name="2018 Dollars") +
  labs(title="Total Revenue Per Pupil, 2018-2019",
       subtitle = "Dollar Difference Against State Mean for the School Year")+
  theme_uw_map()
```


## McCleary Maps
```{r B3_maps_mccleary}

wa_mccleary_rev_wide %>%
  sf::st_as_sf() %>% 
  ggplot() +
  geom_sf(aes(fill = rev_fed_mean_reform_diff), size = .25) +
  scale_fill_gradient2(low="#FF0000", midpoint = 0, mid="#FFFFFF", high="#4b2e83", name="2018 Dollars") +
  labs(title="Federal Revenue Difference Post-McCleary Reform",
       subtitle = "Between 2016/2017/2018 (3 Year Average) and 2019/2020 (2 Year Average)")+
  theme_uw_map()

wa_mccleary_rev_wide %>%
  sf::st_as_sf() %>% 
  ggplot() +
  geom_sf(aes(fill = rev_st_mean_reform_diff), size = .25) +
  scale_fill_gradient2(low="#FF0000", midpoint = 0, mid="#FFFFFF", high="#4b2e83", name="2018 Dollars") +
  labs(title="State Revenue Difference Post-McCleary Reform",
       subtitle = "Between 2016/2017/2018 (3 Year Average) and 2019/2020 (2 Year Average)")+
  theme_uw_map()

wa_mccleary_rev_wide %>%
  sf::st_as_sf() %>% 
  ggplot() +
  geom_sf(aes(fill = rev_loc_mean_reform_diff), size = .25) +
  scale_fill_gradient2(low="#FF0000", midpoint = 0, mid="#FFFFFF", high="#4b2e83", name="2018 Dollars") +
  labs(title="Local Revenue Difference Post-McCleary Reform",
       subtitle = "Between 2016/2017/2018 (3 Year Average) and 2019/2020 (2 Year Average)")+
  theme_uw_map()

wa_mccleary_rev_wide %>%
  sf::st_as_sf() %>% 
  ggplot() +
  geom_sf(aes(fill = rev_total_mean_reform_diff), size = .25) +
  scale_fill_gradient2(low="#FF0000", midpoint = 0, mid="#FFFFFF", high="#4b2e83", name="2018 Dollars") +
  labs(title="Total Revenue Difference Post-McCleary Reform",
       subtitle = "Between 2016/2017/2018 (3 Year Average) and 2019/2020 (2 Year Average)")+
  theme_uw_map()

```

- Difference is calculated as % change in revenue per pupil over 3 year period (2015-16, 2016-17, 2017-18, 3 year average) to difference of the two year average (2018-19 and 19-2020), divided by average of pre-McCleary as base to get percentage change

# B4: Expenditure categories 

```{r B4_expenditures_soc}

#REMOVE FEDERAL AND CATEGORICAL FUNDS, IF JUST WANT TO FOCUS ON SUM OF STATE AND LOCAL
#LOOK AT ACT_DESC UNDER BASIC EDUCATION, MCCLEARY FOCUSED ON BASIC EDUCATION, SEE WHAT THE BREAKDOWN IS


df_e_2020 <- df_e_merge_raw%>%
  filter(schyear == 2020)%>% 
  drop_na(dist_group_soc)%>%
  mutate(dist_group_soc = as.factor(dist_group_soc),
         amount_pp = (amount/TotalEnrollment))

levels(df_e_2020$dist_group_soc) <- c("0-24%","25-49%","50-74%", "75-100%")

df_e_2020_sum <- df_e_2020%>%
  group_by(coudis_s, prog_desc, dist_group_soc)%>%
  summarize(amount_pp_total=sum(amount_pp))

df_e_2020_avg <- df_e_2020_sum %>%
  group_by(dist_group_soc, prog_desc)%>%
  summarize(amount_pp_avg=mean(amount_pp_total))

df_e_2020_avg%>%
  filter(prog_desc!="NA")%>%
  ggplot(
    aes(reorder(prog_desc, amount_pp_avg, sum), 
        amount_pp_avg)) +
  geom_bar(position="dodge", stat="identity")+
  coord_flip()+
  labs(title="Average Per-Student Dollar Amount by All Expenditure Categories, 2019-2020")+
  xlab("") + 
  ylab("") +
  theme_uw()

df_e_2020_avg%>%
  filter(prog_desc!="Basic Education" & prog_desc!="Districtwide Support")%>% #Remove basic education program and Districtwide support
  ggplot(
    aes(reorder(prog_desc, amount_pp_avg, sum), 
        amount_pp_avg)) +
  geom_bar(position="dodge", stat="identity")+
  coord_flip()+
  labs(title="Average Per-Student Dollar Amount by Expenditure Category, 2019-2020",
       subtitle = "Excluding Top Two Categories (Basic Education and Districtwide Support) ")+
  xlab("") + 
  ylab("") +
  theme_uw()

#REVIEW: 
#Which expenditure category to focus on (filter by federal, state, others)? 
#Do we want to cut off the categories with minimal amounts? 
#Group the bottom chunk with OTHER category
#look a regionalization factor

df_e_2020_avg%>%
  filter(prog_desc!="NA")%>% 
  ggplot(
    aes(reorder(prog_desc, amount_pp_avg, sum), 
        amount_pp_avg, 
        group=dist_group_soc,
        fill=dist_group_soc)) +
  geom_bar(position="dodge", stat="identity")+
  coord_flip()+
  labs(title = "Average Per-Student Dollar Amount by Expenditure Category, 2019-2020",
       subtitle = "By District Percentage Student of Color")+
  xlab("") + 
  ylab("") +
  scale_fill_manual(values = palette_uw_reverse(4)) + 
  facet_wrap(~dist_group_soc,
             nrow=1)+
  theme_uw()

df_e_2020_avg%>%
  filter(prog_desc!="Basic Education" & prog_desc!="Districtwide Support")%>% #Remove basic education program and Districtwide support
  ggplot(
    aes(reorder(prog_desc, amount_pp_avg, sum), 
        amount_pp_avg, 
        group=dist_group_soc,
        fill=dist_group_soc)) +
  geom_bar(position="dodge", stat="identity")+
  coord_flip()+
  labs(title = "Average Per-Student Dollar Amount by Expenditure Category, 2019-2020",
       subtitle = "By District Percentage Student of Color and Excluding Top Two Categories ")+
  xlab("") + 
  ylab("") +
    scale_fill_manual(values = palette_uw_reverse(4)) + 
  facet_wrap(~dist_group_soc,
             nrow=1)+
  theme_uw()

#REVIEW:
#Same questions as above.
#I separated SOC into quartiles, do we want to categorize them differently? What's both interesting and consumable? 

```

```{r B4_expenditures_pov}

df_e_2020_pov <- df_e_merge_raw%>%
  filter(deciles_frpl==1 | deciles_frpl == 9)%>%
  filter(schyear == 2020)%>% 
  drop_na(deciles_frpl)%>%
  mutate(deciles_frpl = as.factor(deciles_frpl),
         amount_pp = (amount/TotalEnrollment))

levels(df_e_2020_pov$deciles_frpl) <- c("Low-Poverty", "High-Poverty")

df_e_2020_pov_sum <- df_e_2020_pov%>%
  group_by(coudis_s, prog_desc, deciles_frpl)%>%
  summarize(amount_pp_total=sum(amount_pp))

df_e_2020_pov_avg <- df_e_2020_pov_sum %>%
  group_by(deciles_frpl, prog_desc)%>%
  summarize(amount_pp_avg=mean(amount_pp_total))

df_e_2020_pov_avg%>%
  filter(prog_desc!="NA")%>% 
  ggplot(
    aes(reorder(prog_desc, amount_pp_avg, sum), 
        amount_pp_avg, 
        group=deciles_frpl,
        fill=deciles_frpl)) +
  geom_bar(position="dodge", stat="identity")+
  coord_flip()+
  labs(title = "Average Per-Student Dollar Amount by Expenditure Category, 2019-2020",
       subtitle = "By District Percentage of Students Qualifying for Free and Reduced Price Lunch")+
  xlab("") + 
  ylab("") +
  scale_fill_manual(values=palette_uw_reverse(2))+
  facet_wrap(~deciles_frpl,
             nrow=1)+
  theme_uw()

df_e_2020_pov_avg%>%
  filter(prog_desc!="Basic Education" & prog_desc!="Districtwide Support")%>% #Remove basic education program and Districtwide support
  ggplot(
    aes(reorder(prog_desc, amount_pp_avg, sum), 
        amount_pp_avg, 
        group=deciles_frpl,
        fill=deciles_frpl)) +
  geom_bar(position="dodge", stat="identity")+
  coord_flip()+
  labs(title = "Average Per-Student Dollar Amount by Expenditure Category, 2019-2020",
       subtitle = "By District Percentage of Students Qualifying for Free and Reduced Price Lunch and Excluding Top Two Categories")+
  xlab("") + 
  ylab("") +
  scale_fill_manual(values=palette_uw_reverse(2))+
  facet_wrap(~deciles_frpl,
             nrow=1)+
  theme_uw()


```

- We focus on the 2019-2020 school year, the second year of the McCleary reform.

