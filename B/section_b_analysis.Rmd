---
title: 'Section B: State of Washington School Finance Systems and Structures'
author: "Katherine Chang"
date: "`r format(Sys.Date(), format = '%B %d, %Y')`"
output: 
  html_document:
    toc: true
    toc_float: true
    fig_width: 10
knit: (function(input, encoding) rmarkdown::render(input, output_file = "index.html"))
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE,
                      comment = NA, 
                      cache = TRUE,
                      warning = FALSE,
                      message = FALSE, 
                      cache.lazy = FALSE,
                      fig.align = "center"
                      )
```

# Introduction

```{r data_read, include=FALSE}
library(tidyverse)
library(googledrive)
library(haven)

id_f196 <- drive_get(as_id("https://drive.google.com/file/d/1sGIIj3hplOHq7qPL7S7YTmQByzuCcHVU/view?usp=sharing"))

id_f196_expenditures <- drive_get(as_id("https://drive.google.com/file/d/17FERYE8eHgc1WPRoMZV42UC5aeE17SGC/view?usp=sharing")) #2015-2020

id_demos <- drive_get(as_id("https://drive.google.com/file/d/1coJ9kMZUpRmxNyli6xZ31WITaZdyJXIk/view?usp=sharing"))

id_cwi <- drive_get(as_id("https://drive.google.com/file/d/1TYBldsqu4qX265YUnRd6UbPTn7kHrc-F/view?usp=sharing"))

df_f196 <- id_f196 %>%
  drive_read_raw() %>%
  read_dta()

df_f196_expenditures <- id_f196_expenditures %>%
  drive_read_raw() %>%
  read_dta()

df_demos <- id_demos %>%
  drive_read_raw() %>%
  read_dta()

df_cwi <- id_cwi %>%
  drive_read_raw() %>%
  read_csv()
```


```{r data_cleaning, include=FALSE}

df_demos_dist <- df_demos %>%
  mutate(coudis_s = str_pad(as.character(CountyDistrictNumber), 5, side="left", pad="0"),
         schyear = paste("20", gsub("[0-9]+-", "", SchoolYear), sep=""))%>%
  group_by(coudis_s, schyear)%>%
  summarise_at(c("TotalEnrollment",
                 "NumberAmericanIndianOrAlaskan",
                 "NumberAsian",
                 "NumberBlack",
                 "NumberHispanic",
                 "NumberAsianPacificIslander",
                 "NumberMultirac",
                 "NumberWhite"), 
               sum)%>% 
  mutate(schyear=as.numeric(schyear))

df_demos_dist <- df_demos_dist%>%
  mutate(PctAmericanIndianOrAlaskan = NumberAmericanIndianOrAlaskan/TotalEnrollment,
         PctAsian = NumberAsian/TotalEnrollment,
         PctBlack = NumberBlack/TotalEnrollment,
         PctHispanic = NumberHispanic/TotalEnrollment,
         PctAsianPacificIslander = NumberAsianPacificIslander/TotalEnrollment,
         PctMultirac = NumberMultirac/TotalEnrollment,
         PctWhite = NumberWhite/TotalEnrollment
         )%>%
  mutate_at(vars(PctAmericanIndianOrAlaskan:PctWhite), ~replace_na(., 0))

df_e_merge_raw <- full_join(df_f196_expenditures, df_demos_dist, by=c("coudis_s"="coudis_s", "schyear"="schyear"))

df_e_merge <- df_e_merge_raw %>%
  mutate(dist_nstu_soc = rowSums(.[c("NumberAsian", "NumberBlack", "NumberHispanic", "NumberAmericanIndianOrAlaskan", "NumberAsianPacificIslander", "NumberMultirac")], na.rm=TRUE),
         dist_pctstu_soc = as.numeric(dist_nstu_soc/TotalEnrollment),
         dist_group_soc = case_when(dist_pctstu_soc >= 0  & dist_pctstu_soc < 0.25 ~ '1',
                                    dist_pctstu_soc >= 0.25  & dist_pctstu_soc < 0.50 ~ '2',
                                    dist_pctstu_soc >= 0.50  & dist_pctstu_soc < 0.75 ~ '3',
                                    dist_pctstu_soc >= 0.75  & dist_pctstu_soc <= 1 ~ '4')
  )

df_f196_merge_raw <- full_join(df_f196, df_demos_dist, by=c("coudis"="coudis_s", "schyear"="schyear"))

df_f196_merge<- full_join(df_f196_merge_raw, df_cwi, by=c("coudis"="dist_id", "schyear"="year"))

```

Our guiding research questions include:

- How have Washington public schools been funded in the past few years (NEED YEARS), particularly for districts serving high-poverty and students of color? 
- How have McCleary school finance reforms changed schools funding sources per pupil? 
- How have these changes varied across districts? 
- How do schools spend their resources?

# B1: Revenue source for high- and low-poverty districts
```{r B1_revenue_poverty, include=FALSE}



```

Federal, state, and local revenue source for high- and low-poverty districts

# B2: Revenue source for districts serving students of color

```{r B2_revenue_soc, include=FALSE}



```

Federal, state, and local revenue source for districts serving students of color

# B3: Spatial distribution of school funding

```{r B3_maps}

library(leaidr)
library(sf)

wa <- lea_get("wa")%>% 
  sf::st_as_sf() 

df_f196_merge <- df_f196_merge%>%
  mutate(leaid = as.character(leaid),
         rev_st_pp_18d=(rev_st_18d_Total/dis_enroll),
         rev_loc_pp_18d=(localrev_201819Spring_18d/dis_enroll))


df_f196_merge <- df_f196_merge%>%
  group_by(schyear)%>%
  mutate(rev_st_mean = mean(rev_st_pp_18d, na.rm = TRUE), 
         rev_loc_mean = mean(rev_loc_pp_18d, na.rm = TRUE))

df_f196_merge <- df_f196_merge%>%
  mutate(rev_st_diff= (rev_st_pp_18d-rev_st_mean),
         rev_loc_diff=(rev_loc_pp_18d-rev_loc_mean))

#What percentage higher than lower than state average for the state/local revenue
#map demographics, native + latinx student populations
#native, majority belong to multiracial group
#Distribution of dollars -> district that serve large % of SOC/low-income

wa_df196 <- left_join(df_f196_merge, wa, by = c("leaid" = "GEOID"), copy=TRUE) 

#Demographic Maps

wa_df196 %>%
  sf::st_as_sf() %>% 
  filter(schyear==2019)%>%
  ggplot() +
  geom_sf(aes(fill = PctHispanic), size = .25) +
  scale_fill_gradient2(low="#FFFFFF", high="#4b2e83", name="Percentage") +
  theme_void() +
  labs(title="Figure. Latinx Students Percentage of Total Student Enrollment, 2018-2019 ")+
  theme(plot.title = element_text(hjust = 0.5))

wa_df196 %>%
  sf::st_as_sf() %>% 
  filter(schyear==2019)%>%
  ggplot() +
  geom_sf(aes(fill = PctAmericanIndianOrAlaskan), size = .25) +
  scale_fill_gradient2(low="#FFFFFF", high="#4b2e83", name="Percentage") +
  theme_void() +
  labs(title="Figure. Indigenous Students Percentage of Total Student Enrollment, 2018-2019 ")+
  theme(plot.title = element_text(hjust = 0.5))

wa_df196 %>%
  sf::st_as_sf() %>% 
  filter(schyear==2019)%>%
  ggplot() +
  geom_sf(aes(fill = PctAsian), size = .25) +
  scale_fill_gradient2(low="#FFFFFF", high="#4b2e83", name="Percentage") +
  theme_void() +
  labs(title="Figure. Asian Students Percentage of Total Student Enrollment, 2018-2019 ")+
  theme(plot.title = element_text(hjust = 0.5))

wa_df196 %>%
  sf::st_as_sf() %>% 
  filter(schyear==2019)%>%
  ggplot() +
  geom_sf(aes(fill = PctMultirac), size = .25) +
  scale_fill_gradient2(low="#FFFFFF", high="#4b2e83", name="Percentage") +
  theme_void() +
  labs(title="Figure. Multiracial Students Percentage of Total Student Enrollment, 2018-2019 ")+
  theme(plot.title = element_text(hjust = 0.5))

#Finance Maps (Need to figure out what colors work best with this map to make it pop)

wa_df196 %>%
  sf::st_as_sf() %>% 
  filter(schyear==2019)%>%
  ggplot() +
  geom_sf(aes(fill = rev_st_diff), size = .25) +
  scale_fill_gradient2(low="#85754d", midpoint = 0, mid="#FFFFFF", high="#4b2e83", name="2018 Dollars") +
  theme_void() +
  labs(title="Figure. State Revenue Per Pupil, 2018-2019")+
  theme(plot.title = element_text(hjust = 0.5))

wa_df196 %>%
  sf::st_as_sf() %>% 
  filter(schyear==2019)%>%
  ggplot() +
  geom_sf(aes(fill = rev_loc_diff), size = .25) +
  scale_fill_gradient2(low="#85754d", midpoint = 0, mid="#FFFFFF", high="#4b2e83", name="2018 Dollars") +
  theme_void() +
  labs(title="Figure. Local Levy Revenue Per Pupil, 2018-2019")+
  theme(plot.title = element_text(hjust = 0.5))

```

Maps of (1) state revenue per pupil; (2) federal revenue per pupil; and (3) local revenue per pupil; (4) total expenditure per-pupil

% change in revenue per pupil over 3 year period (2015-16, 2016-17, 2017-18, 3 year average) to difference of the two year average (2018-19 and 19-2020), divided by average of pre-McCleary as base to get percentage change

# B4: Expenditure categories 

```{r B4_expenditures}

df_e_2020 <- df_e_merge%>%
  filter(schyear == 2020)%>% 
  drop_na(dist_group_soc)%>%
  mutate(dist_group_soc = as.factor(dist_group_soc),
         amount_pp = (amount/TotalEnrollment))

levels(df_e_2020$dist_group_soc) <- c("0-24%","25-49%","50-74%", "75-100%")

df_e_2020_sum = df_e_2020%>%
  group_by(coudis_s, prog_desc, dist_group_soc)%>%
  summarize(amount_pp_total=sum(amount_pp))

df_e_2020_avg = df_e_2020_sum %>%
  group_by(dist_group_soc, prog_desc)%>%
  summarize(amount_pp_avg=mean(amount_pp_total))

df_e_2020_avg%>%
  filter(prog_desc!="NA")%>%
  ggplot(
    aes(reorder(prog_desc, amount_pp_avg, sum), 
        amount_pp_avg)) +
  geom_bar(position="dodge", stat="identity")+
  coord_flip()+
  theme(panel.background = element_blank(), 
        axis.line.x = element_line(color = "#D3D3D3"),
        panel.grid.major.x = element_line(color = "#D3D3D3"),
        plot.title.position = "plot"
        ) +
  labs(title="Figure. Average Per-Student Dollar Amount by All Expenditure Categories, 2019-2020")+
  xlab("") + 
  ylab("")

df_e_2020_avg%>%
  filter(prog_desc!="Basic Education" & prog_desc!="Districtwide Support")%>% #Remove basic education program and Districtwide support
  ggplot(
    aes(reorder(prog_desc, amount_pp_avg, sum), 
        amount_pp_avg)) +
  geom_bar(position="dodge", stat="identity")+
  coord_flip()+
  theme(panel.background = element_blank(), 
        axis.line.x = element_line(color = "#D3D3D3"),
        panel.grid.major.x = element_line(color = "#D3D3D3"),
        plot.title.position = "plot"
        ) +
  labs(title="Figure. Average Per-Student Dollar Amount by Expenditure Category, 2019-2020",
       subtitle = "Excluding Top Two Categories (Basic Education and Districtwide Support) ")+
  xlab("") + 
  ylab("")

#REVIEW: 
#Which expenditure category to focus on (filter by federal, state, others)? 
#Do we want to cut off the categories with minimal amounts? 
#Group the bottom chunk with OTHER category
#look a regionalization factor

df_e_2020_avg%>%
  filter(prog_desc!="NA")%>% 
  ggplot(
    aes(reorder(prog_desc, amount_pp_avg, sum), 
        amount_pp_avg, 
        group=dist_group_soc,
        fill=dist_group_soc)) +
  geom_bar(position="dodge", stat="identity")+
  coord_flip()+
  theme(panel.background = element_blank(), 
        axis.line.x = element_line(color = "#D3D3D3"),
        panel.grid.major.x = element_line(color = "#D3D3D3"),
        plot.title.position = "plot",
        legend.position="none") +
  labs(title = "Figure. Average Per-Student Dollar Amount by Expenditure Category, 2019-2020",
       subtitle = "By District Percentage Student of Color")+
  xlab("") + 
  ylab("") +
  facet_wrap(~dist_group_soc,
             nrow=1)

df_e_2020_avg%>%
  filter(prog_desc!="Basic Education" & prog_desc!="Districtwide Support")%>% #Remove basic education program and Districtwide support
  ggplot(
    aes(reorder(prog_desc, amount_pp_avg, sum), 
        amount_pp_avg, 
        group=dist_group_soc,
        fill=dist_group_soc)) +
  geom_bar(position="dodge", stat="identity")+
  coord_flip()+
  theme(panel.background = element_blank(), 
        axis.line.x = element_line(color = "#D3D3D3"),
        panel.grid.major.x = element_line(color = "#D3D3D3"),
        plot.title.position = "plot",
        legend.position="none") +
  labs(title = "Figure. Average Per-Student Dollar Amount by Expenditure Category, 2019-2020",
       subtitle = "By District Percentage Student of Color and Excluding Top Two Categories ")+
  xlab("") + 
  ylab("") +
  facet_wrap(~dist_group_soc,
             nrow=1)
#REVIEW:
#Same questions as above.
#I separated SOC into quartiles, do we want to categorize them differently? What's both interesting and consumable? 

```

In Section B4, we present information about expenditure category by two students groups: low- and high-poverty and students of color and white students.

We focus on the 2019-2020 school year, the second year of the McCleary reform.


