---
title: 'Section B: State of Washington School Finance Systems and Structures'
author: "Katherine Chang"
date: "`r format(Sys.Date(), format = '%B %d, %Y')`"
output: 
  html_document:
    toc: true
    toc_float: true
    fig_width: 10
knit: (function(input, encoding) rmarkdown::render(input, output_file = "section_b_analysis.html"))
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE,
                      comment = NA, 
                      cache = TRUE,
                      warning = FALSE,
                      message = FALSE, 
                      cache.lazy = FALSE,
                      fig.align = "center"
                      )

theme_efe <-
    ggplot2::theme_classic() +
    ggplot2::theme(
      )
```

# Introduction

```{r data_read, include=FALSE}
library(tidyverse)
library(googledrive)
library(haven)
library(ggtext)

id_f196 <- drive_get(as_id("https://drive.google.com/file/d/1sGIIj3hplOHq7qPL7S7YTmQByzuCcHVU/view?usp=sharing"))

id_f196_expenditures <- drive_get(as_id("https://drive.google.com/file/d/17FERYE8eHgc1WPRoMZV42UC5aeE17SGC/view?usp=sharing")) #2015-2020

id_f195 <- drive_get(as_id("https://drive.google.com/file/d/10XytJG-r2zfM3vpbClTJP9Jnz-6nX0Ef/view?usp=sharing"))

id_f195_2020 <- drive_get(as_id("https://drive.google.com/file/d/10kPXWMDr3-ud7a_4v0-zmFmz0W74HVkX/view?usp=sharing"))

id_demos <- drive_get(as_id("https://drive.google.com/file/d/1coJ9kMZUpRmxNyli6xZ31WITaZdyJXIk/view?usp=sharing"))

id_cwi <- drive_get(as_id("https://drive.google.com/file/d/1--RKu4geGLO9sOxag7pyJtkw40ZYYkeI/view?usp=sharing"))

df_f196 <- id_f196 %>%
  drive_read_raw() %>%
  read_dta()

df_f196_expenditures <- id_f196_expenditures %>%
  drive_read_raw() %>%
  read_dta()

df_demos <- id_demos %>%
  drive_read_raw() %>%
  read_dta()

df_cwi <- id_cwi %>%
  drive_read_raw() %>%
  read_csv()

df_f195 <- id_f195 %>%
  drive_read_raw() %>%
  read_dta()

df_f195_2020 <- id_f195_2020 %>%
  drive_read_raw() %>%
  read_dta()
```


```{r data_cleaning, include=FALSE}

library(collapse)

df_demos_dist <- df_demos %>%
  mutate(coudis_s = str_pad(as.character(CountyDistrictNumber), 5, side="left", pad="0"),
         schyear = paste("20", gsub("[0-9]+-", "", SchoolYear), sep=""))%>%
  group_by(coudis_s, schyear)%>%
  summarise_at(c("TotalEnrollment",
                 "NumberAmericanIndianOrAlaskan",
                 "NumberAsian",
                 "NumberBlack",
                 "NumberHispanic",
                 "NumberAsianPacificIslander",
                 "NumberMultirac",
                 "NumberWhite",
                 "NumberFreeorReducedPricedMeals",
                 "NumberSpecialEducation",
                 "NumberTransitionalBilingual"), 
               sum)%>% 
  mutate(schyear=as.numeric(schyear))

df_demos_dist <- df_demos_dist%>%
  mutate(PctAmericanIndianOrAlaskan = NumberAmericanIndianOrAlaskan/TotalEnrollment,
         PctAsian = NumberAsian/TotalEnrollment,
         PctBlack = NumberBlack/TotalEnrollment,
         PctHispanic = NumberHispanic/TotalEnrollment,
         PctAsianPacificIslander = NumberAsianPacificIslander/TotalEnrollment,
         PctMultirac = NumberMultirac/TotalEnrollment,
         PctWhite = NumberWhite/TotalEnrollment,
         PctFreeorReducedPricedMeals = NumberFreeorReducedPricedMeals/TotalEnrollment,
         PctSpecialEducation = NumberSpecialEducation/TotalEnrollment,
         PctTransitionalBilingual = NumberTransitionalBilingual/TotalEnrollment
         )%>%
  mutate_at(vars(PctAmericanIndianOrAlaskan:PctTransitionalBilingual), ~replace_na(., 0))

df_demos_dist$dist_nstu_soc = rowSums((df_demos_dist[,c("NumberAsian", "NumberBlack", "NumberHispanic", "NumberAmericanIndianOrAlaskan", "NumberAsianPacificIslander", "NumberMultirac")]), na.rm = TRUE)

df_demos_dist <- df_demos_dist%>%
  mutate(dist_pctstu_soc = as.numeric(dist_nstu_soc/TotalEnrollment),
         dist_group_soc = case_when(dist_pctstu_soc >= 0  & dist_pctstu_soc < 0.25 ~ '1',
                                    dist_pctstu_soc >= 0.25  & dist_pctstu_soc < 0.50 ~ '2',
                                    dist_pctstu_soc >= 0.50  & dist_pctstu_soc < 0.75 ~ '3',
                                    dist_pctstu_soc >= 0.75  & dist_pctstu_soc <= 1 ~ '4')
  )

df_demos_dist$deciles_frpl <- ntile(df_demos_dist$PctFreeorReducedPricedMeals, 10)

df_e_merge_raw <- full_join(df_f196_expenditures, df_demos_dist, by=c("coudis_s"="coudis_s", "schyear"="schyear"))

df_f195_fed <- df_f195%>%
  group_by(CCDDD, year)%>%
  filter(item_desc=="TOTAL FEDERAL, GENERAL PURPOSE" | item_desc=="TOTAL FEDERAL, SPECIAL PURPOSE")

df_f195_fed <- collap(df_f195_fed, amount~ CCDDD + year, 
                           FUN = list(fsum))

df_f195_fed <- df_f195_fed%>%
  rename(coudis=CCDDD,
         schyear=year,
         rev_fed=amount)

df_cwi <- df_cwi%>%
  mutate(coudis_s = str_pad(as.character(dist_id), 5, side="left", pad="0"))

df_f196_merge_raw <- full_join(df_f196, df_demos_dist, by=c("coudis"="coudis_s", "schyear"="schyear"))

df_f196_merge_raw<- full_join(df_f196_merge_raw, df_cwi, by=c("coudis"="coudis_s", "schyear"="year"))

df_f196_merge_raw<- full_join(df_f196_merge_raw, df_f195_fed, by=c("coudis"="coudis", "schyear"="schyear"))

```

Our guiding research questions include:

- How have Washington public schools been funded in the past few years (NEED YEARS), particularly for districts serving high-poverty and students of color? 
- How have McCleary school finance reforms changed schools funding sources per pupil? 
- How have these changes varied across districts? 
- How do schools spend their resources?

# B1: Revenue source for high- and low-poverty districts

```{r B1_revenue_data, include=FALSE}

library(caret)
library(car)

#Pull revenue categories fron F195: Federal, State, Local, and Other
df_f195_all <- df_f195%>%
  filter(
    item_desc=="TOTAL FEDERAL, GENERAL PURPOSE" |                                        
      item_desc=="TOTAL FEDERAL, SPECIAL PURPOSE" |                                     
      item_desc=="TOTAL LOCAL SUPPORT NONTAX" |                                         
      item_desc=="TOTAL LOCAL TAXES" |                                                  
      item_desc=="TOTAL STATE, GENERAL PURPOSE" |                                       
      item_desc=="TOTAL STATE, SPECIAL PURPOSE")%>%
  mutate(rev_source = case_when(str_detect(item_desc, 'FEDERAL') ~ "Federal",
                                str_detect(item_desc, 'STATE') ~ "State",
                                str_detect(item_desc, 'LOCAL') ~ "Local",
                                TRUE ~ 'NA'))

df_f195_collapse <- collap(df_f195_all, amount~ CCDDD + year + rev_source, 
                           FUN = list(fsum))

df_f195_collapse <- df_f195_collapse%>%
  rename(coudis=CCDDD,
         schyear=year,
         revenue_amount=amount)

#df_f195_collapse_total <- collap(df_f195_collapse, revenue_amount~ coudis + schyear, 
#                           FUN = list(fsum))

#df_f195_collapse_total <- df_f195_collapse_total%>%
#  mutate(rev_source ="Total")

#df_f195_bind<- rbind(df_f195_collapse, df_f195_collapse_total)

#Bring in NCES Geographic designation.
#https://nces.ed.gov/programs/edge/Geographic/SchoolLocations

id_nces_geo <-drive_get(as_id("https://drive.google.com/file/d/1YXv-RxZMVEO3YiIF-RS4IFTClFgUOHgh/view?usp=sharing"))

df_nces_geo <- id_nces_geo %>%
  drive_read_raw() %>%
  read_csv()

df_locale_wa <- df_nces_geo%>%
  filter(STATE=="WA")%>%
  select(LEAID, NAME, LOCALE, SCHOOLYEAR)%>%
  mutate(LOCALE=as.character(LOCALE),
         LEAID=as.numeric(LEAID))

#Calculate poverty rate by school district and census

#Add CPI (Generated by Chris's package) and CWI (Generated by Pooya)
df_cpi18 <- df_f196%>%
  select(schyear, cpi18)%>%
  distinct()

df_cwi_cpi<- merge(df_cpi18, df_cwi, by.x = "schyear", by.y = "year")

df_f195_cwi<- full_join(df_f195_collapse, df_cwi_cpi, by=c("coudis"="coudis_s", "schyear"="schyear"))
df_f195_merge <- full_join(df_f195_cwi, df_demos_dist, by=c("coudis"="coudis_s", "schyear"="schyear"))

df_f195_merge <- left_join(df_f195_merge, df_locale_wa, by=c("leaid"="LEAID"))

#Adjust dollars by CWI
df_f195_merge <- df_f195_merge%>%
  mutate(
    rev_pp = revenue_amount/TotalEnrollment,
    rev_pp_cwi=rev_pp/cwi,
    rev_pp_18d=rev_pp*cpi18, 
    rev_pp_cwi_18d=rev_pp_cwi*cpi18, 
    dist_group_soc = as.factor(dist_group_soc),
    TotalEnrollment_log = log(TotalEnrollment))%>%
    drop_na(dist_group_soc)

levels(df_f195_merge$dist_group_soc) <- c("0-24%","25-49%","50-74%", "75-100%")

#QUESTION: I adjusted the values by revenue category separately and then total the adjusted values together
#is this the right approach?

#Build figures by revenue source

#model <- lm(rev_pp_cwi_18d ~ TotalEnrollment + LOCALE + PctSpecialEducation + PctTransitionalBilingual,
#             data=df_f195_merge)

#df_f195_merge$rev_adjusted <- predict.lm(model, newdata=df_f195_merge)

##FEDERAL (CWI_18D)
df_f195_fed <- df_f195_merge%>%
  filter(rev_source=="Federal")

model_fed <- lm(rev_pp_cwi_18d ~ log(TotalEnrollment) + LOCALE + PctSpecialEducation + PctTransitionalBilingual,
             data=df_f195_fed)

model_fed_nocwi <- lm(rev_pp_18d ~ log(TotalEnrollment) + LOCALE + PctSpecialEducation + PctTransitionalBilingual,
             data=df_f195_fed)

df_f195_fed$rev_adjusted <- predict.lm(model_fed, newdata=df_f195_fed)
df_f195_fed$rev_adjusted_nocwi <- predict.lm(model_fed_nocwi, newdata=df_f195_fed)

#STATE
df_f195_state <- df_f195_merge%>%
  filter(rev_source=="State")

model_state <- lm(rev_pp_cwi_18d ~ log(TotalEnrollment) + LOCALE + PctSpecialEducation + PctTransitionalBilingual,
             data=df_f195_state)

model_state_nocwi <- lm(rev_pp_18d ~ log(TotalEnrollment) + LOCALE + PctSpecialEducation + PctTransitionalBilingual,
             data=df_f195_state)

df_f195_state$rev_adjusted <- predict.lm(model_state, newdata=df_f195_state)
df_f195_state$rev_adjusted_nocwi <- predict.lm(model_state_nocwi, newdata=df_f195_state)

#LOCAL
df_f195_loc <- df_f195_merge%>%
  filter(rev_source=="Local")

model_loc <- lm(rev_pp_cwi_18d ~ log(TotalEnrollment) + LOCALE + PctSpecialEducation + PctTransitionalBilingual,
             data=df_f195_loc)

model_loc_nocwi <- lm(rev_pp_18d ~ log(TotalEnrollment) + LOCALE + PctSpecialEducation + PctTransitionalBilingual,
             data=df_f195_loc)

df_f195_loc$rev_adjusted <- predict.lm(model_loc, newdata=df_f195_loc)
df_f195_loc$rev_adjusted_nocwi <- predict.lm(model_loc_nocwi, newdata=df_f195_loc)

#Adjust for district size (TotalEnrollment), urbanicity (using LOCALE codes), average cost of labor (cwi), and the percent of students enrolled in special education (PctSpecialEducation) and classified as limited English proficient (PctTransitionalBilingual).

df_f195_total <- data.frame(
  df_f195_fed$schyear,
  df_f195_fed$leaid,
  df_f195_fed$coudis,
  df_f195_fed$rev_adjusted,
  df_f195_fed$rev_adjusted_nocwi,
  df_f195_state$rev_adjusted,
  df_f195_state$rev_adjusted_nocwi,
  df_f195_loc$rev_adjusted,
  df_f195_loc$rev_adjusted_nocwi)

df_f195_total <- df_f195_total%>%
  mutate(rev_adjusted = df_f195_fed.rev_adjusted + df_f195_state.rev_adjusted + df_f195_loc.rev_adjusted,
         rev_adjusted_nocwi = df_f195_fed.rev_adjusted_nocwi + df_f195_state.rev_adjusted_nocwi + df_f195_loc.rev_adjusted_nocwi)%>%
  select(-c(df_f195_fed.rev_adjusted, df_f195_state.rev_adjusted, df_f195_loc.rev_adjusted, df_f195_fed.rev_adjusted_nocwi, df_f195_state.rev_adjusted_nocwi, df_f195_loc.rev_adjusted_nocwi))%>%
  rename(coudis=df_f195_fed.coudis,
         schyear=df_f195_fed.schyear,
         leaid=df_f195_fed.leaid)
  #rename_with(~paste0(sub("^([^.]+\\.)", "", .)), -1)

df_f195_total <- full_join(df_f195_total, df_demos_dist, by=c("coudis"="coudis_s", "schyear"="schyear"))

```

Federal, state, and local revenue source for high- and low-poverty districts

```{r B1_revenue_pov, include=FALSE}

#QUESTION: Annual poverty rate from 2015-2020? 
#Calculate poverty rate by school district and ACS?
#Look at FRPL as a measure of poverty since it's more relevant for poverty

#Using SAIPE because tidycensus ACS2014-2018 isn't allowing school dist geography
#https://www.census.gov/data/datasets/2019/demo/saipe/2019-school-districts.html

id_saipe_2019 <- drive_get(as_id("https://drive.google.com/file/d/12iSqavUVCtMeCLn63XuPiMN4Sa0-v8L1/view?usp=sharing"))

df_saipe_2019_raw <- id_saipe_2019 %>%
  drive_read_raw() %>%
  read_csv()

df_saipe_2019_raw$leaid <- str_replace_all(df_saipe_2019_raw$leaid, " ", "")

df_saipe_2019 <- df_saipe_2019_raw%>%
  mutate(pctpov5to17_per5to17 = est_pop_pov5to17/pop_5to17,
         pctpov5to17_pertotalpop = est_pop_pov5to17/pop_total)%>%
  select(-dist_name)

df_saipe_2019$deciles_5to17 <- ntile(df_saipe_2019$pctpov5to17_per5to17, 10)

df_f195_fed<- merge(df_f195_fed, df_saipe_2019, by.x = "leaid", by.y = "leaid")
df_f195_state<- merge(df_f195_state, df_saipe_2019, by.x = "leaid", by.y = "leaid")
df_f195_loc<- merge(df_f195_loc, df_saipe_2019, by.x = "leaid", by.y = "leaid")
df_f195_total<- merge(df_f195_total, df_saipe_2019, by.x = "leaid", by.y = "leaid")

compare_saipe_frpl <- df_f195_fed%>%
  select(leaid, deciles_5to17, deciles_frpl, PctFreeorReducedPricedMeals)
```

## Revenue Source by Time

```{r B1_revenue_time_pov}

###FED SAIPE

df_f195_fed_figure_pov_saipe <- df_f195_fed%>%
  filter(deciles_5to17==1 | deciles_5to17 == 9)%>%
  mutate(deciles_5to17 = as.factor(deciles_5to17))
  
levels(df_f195_fed_figure_pov_saipe$deciles_5to17) <- c("Low-Poverty", "High-Poverty")

ggplot(df_f195_fed_figure_pov_saipe, 
       aes(x=schyear,y=rev_adjusted, fill=deciles_5to17)) + 
  stat_summary(geom="line", fun="mean", alpha=0.5) +
  stat_summary(geom="ribbon", 
               fun.data = mean_se, #mean_cl_normal
               aes(fill=deciles_5to17), alpha=0.25) +
  labs(title="Figure. Federal Revenue Amount Per Student (SAIPE)",
       subtitle = "Regression adjusted for difference of cost factors including district size, 
       urbanicity/locale, average cost of labor, and percent of students enrolled in 
       special education and classified as limited English proficient",
       caption="Note: High and low-poverty districts estimated at the 10th and 90th percentile 
       of poverty rate within the state, with an equal number of districts in each quantile")+
  xlab("School Year (Spring)") + 
  ylab("2018 Dollars") + 
  geom_vline(xintercept = 2018, colour='#FFFFFF', linetype="dashed")+
  theme(panel.background = element_blank(), 
        legend.title = element_blank(),
        axis.line.x = element_line(color = "#D3D3D3"),
        panel.grid.major.x = element_line(color = "#D3D3D3"),
        plot.title.position = "plot",
        plot.caption =  element_markdown(hjust = 0)
        ) +
  scale_fill_manual(values=c("#4b2e83", "#85754d"), 
                    name="fill")

ggplot(df_f195_fed_figure_pov_saipe, 
       aes(x=schyear,y=rev_adjusted_nocwi, fill=deciles_5to17)) + 
  stat_summary(geom="line", fun="mean", alpha=0.5) +
  stat_summary(geom="ribbon", 
               fun.data = mean_se, #mean_cl_normal
               aes(fill=deciles_5to17), alpha=0.25) +
  labs(title="Figure. Federal Revenue Amount Per Student (SAIPE) (NO CWI)",
       subtitle = "Regression adjusted for difference of cost factors including district size, 
       urbanicity/locale, and percent of students enrolled in 
       special education and classified as limited English proficient",
       caption="Note: High and low-poverty districts estimated at the 10th and 90th percentile 
       of poverty rate within the state, with an equal number of districts in each quantile")+
  xlab("School Year (Spring)") + 
  ylab("2018 Dollars") + 
  geom_vline(xintercept = 2018, colour='#FFFFFF', linetype="dashed")+
  theme(panel.background = element_blank(), 
        legend.title = element_blank(),
        axis.line.x = element_line(color = "#D3D3D3"),
        panel.grid.major.x = element_line(color = "#D3D3D3"),
        plot.title.position = "plot",
        plot.caption =  element_markdown(hjust = 0)
        ) +
  scale_fill_manual(values=c("#4b2e83", "#85754d"), 
                    name="fill")

#FED FRPL

df_f195_fed_figure_pov_frpl <- df_f195_fed%>%
  filter(deciles_frpl==1 | deciles_frpl == 9)%>%
  mutate(deciles_frpl = as.factor(deciles_frpl))

levels(df_f195_fed_figure_pov_frpl$deciles_frpl) <- c("Low-Poverty", "High-Poverty")

ggplot(df_f195_fed_figure_pov_frpl, 
       aes(x=schyear,y=rev_adjusted, fill=deciles_frpl)) + 
  stat_summary(geom="line", fun="mean", alpha=0.5) +
  stat_summary(geom="ribbon", 
               fun.data = mean_se, #mean_cl_normal
               aes(fill=deciles_frpl), alpha=0.25) +
  labs(title="Figure. Federal Revenue Amount Per Student (FRPL)",
       subtitle = "Regression adjusted for difference of cost factors including district size, 
       urbanicity/locale, average cost of labor, and percent of students enrolled in 
       special education and classified as limited English proficient",
       caption="Note: High and low-poverty districts estimated at the 10th and 90th percentile 
       of district percentage of students qualifying for free and reduced price lunch, 
       with an equal number of districts in each quantile")+
  xlab("School Year (Spring)") + 
  ylab("2018 Dollars") + 
  geom_vline(xintercept = 2018, colour='#FFFFFF', linetype="dashed")+
  theme(panel.background = element_blank(), 
        legend.title = element_blank(),
        axis.line.x = element_line(color = "#D3D3D3"),
        panel.grid.major.x = element_line(color = "#D3D3D3"),
        plot.title.position = "plot",
        plot.caption =  element_markdown(hjust = 0)
        ) +
  scale_fill_manual(values=c("#4b2e83", "#85754d"), 
                    name="fill")

ggplot(df_f195_fed_figure_pov_frpl, 
       aes(x=schyear,y=rev_adjusted_nocwi, fill=deciles_frpl)) + 
  stat_summary(geom="line", fun="mean", alpha=0.5) +
  stat_summary(geom="ribbon", 
               fun.data = mean_se, #mean_cl_normal
               aes(fill=deciles_frpl), alpha=0.25) +
  labs(title="Figure. Federal Revenue Amount Per Student (FRPL) (NO CWI)",
       subtitle = "Regression adjusted for difference of cost factors including district size, 
       urbanicity/locale, and percent of students enrolled in 
       special education and classified as limited English proficient",
       caption="Note: High and low-poverty districts estimated at the 10th and 90th percentile 
       of district percentage of students qualifying for free and reduced price lunch, 
       with an equal number of districts in each quantile")+
  xlab("School Year (Spring)") + 
  ylab("2018 Dollars") + 
  geom_vline(xintercept = 2018, colour='#FFFFFF', linetype="dashed")+
  theme(panel.background = element_blank(), 
        legend.title = element_blank(),
        axis.line.x = element_line(color = "#D3D3D3"),
        panel.grid.major.x = element_line(color = "#D3D3D3"),
        plot.title.position = "plot",
        plot.caption =  element_markdown(hjust = 0)
        ) +
  scale_fill_manual(values=c("#4b2e83", "#85754d"), 
                    name="fill")

### STATE SAIPE

df_f195_state_figure_pov <- df_f195_state%>%
  filter(deciles_5to17==1 | deciles_5to17 == 9)%>%
  mutate(deciles_5to17 = as.factor(deciles_5to17))
  
levels(df_f195_state_figure_pov$deciles_5to17) <- c("Low-Poverty", "High-Poverty")

ggplot(df_f195_state_figure_pov, 
       aes(x=schyear,y=rev_adjusted, fill=deciles_5to17)) + 
  stat_summary(geom="line", fun="mean", alpha=0.5) +
  stat_summary(geom="ribbon", 
               fun.data = mean_se, #mean_cl_normal
               aes(fill=deciles_5to17), alpha=0.25) +
  labs(title="Figure. State Revenue Amount Per Student (SAIPE)",
       subtitle = "Regression adjusted for difference of cost factors including district size, 
       urbanicity/locale, average cost of labor, and percent of students enrolled in 
       special education and classified as limited English proficient",
       caption="Note: High and low-poverty districts estimated at the 10th and 90th percentile 
       of poverty rate within the state, with an equal number of districts in each quantile")+
  xlab("School Year (Spring)") + 
  ylab("2018 Dollars") + 
  geom_vline(xintercept = 2018, colour='#FFFFFF', linetype="dashed")+
  theme(panel.background = element_blank(), 
        legend.title = element_blank(),
        axis.line.x = element_line(color = "#D3D3D3"),
        panel.grid.major.x = element_line(color = "#D3D3D3"),
        plot.title.position = "plot",
        plot.caption =  element_markdown(hjust = 0)
        ) +
  scale_fill_manual(values=c("#4b2e83", "#85754d"), 
                    name="fill")

ggplot(df_f195_state_figure_pov, 
       aes(x=schyear,y=rev_adjusted_nocwi, fill=deciles_5to17)) + 
  stat_summary(geom="line", fun="mean", alpha=0.5) +
  stat_summary(geom="ribbon", 
               fun.data = mean_se, #mean_cl_normal
               aes(fill=deciles_5to17), alpha=0.25) +
  labs(title="Figure. State Revenue Amount Per Student (SAIPE) (NO CWI)",
       subtitle = "Regression adjusted for difference of cost factors including district size, 
       urbanicity/locale, and percent of students enrolled in 
       special education and classified as limited English proficient",
       caption="Note: High and low-poverty districts estimated at the 10th and 90th percentile 
       of poverty rate within the state, with an equal number of districts in each quantile")+
  xlab("School Year (Spring)") + 
  ylab("2018 Dollars") + 
  geom_vline(xintercept = 2018, colour='#FFFFFF', linetype="dashed")+
  theme(panel.background = element_blank(), 
        legend.title = element_blank(),
        axis.line.x = element_line(color = "#D3D3D3"),
        panel.grid.major.x = element_line(color = "#D3D3D3"),
        plot.title.position = "plot",
        plot.caption =  element_markdown(hjust = 0)
        ) +
  scale_fill_manual(values=c("#4b2e83", "#85754d"), 
                    name="fill")

#STATE FRPL

df_f195_state_figure_pov_frpl <- df_f195_state%>%
  filter(deciles_frpl==1 | deciles_frpl == 9)%>%
  mutate(deciles_frpl = as.factor(deciles_frpl))

levels(df_f195_state_figure_pov_frpl$deciles_frpl) <- c("Low-Poverty", "High-Poverty")

ggplot(df_f195_state_figure_pov_frpl, 
       aes(x=schyear,y=rev_adjusted, fill=deciles_frpl)) + 
  stat_summary(geom="line", fun="mean", alpha=0.5) +
  stat_summary(geom="ribbon", 
               fun.data = mean_se, #mean_cl_normal
               aes(fill=deciles_frpl), alpha=0.25) +
  labs(title="Figure. State Revenue Amount Per Student (FRPL)",
       subtitle = "Regression adjusted for difference of cost factors including district size, 
       urbanicity/locale, and percent of students enrolled in 
       special education and classified as limited English proficient",
       caption="Note: High and low-poverty districts estimated at the 10th and 90th percentile 
       of district percentage of students qualifying for free and reduced price lunch, 
       with an equal number of districts in each quantile")+
  xlab("School Year (Spring)") + 
  ylab("2018 Dollars") + 
  geom_vline(xintercept = 2018, colour='#FFFFFF', linetype="dashed")+
  theme(panel.background = element_blank(), 
        legend.title = element_blank(),
        axis.line.x = element_line(color = "#D3D3D3"),
        panel.grid.major.x = element_line(color = "#D3D3D3"),
        plot.title.position = "plot",
        plot.caption =  element_markdown(hjust = 0)
        ) +
  scale_fill_manual(values=c("#4b2e83", "#85754d"), 
                    name="fill")

ggplot(df_f195_state_figure_pov_frpl, 
       aes(x=schyear,y=rev_adjusted_nocwi, fill=deciles_frpl)) + 
  stat_summary(geom="line", fun="mean", alpha=0.5) +
  stat_summary(geom="ribbon", 
               fun.data = mean_se, #mean_cl_normal
               aes(fill=deciles_frpl), alpha=0.25) +
  labs(title="Figure. State Revenue Amount Per Student (FRPL) (NO CWI)",
       subtitle = "Regression adjusted for difference of cost factors including district size, 
       urbanicity/locale, and percent of students enrolled in 
       special education and classified as limited English proficient",
       caption="Note: High and low-poverty districts estimated at the 10th and 90th percentile 
       of district percentage of students qualifying for free and reduced price lunch, 
       with an equal number of districts in each quantile")+
  xlab("School Year (Spring)") + 
  ylab("2018 Dollars") + 
  geom_vline(xintercept = 2018, colour='#FFFFFF', linetype="dashed")+
  theme(panel.background = element_blank(), 
        legend.title = element_blank(),
        axis.line.x = element_line(color = "#D3D3D3"),
        panel.grid.major.x = element_line(color = "#D3D3D3"),
        plot.title.position = "plot",
        plot.caption =  element_markdown(hjust = 0)
        ) +
  scale_fill_manual(values=c("#4b2e83", "#85754d"), 
                    name="fill")


### LOCAL SAIPE
df_f195_loc_figure_pov <- df_f195_loc%>%
  filter(deciles_5to17==1 | deciles_5to17 == 9)%>%
  mutate(deciles_5to17 = as.factor(deciles_5to17))
  
levels(df_f195_loc_figure_pov$deciles_5to17) <- c("Low-Poverty", "High-Poverty")

ggplot(df_f195_loc_figure_pov, 
       aes(x=schyear,y=rev_adjusted, fill=deciles_5to17)) + 
  stat_summary(geom="line", fun="mean", alpha=0.5) +
  stat_summary(geom="ribbon", 
               fun.data = mean_se, #mean_cl_normal
               aes(fill=deciles_5to17), alpha=0.25) +
  labs(title="Figure. Local Revenue Amount Per Student (SAIPE)",
       subtitle = "Regression adjusted for difference of cost factors including district size, 
       urbanicity/locale, average cost of labor, and percent of students enrolled in 
       special education and classified as limited English proficient",
       caption="Note: High and low-poverty districts estimated at the 10th and 90th percentile 
       of poverty rate within the state, with an equal number of districts in each quantile")+
  xlab("School Year (Spring)") + 
  ylab("2018 Dollars") + 
  geom_vline(xintercept = 2018, colour='#FFFFFF', linetype="dashed")+
  theme(panel.background = element_blank(), 
        legend.title = element_blank(),
        axis.line.x = element_line(color = "#D3D3D3"),
        panel.grid.major.x = element_line(color = "#D3D3D3"),
        plot.title.position = "plot",
        plot.caption =  element_markdown(hjust = 0)
        ) +
  scale_fill_manual(values=c("#4b2e83", "#85754d"), 
                    name="fill")

ggplot(df_f195_loc_figure_pov, 
       aes(x=schyear,y=rev_adjusted_nocwi, fill=deciles_5to17)) + 
  stat_summary(geom="line", fun="mean", alpha=0.5) +
  stat_summary(geom="ribbon", 
               fun.data = mean_se, #mean_cl_normal
               aes(fill=deciles_5to17), alpha=0.25) +
  labs(title="Figure. Local Revenue Amount Per Student (SAIPE) (NO CWI)",
       subtitle = "Regression adjusted for difference of cost factors including district size, 
       urbanicity/locale, and percent of students enrolled in 
       special education and classified as limited English proficient",
       caption="Note: High and low-poverty districts estimated at the 10th and 90th percentile 
       of poverty rate within the state, with an equal number of districts in each quantile")+
  xlab("School Year (Spring)") + 
  ylab("2018 Dollars") + 
  geom_vline(xintercept = 2018, colour='#FFFFFF', linetype="dashed")+
  theme(panel.background = element_blank(), 
        legend.title = element_blank(),
        axis.line.x = element_line(color = "#D3D3D3"),
        panel.grid.major.x = element_line(color = "#D3D3D3"),
        plot.title.position = "plot",
        plot.caption =  element_markdown(hjust = 0)
        ) +
  scale_fill_manual(values=c("#4b2e83", "#85754d"), 
                    name="fill")

#LOCAL FRPL

df_f195_loc_figure_pov <- df_f195_loc%>%
  filter(deciles_frpl==1 | deciles_frpl == 9)%>%
  mutate(deciles_frpl = as.factor(deciles_frpl))

levels(df_f195_loc_figure_pov$deciles_frpl) <- c("Low-Poverty", "High-Poverty")

ggplot(df_f195_loc_figure_pov, 
       aes(x=schyear,y=rev_adjusted, fill=deciles_frpl)) + 
  stat_summary(geom="line", fun="mean", alpha=0.5) +
  stat_summary(geom="ribbon", 
               fun.data = mean_se, #mean_cl_normal
               aes(fill=deciles_frpl), alpha=0.25) +
  labs(title="Figure. Local Revenue Amount Per Student (FRPL)",
       subtitle = "Regression adjusted for difference of cost factors including district size, 
       urbanicity/locale, and percent of students enrolled in 
       special education and classified as limited English proficient",
       caption="Note: High and low-poverty districts estimated at the 10th and 90th percentile 
       of district percentage of students qualifying for free and reduced price lunch, 
       with an equal number of districts in each quantile")+
  xlab("School Year (Spring)") + 
  ylab("2018 Dollars") + 
  geom_vline(xintercept = 2018, colour='#FFFFFF', linetype="dashed")+
  theme(panel.background = element_blank(), 
        legend.title = element_blank(),
        axis.line.x = element_line(color = "#D3D3D3"),
        panel.grid.major.x = element_line(color = "#D3D3D3"),
        plot.title.position = "plot",
        plot.caption =  element_markdown(hjust = 0)
        ) +
  scale_fill_manual(values=c("#4b2e83", "#85754d"), 
                    name="fill")

ggplot(df_f195_loc_figure_pov, 
       aes(x=schyear,y=rev_adjusted_nocwi, fill=deciles_frpl)) + 
  stat_summary(geom="line", fun="mean", alpha=0.5) +
  stat_summary(geom="ribbon", 
               fun.data = mean_se, #mean_cl_normal
               aes(fill=deciles_frpl), alpha=0.25) +
  labs(title="Figure. Local Revenue Amount Per Student (FRPL) (NO CWI)",
       subtitle = "Regression adjusted for difference of cost factors including district size, 
       urbanicity/locale, and percent of students enrolled in 
       special education and classified as limited English proficient",
       caption="Note: High and low-poverty districts estimated at the 10th and 90th percentile 
       of district percentage of students qualifying for free and reduced price lunch, 
       with an equal number of districts in each quantile")+
  xlab("School Year (Spring)") + 
  ylab("2018 Dollars") + 
  geom_vline(xintercept = 2018, colour='#FFFFFF', linetype="dashed")+
  theme(panel.background = element_blank(), 
        legend.title = element_blank(),
        axis.line.x = element_line(color = "#D3D3D3"),
        panel.grid.major.x = element_line(color = "#D3D3D3"),
        plot.title.position = "plot",
        plot.caption =  element_markdown(hjust = 0)
        ) +
  scale_fill_manual(values=c("#4b2e83", "#85754d"), 
                    name="fill")

### TOTAL SAIPE
df_f195_total_figure_pov <- df_f195_total%>%
  filter(deciles_5to17==1 | deciles_5to17 == 9)%>%
  mutate(deciles_5to17 = as.factor(deciles_5to17))
  
levels(df_f195_total_figure_pov$deciles_5to17) <- c("Low-Poverty", "High-Poverty")

ggplot(df_f195_total_figure_pov, 
       aes(x=schyear,y=rev_adjusted, fill=deciles_5to17)) + 
  stat_summary(geom="line", fun="mean", alpha=0.5) +
  stat_summary(geom="ribbon", 
               fun.data = mean_se, #mean_cl_normal
               aes(fill=deciles_5to17), alpha=0.25) +
  labs(title="Figure. Total Revenue Amount Per Student (SAIPE)",
       subtitle = "Regression adjusted for difference of cost factors including district size, 
       urbanicity/locale, average cost of labor, and percent of students enrolled in 
       special education and classified as limited English proficient",
       caption="Note: High and low-poverty districts estimated at the 10th and 90th percentile 
       of poverty rate within the state, with an equal number of districts in each quantile")+
  xlab("School Year (Spring)") + 
  ylab("2018 Dollars") + 
  geom_vline(xintercept = 2018, colour='#FFFFFF', linetype="dashed")+
  theme(panel.background = element_blank(), 
        legend.title = element_blank(),
        axis.line.x = element_line(color = "#D3D3D3"),
        panel.grid.major.x = element_line(color = "#D3D3D3"),
        plot.title.position = "plot",
        plot.caption =  element_markdown(hjust = 0)
        ) +
  scale_fill_manual(values=c("#4b2e83", "#85754d"), 
                    name="fill")

ggplot(df_f195_total_figure_pov, 
       aes(x=schyear,y=rev_adjusted_nocwi, fill=deciles_5to17)) + 
  stat_summary(geom="line", fun="mean", alpha=0.5) +
  stat_summary(geom="ribbon", 
               fun.data = mean_se, #mean_cl_normal
               aes(fill=deciles_5to17), alpha=0.25) +
  labs(title="Figure. Total Revenue Amount Per Student (SAIPE) (NO CWI)",
       subtitle = "Regression adjusted for difference of cost factors including district size, 
       urbanicity/locale, and percent of students enrolled in 
       special education and classified as limited English proficient",
       caption="Note: High and low-poverty districts estimated at the 10th and 90th percentile 
       of poverty rate within the state, with an equal number of districts in each quantile")+
  xlab("School Year (Spring)") + 
  ylab("2018 Dollars") + 
  geom_vline(xintercept = 2018, colour='#FFFFFF', linetype="dashed")+
  theme(panel.background = element_blank(), 
        legend.title = element_blank(),
        axis.line.x = element_line(color = "#D3D3D3"),
        panel.grid.major.x = element_line(color = "#D3D3D3"),
        plot.title.position = "plot",
        plot.caption =  element_markdown(hjust = 0)
        ) +
  scale_fill_manual(values=c("#4b2e83", "#85754d"), 
                    name="fill")

#TOTAL FRPL

df_f195_total_figure_pov <- df_f195_total%>%
  filter(deciles_frpl==1 | deciles_frpl == 9)%>%
  mutate(deciles_frpl = as.factor(deciles_frpl))

levels(df_f195_total_figure_pov$deciles_frpl) <- c("Low-Poverty", "High-Poverty")

ggplot(df_f195_total_figure_pov, 
       aes(x=schyear,y=rev_adjusted, fill=deciles_frpl)) + 
  stat_summary(geom="line", fun="mean", alpha=0.5) +
  stat_summary(geom="ribbon", 
               fun.data = mean_se, #mean_cl_normal
               aes(fill=deciles_frpl), alpha=0.25) +
  labs(title="Figure. Total Revenue Amount Per Student (FRPL)",
       subtitle = "Regression adjusted for difference of cost factors including district size, 
       urbanicity/locale, and percent of students enrolled in 
       special education and classified as limited English proficient",
       caption="Note: High and low-poverty districts estimated at the 10th and 90th percentile 
       of district percentage of students qualifying for free and reduced price lunch, 
       with an equal number of districts in each quantile")+
  xlab("School Year (Spring)") + 
  ylab("2018 Dollars") + 
  geom_vline(xintercept = 2018, colour='#FFFFFF', linetype="dashed")+
  theme(panel.background = element_blank(), 
        legend.title = element_blank(),
        axis.line.x = element_line(color = "#D3D3D3"),
        panel.grid.major.x = element_line(color = "#D3D3D3"),
        plot.title.position = "plot",
        plot.caption =  element_markdown(hjust = 0)
        ) +
  scale_fill_manual(values=c("#4b2e83", "#85754d"), 
                    name="fill")

ggplot(df_f195_total_figure_pov, 
       aes(x=schyear,y=rev_adjusted_nocwi, fill=deciles_frpl)) + 
  stat_summary(geom="line", fun="mean", alpha=0.5) +
  stat_summary(geom="ribbon", 
               fun.data = mean_se, #mean_cl_normal
               aes(fill=deciles_frpl), alpha=0.25) +
  labs(title="Figure. Total Revenue Amount Per Student (FRPL) (NO CWI)",
       subtitle = "Regression adjusted for difference of cost factors including district size, 
       urbanicity/locale, and percent of students enrolled in 
       special education and classified as limited English proficient",
       caption="Note: High and low-poverty districts estimated at the 10th and 90th percentile 
       of district percentage of students qualifying for free and reduced price lunch, 
       with an equal number of districts in each quantile")+
  xlab("School Year (Spring)") + 
  ylab("2018 Dollars") + 
  geom_vline(xintercept = 2018, colour='#FFFFFF', linetype="dashed")+
  theme(panel.background = element_blank(), 
        legend.title = element_blank(),
        axis.line.x = element_line(color = "#D3D3D3"),
        panel.grid.major.x = element_line(color = "#D3D3D3"),
        plot.title.position = "plot",
        plot.caption =  element_markdown(hjust = 0)
        ) +
  scale_fill_manual(values=c("#4b2e83", "#85754d"), 
                    name="fill")

```

## Revenue Breakdown by Category

```{r B1_revenue_breakdown_pov}

df_f195_cat <- df_f195%>%
  mutate(rev_category = case_when(
    str_detect(item_desc, regex("\\bTOTAL FEDERAL, GENERAL PURPOSE\\b", ignore_case=FALSE)) ~ "Federal",                          
    str_detect(item_desc, regex("\\bTOTAL FEDERAL, SPECIAL PURPOSE\\b", ignore_case=FALSE)) ~ "Federal",
    str_detect(item_desc, regex("\\bTOTAL STATE, GENERAL PURPOSE\\b", ignore_case=FALSE)) ~ "State",                                
    str_detect(item_desc, regex("\\bTOTAL STATE, SPECIAL PURPOSE\\b", ignore_case=FALSE)) ~ "State",
    str_detect(item_desc, regex("\\bTOTAL LOCAL SUPPORT NONTAX\\b", ignore_case=FALSE)) ~ "Local",                                    
    str_detect(item_desc, regex("\\bTOTAL LOCAL TAXES\\b", ignore_case=FALSE)) ~ "Local",                                             
    str_detect(item_desc, regex("\\bTOTAL OTHER FINANCING SOURCES\\b", ignore_case=FALSE)) ~ "Other",                           
    str_detect(item_desc, regex("\\bTOTAL REVENUES FROM OTHER ENTITIES\\b", ignore_case=FALSE)) ~ "Other",                            
    str_detect(item_desc, regex("\\bTOTAL REVENUES FROM OTHER SCHOOL DISTRICTS\\b", ignore_case=FALSE)) ~ "Other",   
    TRUE ~ NA_character_
    )
  )

df_f195_cat <- df_f195_cat%>%
  fill(rev_category, .direction = "down")%>%
  filter(amount>0)

df_f195_all_cwi<- full_join(df_f195_cat, df_cwi_cpi, by=c("CCDDD"="coudis_s", "year"="schyear"))
df_f195_all_merge_raw <- full_join(df_f195_all_cwi, df_demos_dist, by=c("CCDDD"="coudis_s", "year"="schyear"))

df_f195_all_merge <- df_f195_all_merge_raw%>%
  filter(!str_detect(item_desc, "\\bTOTAL FEDERAL, GENERAL PURPOSE\\b"),
         !str_detect(item_desc, "\\bTOTAL FEDERAL, SPECIAL PURPOSE\\b"),
         !str_detect(item_desc, "\\bTOTAL LOCAL SUPPORT NONTAX\\b"),
         !str_detect(item_desc, "\\bTOTAL LOCAL TAXES\\b"),
         !str_detect(item_desc, "\\bTOTAL STATE, GENERAL PURPOSE\\b"),
         !str_detect(item_desc, "\\bTOTAL STATE, SPECIAL PURPOSE\\b"),
         !str_detect(item_desc, "\\TOTAL OTHER FINANCING SOURCES\\b"),
         !str_detect(item_desc, "\\TOTAL REVENUES FROM OTHER ENTITIES\\b"),
         !str_detect(item_desc, "\\TOTAL REVENUES FROM OTHER SCHOOL DISTRICTS\\b"))

#### POV

df_f195_all_merge_pov <- df_f195_all_merge%>%
  drop_na(deciles_frpl)%>%
  filter(year == 2019)%>%
  filter(deciles_frpl==1 | deciles_frpl == 9)%>%
  mutate(deciles_frpl = as.factor(deciles_frpl),
         amount_pp = (amount/TotalEnrollment))

levels(df_f195_all_merge_pov$deciles_frpl) <- c("Low-Poverty", "High-Poverty")

df_f195_all_merge_pov_sum <- df_f195_all_merge_pov%>%
  group_by(CCDDD, item_desc, deciles_frpl, rev_category)%>%
  summarize(amount_pp_total=sum(amount_pp))

df_f195_all_merge_pov_avg <- df_f195_all_merge_pov_sum %>%
  group_by(deciles_frpl, item_desc)%>%
  summarize(amount_pp_avg=mean(amount_pp_total),
            rev_category=rev_category)

df_f195_all_merge_pov_avg%>%
  filter(item_desc!="NA",
         amount_pp_avg > 100)%>%
    ggplot(aes(reorder(item_desc, amount_pp_avg), 
        y=amount_pp_avg, fill=rev_category, group=deciles_frpl)) +
  geom_bar(position = position_dodge(width=0.5), stat="identity")+
  coord_flip()+
  theme(panel.background = element_blank(), 
        axis.line.x = element_line(color = "#D3D3D3"),
        panel.grid.major.x = element_line(color = "#D3D3D3"),
        plot.title.position = "plot"
        ) +
  labs(title="Figure. Average Per-Student Dollar Amount by All Revenue Categories, 2018-2019",
       subtitle="By High and Low-Poverty District (FRPL)",
       caption="Note: High and low-poverty districts estimated at the 10th and 90th percentile 
       of district percentage of students qualifying for free and reduced price lunch, 
       with an equal number of districts in each quantile")+
  scale_fill_discrete(limits = c("Federal", "State", "Local", "Other"))+
  xlab("") + 
  ylab("") + 
  facet_wrap(~deciles_frpl,
             nrow=1)
```

- Poverty defined using US Census SAIPE District Estimates for 2019 and percentage of students receiving free and reduced price lunch
- SAIPE poverty percentage calculated by (Estimated Number of Relevant Children 5 to 17 years old in Poverty Related to the Householder/Population of Relevant Children 5 to 17 years of Age)
- Plots include the mean with standard error bars of adjusted dollar values for each revenue source  

# B2: Revenue source for districts serving students of color

## Revenue Source by Time
```{r B2_revenue_time_soc}

#NOTE: NEED AT ADD 2020

ggplot(df_f195_fed, 
       aes(x=schyear, y=rev_adjusted, group=dist_group_soc)) +
  stat_summary(aes(colour=dist_group_soc), fun=mean, geom="line")+
  theme(panel.background = element_blank(), 
        axis.line.x = element_line(color = "#D3D3D3"),
        panel.grid.major.x = element_line(color = "#D3D3D3"),
        plot.title.position = "plot"
        ) +
  labs(title="Figure. Federal Revenue Amount Per Student",
       subtitle = "Regression adjusted for difference of cost factors including district size, 
       urbanicity/locale, average cost of labor, and percent of students enrolled in 
       special education and classified as limited English proficient")+
  xlab("School Year (Spring)") + 
  ylab("2018 Dollars") + 
  geom_vline(xintercept = 2018, colour='#FFFFFF', linetype="dashed")+
  labs(color="Student of Color \nPercentage") 

####
ggplot(df_f195_state, 
       aes(x=schyear, y=rev_adjusted, group=dist_group_soc)) +
  stat_summary(aes(colour=dist_group_soc), fun=mean, geom="line")+
  theme(panel.background = element_blank(), 
        axis.line.x = element_line(color = "#D3D3D3"),
        panel.grid.major.x = element_line(color = "#D3D3D3"),
        plot.title.position = "plot"
        ) +
  labs(title="Figure. State Revenue Amount Per Student",
       subtitle = "Regression adjusted for difference of cost factors including district size, 
       urbanicity/locale, average cost of labor, and percent of students enrolled in 
       special education and classified as limited English proficient")+
  xlab("School Year (Spring)") + 
  ylab("2018 Dollars") + 
  geom_vline(xintercept = 2018, colour='#FFFFFF', linetype="dashed")+
  labs(color="Student of Color \nPercentage") 

####

ggplot(df_f195_loc, 
       aes(x=schyear, y=rev_adjusted, group=dist_group_soc)) +
  stat_summary(aes(colour=dist_group_soc), fun=mean, geom="line")+
  theme(panel.background = element_blank(), 
        axis.line.x = element_line(color = "#D3D3D3"),
        panel.grid.major.x = element_line(color = "#D3D3D3"),
        plot.title.position = "plot"
        ) +
  labs(title="Figure. Local Revenue Amount Per Student",
       subtitle = "Regression adjusted for difference of cost factors including district size, 
       urbanicity/locale, average cost of labor, and percent of students enrolled in 
       special education and classified as limited English proficient")+
  xlab("School Year (Spring)") + 
  ylab("2018 Dollars") + 
  geom_vline(xintercept = 2018, colour='#FFFFFF', linetype="dashed")+
  labs(color="Student of Color \nPercentage") 

```

## Revenue Breakdown by Category

```{r B2_revenue_breakdown_soc}

df_f195_all_merge <- df_f195_all_merge%>%
  filter(year == 2019)%>% 
  drop_na(dist_group_soc)%>%
  mutate(dist_group_soc = as.factor(dist_group_soc),
         amount_pp = (amount/TotalEnrollment))

levels(df_f195_all_merge$dist_group_soc) <- c("0-24%","25-49%","50-74%", "75-100%")

df_f195_all_merge_sum <- df_f195_all_merge%>%
  group_by(CCDDD, item_desc, dist_group_soc, rev_category)%>%
  summarize(amount_pp_total=sum(amount_pp))

df_f195_all_merge_avg <- df_f195_all_merge_sum %>%
  group_by(dist_group_soc, item_desc)%>%
  summarize(amount_pp_avg=mean(amount_pp_total),
            rev_category=rev_category)

df_f195_all_merge_avg%>%
  filter(item_desc!="NA",
         amount_pp_avg > 100)%>%
  ggplot(aes(reorder(item_desc, amount_pp_avg), 
        y=amount_pp_avg, fill=rev_category)) +
  geom_bar(position = position_dodge(width=0.5), stat="identity")+
  coord_flip()+
  theme(panel.background = element_blank(), 
        axis.line.x = element_line(color = "#D3D3D3"),
        panel.grid.major.x = element_line(color = "#D3D3D3"),
        plot.title.position = "plot"
        ) +
  labs(title="Figure. Average Per-Student Dollar Amount by All Revenue Categories, 2018-2019")+
  scale_fill_discrete(limits = c("Federal", "State", "Local", "Other"))+
  xlab("") + 
  ylab("")

df_f195_all_merge_avg%>%
  filter(item_desc!="NA",
         amount_pp_avg > 100)%>%
    ggplot(aes(reorder(item_desc, amount_pp_avg), 
        y=amount_pp_avg, fill=rev_category, group=dist_group_soc)) +
  geom_bar(position = position_dodge(width=0.5), stat="identity")+
  coord_flip()+
  theme(panel.background = element_blank(), 
        axis.line.x = element_line(color = "#D3D3D3"),
        panel.grid.major.x = element_line(color = "#D3D3D3"),
        plot.title.position = "plot"
        ) +
  labs(title="Figure. Average Per-Student Dollar Amount by All Revenue Categories, 2018-2019",
       subtitle="By District Ratio Student of Color")+
  scale_fill_discrete(limits = c("Federal", "State", "Local", "Other"))+
  xlab("") + 
  ylab("") + 
  facet_wrap(~dist_group_soc,
             nrow=1)
```
        
- I didn't add error bars due to overlap. Adding would be simple if it's necessary
- More change between years across all quartiles, no consistent slope from 2015-2019
- Interesting groups for each revenue source
- Federal revenue has quartiles 1st, 2nd, 3rd grouped together below top quartile
- State has highest and lowest quartiles receiving a greater dollar amount, when mid-ranged quartiles receive less in comparison
- Local appears to be the inverse of federal, with top quartile receiving less local revenue compared to all other quartiles

# B3: Spatial distribution of school funding

```{r B3_maps_data}

library(leaidr)
library(sf)

wa <- lea_get("wa")%>% 
  sf::st_as_sf() 

df_f196_merge <- df_f196_merge_raw%>%
  filter(schyear >= 2016 & schyear <=2020)%>%
  mutate(leaid = as.character(leaid),
         rev_fed_18d_Total = rev_fed*cpi18,
         rev_fed_pp_18d=(rev_fed_18d_Total/dis_enroll),
         rev_st_pp_18d=(rev_st_18d_Total/dis_enroll),
         rev_loc_pp_18d=(localrev_201819Spring_18d/dis_enroll),
         rev_total_pp_18d=rev_fed_pp_18d+rev_st_pp_18d+rev_loc_pp_18d,
         post_mcl_reform = ifelse(schyear>= 2019, "1", "0"))

df_f196_merge <- df_f196_merge%>%
  group_by(schyear)%>%
  mutate(
    rev_fed_mean = mean(rev_fed_pp_18d, na.rm = TRUE),
    rev_st_mean = mean(rev_st_pp_18d, na.rm = TRUE), 
    rev_loc_mean = mean(rev_loc_pp_18d, na.rm = TRUE),
    rev_total_mean = mean(rev_total_pp_18d, na.rm = TRUE))

df_f196_merge <- df_f196_merge%>%
  group_by(coudis, post_mcl_reform)%>%
  mutate(rev_fed_mean_reform = mean(rev_fed_pp_18d, na.rm = TRUE), 
         rev_st_mean_reform = mean(rev_st_pp_18d, na.rm = TRUE), 
         rev_loc_mean_reform = mean(rev_loc_pp_18d, na.rm = TRUE),
         rev_total_mean_reform = mean(rev_total_pp_18d, na.rm = TRUE))

df_f196_merge <- df_f196_merge%>%
  mutate(
    rev_fed_diff= (rev_fed_pp_18d-rev_fed_mean),
    rev_st_diff= (rev_st_pp_18d-rev_st_mean),
    rev_loc_diff=(rev_loc_pp_18d-rev_loc_mean),
    rev_total_diff=(rev_total_pp_18d-rev_total_mean))

mccleary_revenue <- collap(df_f196_merge, rev_fed_mean_reform + rev_st_mean_reform + rev_loc_mean_reform + rev_total_mean_reform~ leaid + post_mcl_reform, 
                           FUN = list(fmean))

mccleary_rev_wide <- mccleary_revenue%>%
  group_by(leaid)%>% 
  pivot_wider(names_from = post_mcl_reform, 
              values_from = c(rev_fed_mean_reform, rev_st_mean_reform, rev_loc_mean_reform, rev_total_mean_reform))

mccleary_rev_wide <- mccleary_rev_wide%>%
  mutate(
    rev_fed_mean_reform_diff = (rev_fed_mean_reform_1 - rev_fed_mean_reform_0),
    rev_st_mean_reform_diff = (rev_st_mean_reform_1 - rev_st_mean_reform_0),
    rev_loc_mean_reform_diff = (rev_loc_mean_reform_1 - rev_loc_mean_reform_0),
    rev_total_mean_reform_diff = (rev_total_mean_reform_1 - rev_total_mean_reform_0))

wa_df196 <- left_join(df_f196_merge, wa, by = c("leaid" = "GEOID"), copy=TRUE) 

wa_mccleary_rev_wide <- left_join(mccleary_rev_wide, wa, by = c("leaid" = "GEOID"), copy=TRUE) 

#What percentage higher than lower than state average for the state/local revenue
#Distribution of dollars -> district that serve large % of SOC/low-income

```

## Demographic Maps
```{r B3_maps_demo}

#Demographic Maps

wa_df196 %>%
  sf::st_as_sf() %>% 
  filter(schyear==2019)%>%
  ggplot() +
  geom_sf(aes(fill = PctHispanic), size = .25) +
  scale_fill_gradient2(low="#FFFFFF", high="#4b2e83", name="Percentage") +
  theme_void() +
  labs(title="Figure. Latinx Students Percentage of Total Student Enrollment, 2018-2019 ")+
  theme(plot.title = element_text(hjust = 0.5))

wa_df196 %>%
  sf::st_as_sf() %>% 
  filter(schyear==2019)%>%
  ggplot() +
  geom_sf(aes(fill = PctBlack), size = .25) +
  scale_fill_gradient2(low="#FFFFFF", high="#4b2e83", name="Percentage") +
  theme_void() +
  labs(title="Figure. Black Students Percentage of Total Student Enrollment, 2018-2019 ")+
  theme(plot.title = element_text(hjust = 0.5))

wa_df196 %>%
  sf::st_as_sf() %>% 
  filter(schyear==2019)%>%
  ggplot() +
  geom_sf(aes(fill = PctAmericanIndianOrAlaskan), size = .25) +
  scale_fill_gradient2(low="#FFFFFF", high="#4b2e83", name="Percentage") +
  theme_void() +
  labs(title="Figure. Indigenous Students Percentage of Total Student Enrollment, 2018-2019 ")+
  theme(plot.title = element_text(hjust = 0.5))

wa_df196 %>%
  sf::st_as_sf() %>% 
  filter(schyear==2019)%>%
  ggplot() +
  geom_sf(aes(fill = PctAsian), size = .25) +
  scale_fill_gradient2(low="#FFFFFF", high="#4b2e83", name="Percentage") +
  theme_void() +
  labs(title="Figure. Asian Students Percentage of Total Student Enrollment, 2018-2019 ")+
  theme(plot.title = element_text(hjust = 0.5))

wa_df196 %>%
  sf::st_as_sf() %>% 
  filter(schyear==2019)%>%
  ggplot() +
  geom_sf(aes(fill = PctMultirac), size = .25) +
  scale_fill_gradient2(low="#FFFFFF", high="#4b2e83", name="Percentage") +
  theme_void() +
  labs(title="Figure. Multiracial Students Percentage of Total Student Enrollment, 2018-2019 ")+
  theme(plot.title = element_text(hjust = 0.5))

```

## Revenue Maps
```{r B3_maps_rev}

#Need to figure out what colors work best with this map to make it pop

wa_df196 %>%
  sf::st_as_sf() %>% 
  filter(schyear==2019)%>%
  ggplot() +
  geom_sf(aes(fill = rev_fed_pp_18d), size = .25) +
  scale_fill_gradient2(low="#FFFFFF", high="#4b2e83", name="2018 Dollars") +
  theme_void() +
  labs(title="Figure. Federal Revenue Per Pupil, 2018-2019")+
  theme(plot.title = element_text(hjust = 0.5))

wa_df196 %>%
  sf::st_as_sf() %>% 
  filter(schyear==2019)%>%
  ggplot() +
  geom_sf(aes(fill = rev_st_pp_18d), size = .25) +
  scale_fill_gradient2(low="#FFFFFF", high="#4b2e83", name="2018 Dollars") +
  theme_void() +
  labs(title="Figure. State Revenue Per Pupil, 2018-2019")+
  theme(plot.title = element_text(hjust = 0.5))

wa_df196 %>%
  sf::st_as_sf() %>% 
  filter(schyear==2019)%>%
  ggplot() +
  geom_sf(aes(fill = rev_loc_pp_18d), size = .25) +
  scale_fill_gradient2(low="#FFFFFF", high="#4b2e83", name="2018 Dollars") +
  theme_void() +
  labs(title="Figure. Local Levy Revenue Per Pupil, 2018-2019")+
  theme(plot.title = element_text(hjust = 0.5))

wa_df196 %>%
  sf::st_as_sf() %>% 
  filter(schyear==2019)%>%
  ggplot() +
  geom_sf(aes(fill = rev_total_pp_18d), size = .25) +
  scale_fill_gradient2(low="#FFFFFF", high="#4b2e83", name="2018 Dollars") +
  theme_void() +
  labs(title="Figure. Total Revenue Per Pupil, 2018-2019")+
  theme(plot.title = element_text(hjust = 0.5))

wa_df196 %>%
  sf::st_as_sf() %>% 
  filter(schyear==2019)%>%
  ggplot() +
  geom_sf(aes(fill = rev_fed_diff), size = .25) +
  scale_fill_gradient2(low="#FF0000", midpoint = 0, mid="#FFFFFF", high="#4b2e83", name="2018 Dollars") +
  theme_void() +
  labs(title="Figure. Federal Revenue Per Pupil, 2018-2019",
       subtitle = "Dollar Difference Against State Mean for the School Year")+
  theme(plot.title = element_text(hjust = 0.5),
        plot.subtitle = element_text(hjust = 0.5))

wa_df196 %>%
  sf::st_as_sf() %>% 
  filter(schyear==2019)%>%
  ggplot() +
  geom_sf(aes(fill = rev_st_diff), size = .25) +
  scale_fill_gradient2(low="#FF0000", midpoint = 0, mid="#FFFFFF", high="#4b2e83", name="2018 Dollars") +
  theme_void() +
  labs(title="Figure. State Revenue Per Pupil, 2018-2019",
       subtitle = "Dollar Difference Against State Mean for the School Year")+
  theme(plot.title = element_text(hjust = 0.5),
        plot.subtitle = element_text(hjust = 0.5))

wa_df196 %>%
  sf::st_as_sf() %>% 
  filter(schyear==2019)%>%
  ggplot() +
  geom_sf(aes(fill = rev_loc_diff), size = .25) +
  scale_fill_gradient2(low="#FF0000", midpoint = 0, mid="#FFFFFF", high="#4b2e83", name="2018 Dollars") +
  theme_void() +
  labs(title="Figure. Local Levy Revenue Per Pupil, 2018-2019",
       subtitle = "Dollar Difference Against State Mean for the School Year")+
  theme(plot.title = element_text(hjust = 0.5),
        plot.subtitle = element_text(hjust = 0.5))

wa_df196 %>%
  sf::st_as_sf() %>% 
  filter(schyear==2019)%>%
  ggplot() +
  geom_sf(aes(fill = rev_total_diff), size = .25) +
  scale_fill_gradient2(low="#FF0000", midpoint = 0, mid="#FFFFFF", high="#4b2e83", name="2018 Dollars") +
  theme_void() +
  labs(title="Figure. Total Revenue Per Pupil, 2018-2019",
       subtitle = "Dollar Difference Against State Mean for the School Year")+
  theme(plot.title = element_text(hjust = 0.5),
        plot.subtitle = element_text(hjust = 0.5))
```


## McCleary Maps
```{r B3_maps_mccleary}

wa_mccleary_rev_wide %>%
  sf::st_as_sf() %>% 
  ggplot() +
  geom_sf(aes(fill = rev_fed_mean_reform_diff), size = .25) +
  scale_fill_gradient2(low="#FF0000", midpoint = 0, mid="#FFFFFF", high="#4b2e83", name="2018 Dollars") +
  theme_void() +
  labs(title="Figure. Federal Revenue Difference Post-McCleary Reform",
       subtitle = "Between Spring SY 2016-2018 (3 Year Average) and 2019-2020 (2 Year Average)")+
  theme(plot.title = element_text(hjust = 0.5),
        plot.subtitle = element_text(hjust = 0.5))

wa_mccleary_rev_wide %>%
  sf::st_as_sf() %>% 
  ggplot() +
  geom_sf(aes(fill = rev_st_mean_reform_diff), size = .25) +
  scale_fill_gradient2(low="#FF0000", midpoint = 0, mid="#FFFFFF", high="#4b2e83", name="2018 Dollars") +
  theme_void() +
  labs(title="Figure. State Revenue Difference Post-McCleary Reform",
       subtitle = "Between Spring SY 2016-2018 (3 Year Average) and 2019-2020 (2 Year Average)")+
  theme(plot.title = element_text(hjust = 0.5),
        plot.subtitle = element_text(hjust = 0.5))

wa_mccleary_rev_wide %>%
  sf::st_as_sf() %>% 
  ggplot() +
  geom_sf(aes(fill = rev_loc_mean_reform_diff), size = .25) +
  scale_fill_gradient2(low="#FF0000", midpoint = 0, mid="#FFFFFF", high="#4b2e83", name="2018 Dollars") +
  theme_void() +
  labs(title="Figure. Local Revenue Difference Post-McCleary Reform",
       subtitle = "Between Spring SY 2016-2018 (3 Year Average) and 2019-2020 (2 Year Average)")+
  theme(plot.title = element_text(hjust = 0.5),
        plot.subtitle = element_text(hjust = 0.5))

wa_mccleary_rev_wide %>%
  sf::st_as_sf() %>% 
  ggplot() +
  geom_sf(aes(fill = rev_total_mean_reform_diff), size = .25) +
  scale_fill_gradient2(low="#FF0000", midpoint = 0, mid="#FFFFFF", high="#4b2e83", name="2018 Dollars") +
  theme_void() +
  labs(title="Figure. Total Revenue Difference Post-McCleary Reform",
       subtitle = "Between Spring SY 2016-2018 (3 Year Average) and 2019-2020 (2 Year Average)")+
  theme(plot.title = element_text(hjust = 0.5),
        plot.subtitle = element_text(hjust = 0.5))

```

- Difference is calculated as % change in revenue per pupil over 3 year period (2015-16, 2016-17, 2017-18, 3 year average) to difference of the two year average (2018-19 and 19-2020), divided by average of pre-McCleary as base to get percentage change

# B4: Expenditure categories 

```{r B4_expenditures_soc}

df_e_2020 <- df_e_merge_raw%>%
  filter(schyear == 2020)%>% 
  drop_na(dist_group_soc)%>%
  mutate(dist_group_soc = as.factor(dist_group_soc),
         amount_pp = (amount/TotalEnrollment))

levels(df_e_2020$dist_group_soc) <- c("0-24%","25-49%","50-74%", "75-100%")

df_e_2020_sum = df_e_2020%>%
  group_by(coudis_s, prog_desc, dist_group_soc)%>%
  summarize(amount_pp_total=sum(amount_pp))

df_e_2020_avg = df_e_2020_sum %>%
  group_by(dist_group_soc, prog_desc)%>%
  summarize(amount_pp_avg=mean(amount_pp_total))

df_e_2020_avg%>%
  filter(prog_desc!="NA")%>%
  ggplot(
    aes(reorder(prog_desc, amount_pp_avg, sum), 
        amount_pp_avg)) +
  geom_bar(position="dodge", stat="identity")+
  coord_flip()+
  theme(panel.background = element_blank(), 
        axis.line.x = element_line(color = "#D3D3D3"),
        panel.grid.major.x = element_line(color = "#D3D3D3"),
        plot.title.position = "plot"
        ) +
  labs(title="Figure. Average Per-Student Dollar Amount by All Expenditure Categories, 2019-2020")+
  xlab("") + 
  ylab("")

df_e_2020_avg%>%
  filter(prog_desc!="Basic Education" & prog_desc!="Districtwide Support")%>% #Remove basic education program and Districtwide support
  ggplot(
    aes(reorder(prog_desc, amount_pp_avg, sum), 
        amount_pp_avg)) +
  geom_bar(position="dodge", stat="identity")+
  coord_flip()+
  theme(panel.background = element_blank(), 
        axis.line.x = element_line(color = "#D3D3D3"),
        panel.grid.major.x = element_line(color = "#D3D3D3"),
        plot.title.position = "plot"
        ) +
  labs(title="Figure. Average Per-Student Dollar Amount by Expenditure Category, 2019-2020",
       subtitle = "Excluding Top Two Categories (Basic Education and Districtwide Support) ")+
  xlab("") + 
  ylab("")

#REVIEW: 
#Which expenditure category to focus on (filter by federal, state, others)? 
#Do we want to cut off the categories with minimal amounts? 
#Group the bottom chunk with OTHER category
#look a regionalization factor

df_e_2020_avg%>%
  filter(prog_desc!="NA")%>% 
  ggplot(
    aes(reorder(prog_desc, amount_pp_avg, sum), 
        amount_pp_avg, 
        group=dist_group_soc,
        fill=dist_group_soc)) +
  geom_bar(position="dodge", stat="identity")+
  coord_flip()+
  theme(panel.background = element_blank(), 
        axis.line.x = element_line(color = "#D3D3D3"),
        panel.grid.major.x = element_line(color = "#D3D3D3"),
        plot.title.position = "plot",
        legend.position="none") +
  labs(title = "Figure. Average Per-Student Dollar Amount by Expenditure Category, 2019-2020",
       subtitle = "By District Percentage Student of Color")+
  xlab("") + 
  ylab("") +
  facet_wrap(~dist_group_soc,
             nrow=1)

df_e_2020_avg%>%
  filter(prog_desc!="Basic Education" & prog_desc!="Districtwide Support")%>% #Remove basic education program and Districtwide support
  ggplot(
    aes(reorder(prog_desc, amount_pp_avg, sum), 
        amount_pp_avg, 
        group=dist_group_soc,
        fill=dist_group_soc)) +
  geom_bar(position="dodge", stat="identity")+
  coord_flip()+
  theme(panel.background = element_blank(), 
        axis.line.x = element_line(color = "#D3D3D3"),
        panel.grid.major.x = element_line(color = "#D3D3D3"),
        plot.title.position = "plot",
        legend.position="none") +
  labs(title = "Figure. Average Per-Student Dollar Amount by Expenditure Category, 2019-2020",
       subtitle = "By District Percentage Student of Color and Excluding Top Two Categories ")+
  xlab("") + 
  ylab("") +
  facet_wrap(~dist_group_soc,
             nrow=1)
#REVIEW:
#Same questions as above.
#I separated SOC into quartiles, do we want to categorize them differently? What's both interesting and consumable? 

```

```{r B4_expenditures_pov}

df_e_2020_pov <- df_e_merge_raw%>%
  filter(deciles_frpl==1 | deciles_frpl == 9)%>%
  filter(schyear == 2020)%>% 
  drop_na(deciles_frpl)%>%
  mutate(deciles_frpl = as.factor(deciles_frpl),
         amount_pp = (amount/TotalEnrollment))

levels(df_e_2020_pov$deciles_frpl) <- c("Low-Poverty", "High-Poverty")

df_e_2020_pov_sum <- df_e_2020_pov%>%
  group_by(coudis_s, prog_desc, deciles_frpl)%>%
  summarize(amount_pp_total=sum(amount_pp))

df_e_2020_pov_avg <- df_e_2020_pov_sum %>%
  group_by(deciles_frpl, prog_desc)%>%
  summarize(amount_pp_avg=mean(amount_pp_total))

df_e_2020_pov_avg%>%
  filter(prog_desc!="NA")%>% 
  ggplot(
    aes(reorder(prog_desc, amount_pp_avg, sum), 
        amount_pp_avg, 
        group=deciles_frpl,
        fill=deciles_frpl)) +
  geom_bar(position="dodge", stat="identity")+
  coord_flip()+
  theme(panel.background = element_blank(), 
        axis.line.x = element_line(color = "#D3D3D3"),
        panel.grid.major.x = element_line(color = "#D3D3D3"),
        plot.title.position = "plot",
        legend.position="none") +
  labs(title = "Figure. Average Per-Student Dollar Amount by Expenditure Category, 2019-2020",
       subtitle = "By District Percentage of Students Qualifying for Free and Reduced Price Lunch")+
  xlab("") + 
  ylab("") +
  facet_wrap(~deciles_frpl,
             nrow=1)

df_e_2020_pov_avg%>%
  filter(prog_desc!="Basic Education" & prog_desc!="Districtwide Support")%>% #Remove basic education program and Districtwide support
  ggplot(
    aes(reorder(prog_desc, amount_pp_avg, sum), 
        amount_pp_avg, 
        group=deciles_frpl,
        fill=deciles_frpl)) +
  geom_bar(position="dodge", stat="identity")+
  coord_flip()+
  theme(panel.background = element_blank(), 
        axis.line.x = element_line(color = "#D3D3D3"),
        panel.grid.major.x = element_line(color = "#D3D3D3"),
        plot.title.position = "plot",
        legend.position="none") +
  labs(title = "Figure. Average Per-Student Dollar Amount by Expenditure Category, 2019-2020",
       subtitle = "By District Percentage of Students Qualifying for Free and Reduced Price Lunch and Excluding Top Two Categories")+
  xlab("") + 
  ylab("") +
  facet_wrap(~deciles_frpl,
             nrow=1)


```

- We focus on the 2019-2020 school year, the second year of the McCleary reform.

