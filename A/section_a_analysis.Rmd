---
title: 'Section A: Student-level Changes during COVID-19'
author: "Alex Liu"
date: "`r format(Sys.Date(), format = '%B %d, %Y')`"
output: 
  html_document:
    toc: true
    toc_float: true
    fig_width: 8
---

```{r include=FALSE}
knitr::opts_chunk$set(echo = FALSE,
                      comment = NA, 
                      cache = TRUE,
                      warning = FALSE,
                      message = FALSE, 
                      cache.lazy = FALSE,
                      fig.align = "center"
                      )
```

* Notes 11/24
  + add plots for A3
    1. statewide breakdown by income groups for three school years
    2. statewide change between sy2018-19 and sy2020-21 by race and income 
  + pathway

**Without specific demonstration, all differences/changes are calculated by values in SY2020-21 minus values in SY2018-19. Hence, positive differences/changes indicate increase in SY2020-21 and negative differences/changes indicate decrease in SY2020-21 for all the plots in this markdown file.**

```{r data, include=FALSE}
library(tidyverse)
library(googledrive)

id_enrollment <- drive_get(as_id("https://drive.google.com/file/d/1hfVC_BgnUF6lBJYcGf6lhtMQOxEdig2v/view?usp=sharing"))
id_graduation_pathways <- drive_get(as_id("https://drive.google.com/file/d/1hgO_VNQ2DdDtPBAa_Mtdkq1JhwPSD4uI/view?usp=sharing"))
id_reopening_survey <- drive_get(as_id("https://drive.google.com/file/d/1YbyBi1LfHz36aLyVItJs6mJ4nNWxuUkd/view?usp=sharing"))
id_course_outcomes_by_student <- drive_get(as_id("https://drive.google.com/file/d/1hfA_RgRAldfsLXzH6hg776kV_x96xDgI/view?usp=sharing"))
id_course_outcomes_by_outcome <- drive_get(as_id("https://drive.google.com/file/d/1hcUTvX5xYIVyejpyS73z0Xo-64w2uRCZ/view?usp=sharing"))
id_discipline <- drive_get(as_id("https://drive.google.com/file/d/1hkh1eV3QJ0ZkJRRB1VIlUIaJDE4yYoYF/view?usp=sharing"))
id_sqss_modified <- drive_get(as_id("https://drive.google.com/file/d/1hk1CUCF0tGZuZJlon6TRr0AIsw5REsmb/view?usp=sharing"))

df_enrollment <- id_enrollment %>%
  drive_read_string() %>%
  read_csv(col_names=TRUE)
#https://data.wa.gov/Education/OSPI-Enrollment-Changes-2019-20-to-2020-21/5u4d-iirb

df_graduation_pathways <- id_graduation_pathways %>%
  drive_read_string() %>%
  read_csv(col_names=TRUE)
#https://data.wa.gov/Education/Data-Displays-Graduation-Pathways-OSPI/nxmy-bggx

df_reopening_survey <- id_reopening_survey %>%
  drive_read_string() %>%
  read_csv(col_names=TRUE)
#https://data.wa.gov/dataset/School-Facility-ReOpening-Survey/9i5d-c2m8

df_course_outcomes_by_student <- id_course_outcomes_by_student %>%
  drive_read_string() %>%
  read_csv(col_names=TRUE)
#https://data.wa.gov/Education/Student-Course-Outcomes-by-Student/f4u4-uezp

df_course_outcomes_by_outcome <- id_course_outcomes_by_outcome %>%
  drive_read_string() %>%
  read_csv(col_names=TRUE)
#https://data.wa.gov/dataset/Student-Course-Outcomes-by-Outcome/cjza-wqsm

df_discpline <- id_discipline %>%
  drive_read_string() %>%
  read_csv(col_name=TRUE)

df_sqss <- id_sqss_modified %>%
  drive_read_string() %>%
  read_csv(col_names=TRUE)
#https://data.wa.gov/Education/COVID-19-Modified-School-Year-SQSS-Data/29kb-bn26

#OSPI Suppression Rules
#https://k12.wa.us/sites/default/files/public/StudentInformation/SuppressionRulesforPublicReporting.pdf

```

```{r libraries, include=FALSE}
library(googledrive)
library(tidyverse)
library(ggplot2)
library(formattable)
library(reshape2)
library(grid)
library(gridExtra)
library(sf)
library(spData)
library(leaidr)

#library(rJava)
#library(tabulizer) 
```

```{r uw_palette, include=FALSE}
# from purple to gold (low=gold, high=purple)
uw_palette <- colorRampPalette(c("#4b2e83", "#e8e3d3"))
uw_reverse <- colorRampPalette(c("#e8e3d3", "#4b2e83"))
black_white <- colorRampPalette(c("white", "black"))
```

# A.1. Student Enrollment Both Count and Change

Students of color or low income students are further disadvantaged during the pandemic in terms of enrollment. Particularly lower grade levels

## A.1.1 Enrollment count

> A.1.1 Student Enrollment Count for Kindergarteners 6th and 9th Graders

```{r Student Enrollment Count for All Grade Levels, eval=FALSE, include=FALSE}

month_in_df <- c("October", "November", "December", "January")

enrollment_by_races <- df_enrollment %>%
  filter(StudentGroupType == "Race" | StudentGroupType == "All") %>%
  filter(Measure == "2021 Enrolled") %>%
  select(!c(StudentGroupType, Measure)) 
  
long_enroll_by_races <- melt(enrollment_by_races, 
                             id.vars = "StudentGroup",
                             measure.vars = month_in_df,
                             variable.name = "Month",
                             value.name="EnrollmentCounts") %>%
  arrange(StudentGroup, Month) 

long_enroll_by_races$Month <- factor(long_enroll_by_races$Month, 
                                     levels = c("January", "December", 
                                                "November", "October"))

plot_enroll_count <- long_enroll_by_races %>%
  filter(StudentGroup != "All Students") %>%
  ggplot(aes(fill = Month, 
             x = StudentGroup, 
             y = EnrollmentCounts)) + 
  geom_col(position="dodge", width = 0.7) +
#  facet_wrap(~Month, ncol =1)+
  ggtitle("Enrollment Counts for SY 2020-21 (All Grade Levels)") +
        labs(x = "Student Groups", 
             y = "Enrollment Counts") +
#  geom_text(aes(label = `Enrollment Counts`), position=position_dodge(width=0.9), 
#            hjust = 0.5, vjust = 0.25, colour = "black", size = 1.5) +
  scale_y_continuous(labels = comma) +
  scale_fill_manual(values = uw_palette(4))  +
  theme_light() +
  coord_flip() +
  theme(plot.title = element_text(face = "bold", size = 16, hjust = 0.5),
#        legend.background = element_rect(fill = "white", size = 4, colour = "white"),
 #       legend.justification = c(0, 1),
 #       legend.position = c(0.1, 0.75),
        axis.text.x  = element_text(angle=0, vjust=0.5, size=9),
        axis.title.x  = element_text(size=14),
        axis.title.y  = element_text(size=14),
        strip.text.x = element_text(size = 12, colour = "black")) 

plot_enroll_count

ggsave("section_a_analysis_files/figures/Student Enrollment Count for All Grade Levels.png")

``` 

```{r load grade_level enrollment data, include=FALSE}
id_enrollment_kids <- drive_get(as_id("https://drive.google.com/file/d/1lCa5ap7xqWXTslj7kEqIQfCLNX0WJf0q/view?usp=sharing"))
id_enrollment_six <- drive_get(as_id("https://drive.google.com/file/d/1KF-9IeKo7xrVJ3Ny5pUl8hKaax-expSE/view?usp=sharing"))
id_enrollment_nine <- drive_get(as_id("https://drive.google.com/file/d/1uysRPNVca71FFiTEb36cVqTzblTiwXmK/view?usp=sharing"))
id_change_enrollment_kids <- drive_get(as_id("https://drive.google.com/file/d/1oFO1A9FLJ_QPtT9IBEuiO1e6gzvRiHDI/view?usp=sharing"))
id_change_enrollment_six <- drive_get(as_id("https://drive.google.com/file/d/197DNjQPhvx4zS23C_SWInq9tw3nvoiXP/view?usp=sharing"))
id_change_enrollment_nine <- drive_get(as_id("https://drive.google.com/file/d/1SZkJZlYMDnwHtMIl0GfqhbIGXosoP9-U/view?usp=sharing"))

df_enrollment_kids <- id_enrollment_kids %>%
  drive_read_string() %>%
  read_csv(col_names=TRUE)

df_enrollment_six <- id_enrollment_six %>%
  drive_read_string() %>%
  read_csv(col_names=TRUE)

df_enrollment_nine <- id_enrollment_nine %>%
  drive_read_string() %>%
  read_csv(col_names=TRUE)

df_change_enrollment_kids <- id_change_enrollment_kids %>%
  drive_read_string() %>%
  read_csv(col_names=TRUE)

df_change_enrollment_six <- id_change_enrollment_six %>%
  drive_read_string() %>%
  read_csv(col_names=TRUE)

df_change_enrollment_nine <- id_change_enrollment_nine %>%
  drive_read_string() %>%
  read_csv(col_name=TRUE)
```

```{r A.1.i Student Enrollment Count for Kindergarteners, include=FALSE}

df_enrollment_kids[2,1] <- "All Students"
enroll_race_kids <- df_enrollment_kids %>%
  #put wrong labels when scraping
  select(c("X", "October_9th", 
           "November_9th", "December_9th", 
           "January_9th", "February_9th")) %>%
  filter(X %in% c("All Students",
                  "American Indian/ Alaskan Native",
               "Asian",
               "Black/ African American",
               "Hispanic/ Latino of any race(s)",
               "Native Hawaian/ Other Pacific Islander",
               "Two or More Races",
               "White"))

names(enroll_race_kids) <- c("Student Group", "October", "November", 
                            "December", "January", "February")

months_in_df <- c("October", "November", "December", "January", "February")
long_enroll_race_kids <- melt(enroll_race_kids, 
                             id.vars = "Student Group",
                             measure.vars = months_in_df,
                             variable.name = "Month",
                             value.name=c("Enrollment")) %>%
  arrange(`Student Group`, Month) %>%
  mutate(GradeLevel = "Kindergarten")
```

```{r A.1.ii Student Enrollment Count for 6th Graders, include=FALSE}
df_enrollment_six[2,2] <- "All Students"
enroll_race_six <- df_enrollment_six %>%
  select(c("X", "October_6th", 
           "November_6th", "December_6th", 
           "January_6th", "February_6th")) %>%
  filter(X %in% c("All Students",
                  "American Indian/ Alaskan Native",
               "Asian",
               "Black/ African American",
               "Hispanic/ Latino of any race(s)",
               "Native Hawaian/ Other Pacific Islander",
               "Two or More Races",
               "White"))

names(enroll_race_six) <- c("Student Group", "October", "November", 
                            "December", "January", "February")

months_in_df <- c("October", "November", "December", "January", "February")
long_enroll_race_six <- melt(enroll_race_six, 
                             id.vars = "Student Group",
                             measure.vars = months_in_df,
                             variable.name = "Month",
                             value.name=c("Enrollment")) %>%
  arrange(`Student Group`, Month) %>%
  mutate(GradeLevel = "Sixth Grade")
```

```{r A.1.iii Student Enrollment Count for 9th Graders, include=FALSE}

df_enrollment_nine[2,1] <- "All Students"
enroll_race_nine <- df_enrollment_nine %>%
  select(c("X", "October_9th", 
           "November_9th", "December_9th", 
           "January_9th", "February_9th")) %>%
  filter(X %in% c("All Students",
                  "American Indian/ Alaskan Native",
               "Asian",
               "Black/ African American",
               "Hispanic/ Latino of any race(s)",
               "Native Hawaian/ Other Pacific Islander",
               "Two or More Races",
               "White"))

names(enroll_race_nine) <- c("Student Group", "October", "November", 
                            "December", "January", "February")

months_in_df <- c("October", "November", "December", "January", "February")
long_enroll_race_nine <- melt(enroll_race_nine, 
                             id.vars = "Student Group",
                             measure.vars = months_in_df,
                             variable.name = "Month",
                             value.name=c("Enrollment")) %>%
  arrange(`Student Group`, Month) %>%
  mutate(GradeLevel = "Ninth Grade")
```

```{r A.1.1 Student Enrollment Count for Kindergarteners 6th and 9th Graders}

#"February", "January", "December", "November", "October"

long_enroll_race_grades <- bind_rows(long_enroll_race_kids, 
                                     long_enroll_race_six, 
                                     long_enroll_race_nine) %>%
  filter(`Student Group` != "All Students")

plot_enroll_count_grades <- long_enroll_race_grades %>%
  ggplot(aes(x = `Student Group`, 
             y = Enrollment,
             fill = Month,
             order = Month)) + 
  geom_col(position = "dodge", width = 0.7) + 
  facet_grid(~factor(GradeLevel, levels=c("Kindergarten", "Sixth Grade", "Ninth Grade"))) +
  ggtitle("Student Enrollment Counts for School Year 2020-21") +
        labs(x = "Student Groups", 
             y = "Student Counts") +
  scale_y_continuous(labels = comma) +
  scale_fill_manual(values = uw_palette(5))  +
  theme_light() +
  coord_flip() +
  theme(plot.title = element_text(face = "bold", size = 16, hjust = 0.5),
        legend.background = element_rect(fill = "white", size = 4, colour = "white"),
 #       legend.justification = c(0, 1),
 #       legend.position = c(0.9, 0.75),
        axis.text.x  = element_text(angle=45, vjust=0.5, size=7),
        axis.title.x  = element_text(size=14),
        axis.title.y  = element_text(size=14),
        strip.text.x = element_text(size = 12, colour = "black")) 

plot_enroll_count_grades
  
ggsave("section_a_analysis_files/figures/A.1.1 Student Enrollment Count for Kindergarteners 6th and 9th Graders.png")
```

## A.1.2 Enrollment percentage

> A.1.2 Student Enrollment Percentagee for Kindergarteners 6th and 9th Graders

* percentage of student enrollment for sy2020-21
  + percentage = student count of a student group in a certain month/student count of all students in the same month
  + no results show minority groups have lower enroll percentage at per k level
  + similar patterns for pre k, 6th, and 9th grade

```{r Student Enrollment Percentage for All Grader Levels}
enrollment_perc_races <- data.frame(matrix(NA,    
                          nrow = nrow(enrollment_by_races),
                          ncol = ncol(enrollment_by_races)))

dimnames(enrollment_perc_races) <- list(rownames(enrollment_by_races), 
                                        colnames(enrollment_by_races))


for (j in 2:ncol(enrollment_by_races)) {
  for (i in nrow(enrollment_by_races):1) {
    enrollment_perc_races[i, j] = percent(enrollment_by_races[i, j]/enrollment_by_races[1,j]*100)
    enrollment_perc_races[i, 1] = enrollment_by_races[i, 1]
  }
}

long_enroll_perc_races <- melt(enrollment_perc_races, 
                             id.vars = "StudentGroup",
                             measure.vars = month_in_df,
                             variable.name = "Month",
                             value.name="EnrollmentPercentage") %>%
  arrange(StudentGroup, Month) %>%
  mutate(EnrollmentPercentage = percent(EnrollmentPercentage))

plot_enroll_perc <- long_enroll_perc_races %>%
  filter(StudentGroup != "All Students") %>%
  mutate(EnrollmentPercentage = EnrollmentPercentage/100)%>%
  ggplot(aes(fill = Month, 
             x = StudentGroup, 
             y = EnrollmentPercentage)) + 
  geom_col(position="dodge", width = 0.7) +
  geom_text(aes(label = `EnrollmentPercentage`), position=position_dodge(width=0.9), 
            hjust = 0, vjust = 0.25, colour = "black", size = 1.5) +
  ggtitle("Enrollment Percentage for SY 2020-21 (All Grade Levels)") +
        labs(x = "Student Groups", 
             y = "Enrollment Percentage") +
  scale_y_continuous(labels = percent) +
  scale_fill_manual(values = uw_palette(4)) +
  theme_light() +
  coord_flip() +
  theme(plot.title = element_text(face = "bold", size = 16, hjust = 0.5),
#        legend.background = element_rect(fill = "white", size = 4, colour = "white"),
 #       legend.justification = c(0, 1),
 #       legend.position = c(0.1, 0.75),
        axis.text.x  = element_text(angle=0, vjust=0.5, size=9),
        axis.title.x  = element_text(size=14),
        axis.title.y  = element_text(size=14),
        strip.text.x = element_text(size = 12, colour = "black")) 


plot_enroll_perc

ggsave("section_a_analysis_files/figures/Student Enrollment Percentage for All Grader Levels.png")


```

```{r A.1.iv Student Enrollment Percentage for Kindergarteners, include=FALSE}

all_students_kids <- long_enroll_race_kids %>%
  filter(`Student Group` == "All Students") %>%
  select("Enrollment")

long_enroll_perc_kids <- long_enroll_race_kids %>%
  group_by(`Student Group`) %>%
  mutate("Percentage" = Enrollment/all_students_kids) %>%
#  ungroup()  %>%
  arrange(`Student Group`, Month)

```

```{r A.1.v Student Enrollment Percentage for 6th Graders, include=FALSE}

all_students_six <- long_enroll_race_six %>%
  filter(`Student Group` == "All Students") %>%
  select("Enrollment")

long_enroll_perc_six <- long_enroll_race_six %>%
  group_by(`Student Group`) %>%
  mutate("Percentage" = Enrollment/all_students_six) %>%
#  ungroup()  %>%
  arrange(`Student Group`, Month) 
```

```{r A.i.vi Student Enrollment Percentage for 9th Graders, include=FALSE}

all_students_nine <- long_enroll_race_nine %>%
  filter(`Student Group` == "All Students") %>%
  select("Enrollment")

long_enroll_perc_nine <- long_enroll_race_nine %>%
  group_by(`Student Group`) %>%
  mutate("Percentage" = Enrollment/all_students_nine) %>%
#  ungroup()  %>%
  arrange(`Student Group`, Month) 

```

```{r A.1.2 Student Enrollment Percentagee for Kindergarteners 6th and 9th Graders}

long_enroll_perc <- bind_rows(long_enroll_perc_kids,
                                long_enroll_perc_six,
                                long_enroll_perc_nine) %>%
  filter(`Student Group` != "All Students") %>%
  mutate(percentage = percent(Percentage$Enrollment)) %>%
  select(!"Percentage")

plot_enroll_count_grades <- long_enroll_perc %>%
  ggplot(aes(x = `Student Group`, 
             y = percentage,
             fill = Month,
             order = Month)) + 
  geom_text(aes(label = percentage), position=position_dodge(width=0.8), 
            hjust = 0, vjust = 0.25, colour = "black", size = 1.5) +
  geom_col(position = "dodge", width = 0.9) + 
  facet_grid(~factor(GradeLevel, levels=c("Kindergarten", "Sixth Grade", "Ninth Grade"))) +
  ggtitle("Student Enrollment Percentage for School Year 2020-21") +
        labs(x = "Student Groups", 
             y = "Enrollment Percentage") +
  scale_y_continuous(labels = percent, limits = c(0, 0.6)) +
  scale_fill_manual(values = uw_palette(5))  +
  theme_light() +
  coord_flip() +
  theme(plot.title = element_text(face = "bold", size = 16, hjust = 0.5),
        legend.background = element_rect(fill = "white", size = 1, colour = "white"),
        legend.title=element_text(size = 10),
        legend.text=element_text(size = 7),
 #       legend.justification = c(0, 1),
 #       legend.position = c(0.9, 0.75),
        axis.text.x  = element_text(angle=45, vjust=0.5, size=7),
        axis.title.x  = element_text(size=14),
        axis.title.y  = element_text(size=14),
        strip.text.x = element_text(size = 12, colour = "black")) 

plot_enroll_count_grades
  
#ggsave("section_a_analysis_files/figures/A.1.2 Student Enrollment Percentagee for Kindergarteners 6th and 9th Graders.png")

```

## A.1.3 Enrollment Change (SY 2020-21 - SY 2019-20) 

> A.1.3 Student Enrollment Change for Kindergarteners 6th and 9th Graders

Change from **SY 2019-20** to SY 2020-21; NO SY 2018-29 ENROLL COUNTS DATA AT GRADE LEVEL; 

* positive value means increase in SY 2020-21 from SY 2019-20

```{r Student Enrollment Change for Kindergartener sorted by races, include=FALSE}

change_enroll_kids_race <- df_change_enrollment_kids %>%
  filter(StudentGroup %in% c("All Students",
                             "American Indian/ Alaskan Native",
                             "Asian",
                             "Black/ African American",
                             "Hispanic/ Latino of any race(s)",
                             "Native Hawaian/ Other Pacific Islander",
                             "Two or More Races",
                             "White"))

months_in_df <- c("October", "November", "December", "January", "February")
long_change_enroll_kids_race <- melt(change_enroll_kids_race, 
                                     id.vars = "StudentGroup",
                                     measure.vars = months_in_df,
                                     variable.name = "Month",
                                     value.name=c("Change in Enrollment")) %>%
  arrange(`StudentGroup`, Month) %>%
  mutate(GradeLevel = "Kindergarten") 

```

```{r Student Enrollment Change for Kindergartener sorted by income, include=FALSE}

change_enroll_kids_income <- df_change_enrollment_kids %>%
  filter(StudentGroup %in% c("All Students",
                             "Low-Income",
                             "Non-Low Income"))

months_in_df <- c("October", "November", "December", "January", "February")
long_change_enroll_kids_income <- melt(change_enroll_kids_income, 
                                     id.vars = "StudentGroup",
                                     measure.vars = months_in_df,
                                     variable.name = "Month",
                                     value.name=c("Change in Enrollment")) %>%
  arrange(`StudentGroup`, Month) %>%
  mutate(GradeLevel = "Kindergarten")
```

```{r Student Enrollment Change for 6th Graders sorted by races, include=FALSE}

change_enroll_six_race <- df_change_enrollment_six %>%
  filter(StudentGroup %in% c("All Students",
                             "American Indian/ Alaskan Native",
                             "Asian",
                             "Black/ African American",
                             "Hispanic/ Latino of any race(s)",
                             "Native Hawaian/ Other Pacific Islander",
                             "Two or More Races",
                             "White"))

months_in_df <- c("October", "November", "December", "January", "February")
long_change_enroll_six_race <- melt(change_enroll_six_race, 
                                     id.vars = "StudentGroup",
                                     measure.vars = months_in_df,
                                     variable.name = "Month",
                                     value.name=c("Change in Enrollment")) %>%
  arrange(`StudentGroup`, Month) %>%
  mutate(GradeLevel = "Sixth Grade") 

```

```{r Student Enrollment Change for 6th Graders sorted by income, include=FALSE}

change_enroll_six_income <- df_change_enrollment_six %>%
  filter(StudentGroup %in% c("All Students",
                             "Low-Income",
                             "Non-Low Income"))

months_in_df <- c("October", "November", "December", "January", "February")
long_change_enroll_six_income <- melt(change_enroll_six_income, 
                                     id.vars = "StudentGroup",
                                     measure.vars = months_in_df,
                                     variable.name = "Month",
                                     value.name=c("Change in Enrollment")) %>%
  arrange(`StudentGroup`, Month) %>%
  mutate(GradeLevel = "Sixth Grade")
```

```{r Student Enrollment Change for 9th Graders sorted by races, include=FALSE}

change_enroll_nine_race <- df_change_enrollment_nine %>%
  filter(StudentGroup %in% c("All Students",
                             "American Indian/ Alaskan Native",
                             "Asian",
                             "Black/ African American",
                             "Hispanic/ Latino of any race(s)",
                             "Native Hawaian/ Other Pacific Islander",
                             "Two or More Races",
                             "White"))

months_in_df <- c("October", "November", "December", "January", "February")
long_change_enroll_nine_race <- melt(change_enroll_nine_race, 
                                     id.vars = "StudentGroup",
                                     measure.vars = months_in_df,
                                     variable.name = "Month",
                                     value.name=c("Change in Enrollment")) %>%
  arrange(`StudentGroup`, Month) %>%
  mutate(GradeLevel = "Ninth Grade")

```

```{r Student Enrollment Change for 9th Graders sorted by income, include=FALSE}

change_enroll_nine_income <- df_change_enrollment_nine %>%
  filter(StudentGroup %in% c("All Students",
                             "Low-Income",
                             "Non-Low Income"))

months_in_df <- c("October", "November", "December", "January", "February")
long_change_enroll_nine_income <- melt(change_enroll_nine_income, 
                                     id.vars = "StudentGroup",
                                     measure.vars = months_in_df,
                                     variable.name = "Month",
                                     value.name=c("Change in Enrollment")) %>%
  arrange(`StudentGroup`, Month) %>%
  mutate(GradeLevel = "Ninth Grade")

```

```{r A.1.3.i Student Enrollment Change for Kindergarteners 6th and 9th Graders sorted by races}

long_change_enroll_race_grades <- bind_rows(long_change_enroll_kids_race, 
                                            long_change_enroll_six_race, 
                                            long_change_enroll_nine_race) %>%
  mutate(`Change in Enrollment` = percent(`Change in Enrollment`))

long_change_enroll_race_grades$GradeLevel <- factor(long_change_enroll_race_grades$GradeLevel, 
                                                      levels=c("Kindergarten", "Sixth Grade", "Ninth Grade"))

plot_change_enroll_race_grades <- long_change_enroll_race_grades %>%
  ggplot(aes(fill = Month, 
             x = `StudentGroup`, 
             y = `Change in Enrollment`)) + 
  geom_col(position = "dodge", width = 0.9) + 
  facet_wrap(~GradeLevel, ncol = 3) +
  ggtitle("Percentage Change in Student Enrollment",
           subtitle = "between SY2019-20 and SY2020-21") +
  labs(x = "Student Groups", 
       y = "Percentage Change in Enrollment") +
  scale_y_continuous(labels = percent) +
  geom_hline(yintercept = 0) +
  scale_fill_manual(values = uw_palette(5)) +
  geom_text(aes(label = `Change in Enrollment`), position=position_dodge(width=0.8), 
            hjust = 0.5, vjust = 0.25, colour = "black", size = 1.5) +
  theme_light() +
  coord_flip() +
  theme(plot.title = element_text(face = "bold", size = 16, hjust = 0.5),
        plot.subtitle = element_text(hjust = 0.5),
        legend.background = element_rect(fill = "white", size = 1, colour = "white"),
        legend.title=element_text(size = 10),
        legend.text=element_text(size = 7),
 #       legend.justification = c(0, 1),
 #       legend.position = c(0.9, 0.75),
        axis.text.x  = element_text(angle=45, vjust=0.5, size=7),
        axis.title.x  = element_text(size=14),
        axis.title.y  = element_text(size=14),
        strip.text.x = element_text(size = 12, colour = "black")) 

plot_change_enroll_race_grades

#ggsave("section_a_analysis_files/figures/A.1.3.i Student Enrollment Change sorted by races.png", 
#       width = 40, height = 15, units = "cm")

plot_change_enroll_race_grades_v <- long_change_enroll_race_grades %>%
  ggplot(aes(fill = Month, 
             x = `StudentGroup`, 
             y = `Change in Enrollment`)) + 
  geom_col(position = "dodge", width = 0.9) + 
  facet_wrap(~GradeLevel, ncol = 1) +
  ggtitle("Percentage Change in Student Enrollment",
           subtitle = "between SY2019-20 and SY2020-21") +
  labs(x = "Student Groups", 
       y = "Percentage Change in Enrollment") +
  scale_y_continuous(labels = percent) +
  geom_hline(yintercept = 0) +
  scale_fill_manual(values = uw_palette(5)) +
  geom_text(aes(label = `Change in Enrollment`), position=position_dodge(width=0.8), 
            hjust = 0.5, vjust = 0.25, colour = "black", size = 1.5) +
  theme_light() +
  coord_flip() +
  theme(plot.title = element_text(face = "bold", size = 16, hjust = 0.5),
        plot.subtitle = element_text(hjust = 0.5),
        legend.background = element_rect(fill = "white", size = 1, colour = "white"),
        legend.title=element_text(size = 10),
        legend.text=element_text(size = 7),
 #       legend.justification = c(0, 1),
 #       legend.position = c(0.9, 0.75),
        axis.text.x  = element_text(angle=45, vjust=0.5, size=7),
        axis.title.x  = element_text(size=14),
        axis.title.y  = element_text(size=14),
        strip.text.x = element_text(size = 12, colour = "black")) 

plot_change_enroll_race_grades_v

#ggsave("section_a_analysis_files/figures/A.1.3.i Student Enrollment Change sorted by races_v.png", 
#       width = 20, height = 40, units = "cm")

```

```{r A.1.3.ii Student Enrollment Change for Kindergarteners 6th and 9th Graders sorted by income}
long_change_enroll_income_grades <- bind_rows(long_change_enroll_kids_income, 
                                              long_change_enroll_six_income, 
                                              long_change_enroll_nine_income)  %>%
  mutate(`Change in Enrollment` = percent(`Change in Enrollment`))

long_change_enroll_income_grades$GradeLevel <- factor(long_change_enroll_income_grades$GradeLevel, 
                                                      levels=c("Kindergarten", "Sixth Grade", "Ninth Grade"))

#horizontal grid
plot_change_enroll_income_grades_h <- long_change_enroll_income_grades %>%
  ggplot(aes(fill = Month, 
             x = `StudentGroup`, 
             y = `Change in Enrollment`)) + 
  geom_col(position = "dodge", width = 0.7) + 
  facet_wrap(~GradeLevel, ncol = 3) +
  ggtitle("Percentage Change in Student Enrollment",
          subtitle = "between SY2019-20 and SY2020-21") +
        labs(x = "Income Groups", 
             y = "Percentage Change in Enrollment") +
  scale_y_continuous(labels = percent) +
  geom_hline(yintercept = 0) +
  scale_fill_manual(values = uw_palette(5)) +
  geom_text(aes(label = `Change in Enrollment`), position=position_dodge(width=0.8), 
            hjust = 0.5, vjust = 0.25, colour = "black", size = 1.5) +
  theme_light() +
  coord_flip() +
  theme(plot.title = element_text(face = "bold", size = 16, hjust = 0.5),
        plot.subtitle = element_text(hjust = 0.5),
        legend.background = element_rect(fill = "white", size = 1, colour = "white"),
        legend.title=element_text(size = 10),
        legend.text=element_text(size = 7),
 #       legend.justification = c(0, 1),
 #       legend.position = c(0.9, 0.75),
        axis.text.x  = element_text(angle=45, vjust=0.5, size=7),
        axis.title.x  = element_text(size=14),
        axis.title.y  = element_text(size=14),
        strip.text.x = element_text(size = 12, colour = "black")) 

plot_change_enroll_income_grades_h

#ggsave("section_a_analysis_files/figures/A.1.3.ii Student Enrollment Change sorted by income_h.png")

#vertical grid
plot_change_enroll_income_grades_v <- long_change_enroll_income_grades %>%
  ggplot(aes(fill = Month, 
             x = `StudentGroup`, 
             y = `Change in Enrollment`)) + 
  geom_col(position = "dodge", width = 0.7) + 
  facet_wrap(~GradeLevel, ncol = 1) +
  ggtitle("Percentage Change in Student Enrollment",
          subtitle = "between SY2019-20 and SY2020-21") +
        labs(x = "Income Groups", 
             y = "Percentage Change in Enrollment") +
  scale_y_continuous(labels = percent) +
  geom_hline(yintercept = 0) +
  scale_fill_manual(values = uw_palette(5)) +
  geom_text(aes(label = `Change in Enrollment`), position=position_dodge(width=0.8), 
            hjust = 0.5, vjust = 0.25, colour = "black", size = 1.5) +
  theme_light() +
  coord_flip() +
  theme(plot.title = element_text(face = "bold", size = 16, hjust = 0.5),
        plot.subtitle = element_text(hjust = 0.5),
        legend.background = element_rect(fill = "white", size = 1, colour = "white"),
        legend.title=element_text(size = 10),
        legend.text=element_text(size = 7),
 #       legend.justification = c(0, 1),
 #       legend.position = c(0.9, 0.75),
        axis.text.x  = element_text(angle=45, vjust=0.5, size=7),
        axis.title.x  = element_text(size=14),
        axis.title.y  = element_text(size=14),
        strip.text.x = element_text(size = 12, colour = "black")) 

plot_change_enroll_income_grades_v

#ggsave("section_a_analysis_files/figures/A.1.3.ii Student Enrollment Change sorted by income_v.png")

```

***

# A.2. Student Absence Both Count and Change 

Students of color or low income students are further disadvantaged during the pandemic in terms of abs. Particularly lower grade levels
grade levels: pre K, 3rd, 6th, 8th, 9th, 10th grade.

* measure: average absences per student
* for total absences
  + higher grade levels have higher absences
  + on average, for all the grade levels, minority groups have high absences 
  + top absences groups: American Indian/Alaskan Native, Native Hawaiian/Other Pacific Islander, Hispanic/Latino of any race(s)
  + low-income group has higher absences than non-low income for all the grade levels

* for difference in absences between sy2018-19 and sy2020-21
  + difference = absences in sy2018-19 (of particular student group in a certain month) - absences in sy2018-19 (of the same student group in that month)
  + POSITIVE value means that absences in sy2020-21 is higher (an increase)
  + for grade levels 6, 8, 9, and 10, absences in sy2020-21 is higher
  + for kindergarten, absences decreased for group "all students" while increased for American Indian/Alaskan Native, Native Hawaiian/Other Pacific Islander, Hispanic/Latino of any race(s)
  + for kindergarten, absences increased for low-income group while decreased for non-low income group
  
```{r A.2 load absences data, include=FALSE}
id_absences_prek <- drive_get(as_id("https://drive.google.com/file/d/1WomqNkILSgSr-1vivw6yq6mt2hoYG70R/view?usp=sharing"))
id_absences_3rd <- drive_get(as_id("https://drive.google.com/file/d/1BHSSnZzzszda-0l1AA0-T20leRUGUYJN/view?usp=sharing"))
id_absences_6th <- drive_get(as_id("https://drive.google.com/file/d/1rnBlB9gS4l4XG7xldeGPgbsmgH_sFxIQ/view?usp=sharing"))
id_absences_8th <- drive_get(as_id("https://drive.google.com/file/d/1sA6HAIdAliSwPNR2au37dNcXMTBdie6p/view?usp=sharing"))
id_absences_9th <- drive_get(as_id("https://drive.google.com/file/d/1uH9xzI5jjDNn39i5yCIsNUMa_Gvipl00/view?usp=sharing"))
id_absences_10th <- drive_get(as_id("https://drive.google.com/file/d/1jz4BXyIuvm3G53_0Z9kkOC-JnrEDiJHh/view?usp=sharing"))

df_absences_prek <- id_absences_prek %>%
  drive_read_string() %>%
  read_csv(col_names=TRUE)

df_absences_3rd <- id_absences_3rd %>%
  drive_read_string() %>%
  read_csv(col_names=TRUE)

df_absences_6th <- id_absences_6th %>%
  drive_read_string() %>%
  read_csv(col_names=TRUE)

df_absences_8th <- id_absences_8th %>%
  drive_read_string() %>%
  read_csv(col_names=TRUE)

df_absences_9th <- id_absences_9th %>%
  drive_read_string() %>%
  read_csv(col_names=TRUE)

df_absences_10th <- id_absences_10th %>%
  drive_read_string() %>%
  read_csv(col_name=TRUE)

df_absences <- bind_rows(Kindergarten = df_absences_prek,
                         `3rd Grade` = df_absences_3rd, 
                         `6th Grade` = df_absences_6th,
                         `8th Grade` = df_absences_8th,
                         `9th Grade` = df_absences_9th, 
                         `10th Grade` = df_absences_10th, 
                         .id = "GradeLevel")
```

## A.2.1 Absence count

> A.2.1 Student Absence Count for Kindergarteners, 3rd, 6th, 8th, 9th, and 10th Graders

```{r A.2.1.i Student Absence Count sorted by races data, include=FALSE}

months_in_df <- c("October", "November", "December", "January", "February")
df_absences$"GradeLevel" <- factor(df_absences$"GradeLevel", 
                                   levels = c("Kindergarten", "3rd Grade", 
                                              "6th Grade", "8th Grade",
                                              "9th Grade", "10th Grade"))
  
absences_count <- df_absences %>%
  filter(StudentGroup == "All Students" | 
           StudentGroup == "American Indian/ Alaskan Native"|
           StudentGroup == "Asian"|
           StudentGroup == "Black/ African American"|
           StudentGroup == "Hispanic/ Latino of any race(s)"|
           StudentGroup == "Native Hawaian/ Other Pacific Islander"|
           StudentGroup == "Two or More Races"|
           StudentGroup == "White") %>%
  select(!c("10/2019", "11/2019", "12/2019", "01/2019", "02/2019",
            "10/2020", "11/2020", "12/2020", "01/2020", "02/2020")) 

colnames(absences_count) <- c("GradeLevel", "StudentGroup", months_in_df)

long_absences_count <- melt(absences_count, 
                            id.vars = c("GradeLevel", "StudentGroup"),
                            measure.vars = months_in_df,
                            variable.name = "Month",
                            value.name=c("Total Absences")) %>%
  mutate(`Total Absences` = as.numeric(`Total Absences`)) %>%
  arrange(GradeLevel, StudentGroup, Month)

```

```{r A.2.1.i Student Absence Count sorted by races, fig.height=12, fig.width=10, warning=FALSE}

long_absences_count <- within(long_absences_count, Month <- factor(Month, 
                                      levels = c("February", "January",
                                                 "December", "November", "October"))) %>%
  group_by(GradeLevel, StudentGroup) %>%
  mutate(label_y = cumsum(`Total Absences`))

plot_absences_count_bygrades <- long_absences_count %>%
  ggplot(aes(x = StudentGroup, 
             y = `Total Absences`,
             fill = Month, 
             order = Month)) + 
#  geom_bar(position="dodge", stat="identity") + #to separated bars for months 
  geom_col(stat="identity", width = 0.7) +
  facet_wrap(~GradeLevel, ncol = 1) +
  ggtitle("Total Absences by Month for School Year 2020-21") +
        labs(x = "Student Groups", 
             y = "Total Absences") +
  scale_y_continuous(limits = c(0, 35)) +
  geom_text(aes(y = label_y, label = `Total Absences`), hjust = 1, colour = "grey88", size = 3) +
  scale_fill_manual(values = uw_palette(5))  +
  theme_light() +
  coord_flip() +
  theme(plot.title = element_text(face = "bold", size = 16, hjust = 0.5),
 #       legend.background = element_rect(fill = "white", size = 4, colour = "white"),
 #       legend.justification = c(0, 1),
  #      legend.position = c(0.9, 0.75),
        axis.text.x  = element_text(angle=0, vjust=0.5, size=9),
        axis.title.x  = element_text(size=14),
        axis.title.y  = element_text(size=14),
        strip.text.x = element_text(size = 12, colour = "black")) 

plot_absences_count_bygrades

#ggsave("/Users/alexliu/Desktop/plot.png")
```

```{r A.2.1.i Student Absence Count sorted by races unstacked, fig.height=14, fig.width=10, warning=FALSE}

#long_absences_count <- ungroup(long_absences_count)

plot_absences_count_bygrades_unstacked <- long_absences_count %>%
  ggplot(aes(x = StudentGroup, 
             y = `Total Absences`,
             fill = Month, 
             order = Month)) + 
  geom_col(position="dodge", stat="identity", width = 0.7) + #to separated bars for months 
#  geom_bar(stat="identity", width = 0.4) +
  facet_wrap(~GradeLevel, ncol = 1) +
  ggtitle("Total Absences by Month for School Year 2020-21") +
        labs(x = "Student Groups", 
             y = "Total Absences") +
#  scale_y_continuous(limits = c(0, 35)) +
  geom_text(aes(label = `Total Absences`), position=position_dodge(width=0.9), 
            hjust = 0, vjust = 0.25, colour = "black", size = 1.5) +
  scale_fill_manual(values = uw_palette(5))  +
  theme_light() +
  coord_flip() +
  theme(plot.title = element_text(face = "bold", size = 16, hjust = 0.5),
        legend.background = element_rect(fill = "white", size = 4, colour = "white"),
 #       legend.justification = c(0, 1),
        legend.position = c(0.9, 0.75),
        axis.text.x  = element_text(angle=0, vjust=0.5, size=9),
        axis.title.x  = element_text(size=14),
        axis.title.y  = element_text(size=14),
        strip.text.x = element_text(size = 12, colour = "black")) 

plot_absences_count_bygrades_unstacked

#ggsave("/Users/alexliu/Desktop/plot.png")

```

```{r A.2.1.i Student Absence Count sorted by races separate, warning=FALSE}

long_absences_count <- ungroup(long_absences_count)

grade_levels <- unique(long_absences_count$GradeLevel)
plot_absences_count_separate <- list()

for (i in seq_along(grade_levels)) {
  df <- long_absences_count %>% filter(GradeLevel == grade_levels[i]) 
    p<- ggplot(df, aes(x = StudentGroup, 
        y = `Total Absences`,
        fill = Month, 
        order = Month)) + 
    geom_col(position="dodge", width = 0.7) +  
    facet_wrap(~GradeLevel, ncol = 1) +
    ggtitle("Total Absences by Month for School Year 2020-21") +
    labs(x = "Student Groups", y = "Total Absences") +
    scale_y_continuous(limits = c(0, 7.5)) +
    geom_text(aes(label = `Total Absences`), position=position_dodge(width=0.9), 
            hjust = 0, vjust = 0.25, colour = "black", size = 1.5) +
    scale_fill_manual(values = uw_palette(5))  +
    theme_light() +
    coord_flip() +
    theme(plot.title = element_text(face = "bold", size = 16, hjust = 0.5),
          plot.subtitle = element_text(size = 14, hjust = 0.5),
          legend.background = element_rect(fill = "white", size = 4, colour = "white"),
          axis.text.x  = element_text(angle=0, vjust=0.5, size=9),
          axis.title.x  = element_text(size=14),
          axis.title.y  = element_text(size=14),
          strip.text.x = element_text(size = 12, colour = "black")) 
  
  print(p)
  plot_absences_count_separate[[i]] <- p
}

```

```{r A.2.1.ii Student Absence Count sorted by income data, include=FALSE}

months_in_df <- c("October", "November", "December", "January", "February")
df_absences$"GradeLevel" <- factor(df_absences$"GradeLevel", 
                                   levels = c("Kindergarten", "3rd Grade", 
                                              "6th Grade", "8th Grade",
                                              "9th Grade", "10th Grade"))
  
absences_count_income <- df_absences %>%
  filter(StudentGroup == "All Students" | 
           StudentGroup == "Low-Income"|
           StudentGroup == "Non-Low Income") %>%
  select(!c("10/2019", "11/2019", "12/2019", "01/2019", "02/2019",
            "10/2020", "11/2020", "12/2020", "01/2020", "02/2020")) 

colnames(absences_count_income) <- c("GradeLevel", "StudentGroup", months_in_df)

long_absences_count_income <- melt(absences_count_income, 
                            id.vars = c("GradeLevel", "StudentGroup"),
                            measure.vars = months_in_df,
                            variable.name = "Month",
                            value.name=c("Total Absences")) %>%
  mutate(`Total Absences` = as.numeric(`Total Absences`)) %>%
  arrange(GradeLevel, StudentGroup, Month)

```

```{r A.2.1.ii Student Absence Count sorted by income, warning=FALSE}

long_absences_count_income <- within(long_absences_count_income, Month <- factor(Month, 
                                      levels = c("February", "January",
                                                 "December", "November", "October"))) %>%
  group_by(GradeLevel, StudentGroup) %>%
  mutate(label_y = cumsum(`Total Absences`))

plot_absences_count_income <- long_absences_count_income %>%
  ggplot(aes(x = StudentGroup, 
             y = `Total Absences`,
             fill = Month, 
             order = Month)) + 
#  geom_bar(position="dodge", stat="identity") + #to separated bars for months 
  geom_col(stat="identity", width = 0.7) +
  facet_wrap(~GradeLevel, ncol = 1) +
  ggtitle("Total Absences by Month for School Year 2020-21") +
        labs(x = "Student Groups", 
             y = "Total Absences") +
  scale_y_continuous(limits = c(0, 25)) +
  geom_text(aes(y = label_y, label = `Total Absences`), hjust = 1, colour = "grey88", size = 3) +
  scale_fill_manual(values = uw_palette(5))  +
  theme_light() +
  coord_flip() +
  theme(plot.title = element_text(face = "bold", size = 14, hjust = 0.5),
    #    legend.background = element_rect(fill = "white", size = 4, colour = "white"),
 #       legend.justification = c(0, 1),
   #     legend.position = c(0.9, 0.75),
        axis.text.x  = element_text(angle=0, vjust=0.5, size=9),
        axis.title.x  = element_text(size=14),
        axis.title.y  = element_text(size=14),
        strip.text.x = element_text(size = 12, colour = "black")) 

plot_absences_count_income

# ggsave("/Users/alexliu/Desktop/plot.png")

```

```{r A.2.1.ii Student Absence Count sorted by income unstacked, fig.height=12, fig.width=10}
#long_absences_count_income <- ungroup(long_absences_count_income)

plot_absences_count_income_unstacked <- long_absences_count_income %>%
  ggplot(aes(x = StudentGroup, 
             y = `Total Absences`,
             fill = Month, 
             order = Month)) + 
  geom_col(position="dodge", stat="identity", width = 0.7) + #to separated bars for months 
  facet_wrap(~GradeLevel, ncol = 1) +
  ggtitle("Total Absences by Month for School Year 2020-21") +
        labs(x = "Student Groups", 
             y = "Total Absences") +
  geom_text(aes(label = `Total Absences`), position = position_dodge(0.9),
            hjust = 0, vjust = 0.5, colour = "black", size = 2) +
  scale_fill_manual(values = uw_palette(5))  +
  theme_light() +
  coord_flip() +
  theme(plot.title = element_text(face = "bold", size = 16, hjust = 0.5),
  #      legend.background = element_rect(fill = "white", size = 4, colour = "white"),
 #       legend.justification = c(0, 1),
 #       legend.position = c(0.9, 0.75),
        axis.text.x  = element_text(angle=0, vjust=0.5, size=9),
        axis.title.x  = element_text(size=14),
        axis.title.y  = element_text(size=14),
        strip.text.x = element_text(size = 12, colour = "black")) 

plot_absences_count_income_unstacked

#ggsave("/Users/alexliu/Desktop/plot.png")

```

```{r A.2.1.ii Student Absence Count sorted by income separate}
long_absences_count_income <- ungroup(long_absences_count_income)

grade_levels <- unique(long_absences_count_income$GradeLevel)
plot_absences_count_inc_separate <- list()

for (i in seq_along(grade_levels)) {
  df <- long_absences_count_income %>% filter(GradeLevel == grade_levels[i]) 
    p<- ggplot(df, aes(x = StudentGroup, 
        y = `Total Absences`,
        fill = Month, 
        order = Month)) + 
    geom_col(position="dodge", width = 0.7) + #to separated bars for months 
    facet_wrap(~GradeLevel, ncol = 1) +
    ggtitle("Total Absences by Month for School Year 2020-21") +
    labs(x = "Student Groups", y = "Total Absences") +
    scale_y_continuous(limits = c(0, 6)) +
    geom_text(aes(label = `Total Absences`), position=position_dodge(width=0.9), 
            hjust = 0, vjust = 0.25, colour = "black", size = 1.5) +
    scale_fill_manual(values = uw_palette(5))  +
    theme_light() +
    coord_flip() +
    theme(plot.title = element_text(face = "bold", size = 16, hjust = 0.5),
          plot.subtitle = element_text(size = 14, hjust = 0.5),
          legend.background = element_rect(fill = "white", size = 4, colour = "white"),
          axis.text.x  = element_text(angle=0, vjust=0.5, size=9),
          axis.title.x  = element_text(size=14),
          axis.title.y  = element_text(size=14),
          strip.text.x = element_text(size = 12, colour = "black")) 
  
  print(p)
  plot_absences_count_inc_separate[[i]] <- p
}
```

## A.2.2 Absence change (SY 2020-21 - SY 2018-19)

> A.2.2 Student Absence Change for Kindergarteners, 3rd, 6th, 8th, 9th, and 10th Graders

```{r A.2.2.i Student Absence Change sorted by races data, include=FALSE}

months_in_df <- c("October", "November", "December", "January", "February")
df_absences$"GradeLevel" <- factor(df_absences$"GradeLevel", 
                                   levels = c("Kindergarten", "3rd Grade", 
                                              "6th Grade", "8th Grade",
                                              "9th Grade", "10th Grade"))
  
absences_change <- df_absences %>%
  filter(StudentGroup == "All Students" | 
           StudentGroup == "American Indian/ Alaskan Native"|
           StudentGroup == "Asian"|
           StudentGroup == "Black/ African American"|
           StudentGroup == "Hispanic/ Latino of any race(s)"|
           StudentGroup == "Native Hawaian/ Other Pacific Islander"|
           StudentGroup == "Two or More Races"|
           StudentGroup == "White") %>%
  mutate(October = as.numeric(`10/2021`) - as.numeric(`10/2019`),
         November = as.numeric(`11/2021`) - as.numeric(`11/2019`),
         December = as.numeric(`12/2021`) - as.numeric(`12/2019`),
         January = as.numeric(`01/2021`) - as.numeric(`01/2019`),
         February = as.numeric(`02/2021`) - as.numeric(`02/2019`)) %>%
  select(c("GradeLevel", "StudentGroup", "October", "November", "December", "January", "February")) 


long_absences_change <- melt(absences_change, 
                            id.vars = c("GradeLevel", "StudentGroup"),
                            measure.vars = months_in_df,
                            variable.name = "Month",
                            value.name=c("% Change in Absences")) %>%
  mutate(`% Change in Absences` = as.numeric(`% Change in Absences`)) %>%
  mutate(`% Change in Absences` = formattable(`% Change in Absences`, digits = 1, format = "f")) %>%
  arrange(GradeLevel, StudentGroup, Month)



```

```{r A.2.2.i Student Absence Change sorted by races, fig.height=14, fig.width=10, warning=FALSE}

plot_absences_change_bygrades <- long_absences_change %>%
  ggplot(aes(x = StudentGroup, 
             y = `% Change in Absences`,
             fill = Month, 
             order = Month)) + 
  geom_col(position="dodge", stat="identity", width = 0.7) + #to separated bars for months 
#  geom_bar(stat="identity", width = 0.4) +
  facet_wrap(~GradeLevel, ncol = 1) +
  ggtitle("Difference in Total Absences",
          subtitle = "between School Year 2018-19 and School Year 2020-21") +
        labs(x = "Student Groups", 
             y = "Difference in Absences") +
  scale_y_continuous(limits = c(-1, 3.5)) +
  geom_text(aes(label = `% Change in Absences`), position=position_dodge(width=0.9), 
            hjust = 0.5, vjust = 0.25, colour = "black", size = 1.5) +
  scale_fill_manual(values = uw_palette(5))  +
  theme_light() +
  coord_flip() +
  theme(plot.title = element_text(face = "bold", size = 16, hjust = 0.5),
        plot.subtitle = element_text(size = 14, hjust = 0.5),
        legend.background = element_rect(fill = "white", size = 4, colour = "white"),
 #       legend.justification = c(0, 1),
        legend.position = c(0.9, 0.75),
        axis.text.x  = element_text(angle=0, vjust=0.5, size=9),
        axis.title.x  = element_text(size=14),
        axis.title.y  = element_text(size=14),
        strip.text.x = element_text(size = 12, colour = "black")) 

plot_absences_change_bygrades

#ggsave("/Users/alexliu/Desktop/plot.png")

```

```{r A.2.2.i Student Absence Change sorted by races separate}

grade_levels <- unique(long_absences_change$GradeLevel)
plot_absences_change_separate <- list()

for (i in seq_along(grade_levels)) {
  df <- long_absences_change %>% filter(GradeLevel == grade_levels[i]) 
    p<- ggplot(df, aes(x = StudentGroup, 
                   y = `% Change in Absences`,
                   fill = Month, 
                   order = Month)) + 
      geom_col(position="dodge", width = 0.7) +
      facet_wrap(~GradeLevel, ncol = 1) +
      ggtitle("Difference in Total Absences",
              subtitle = "between School Year 2018-19 and School Year 2020-21") +
      labs(x = "Student Groups", y = "Difference in Absences") +
      scale_y_continuous(limits = c(-1, 3.5)) +
      geom_text(aes(label = `% Change in Absences`), position=position_dodge(width=0.9), 
            hjust = 0.5, vjust = 0.25, colour = "black", size = 1.5) +
      scale_fill_manual(values = uw_palette(5))  +
      theme_light() +
      coord_flip() +
      theme(plot.title = element_text(face = "bold", size = 16, hjust = 0.5),
            plot.subtitle = element_text(size = 14, hjust = 0.5),
            legend.background = element_rect(fill = "white", size = 4, colour = "white"),
            axis.text.x  = element_text(angle=0, vjust=0.5, size=9),
            axis.title.x  = element_text(size=14),
            axis.title.y  = element_text(size=14),
            strip.text.x = element_text(size = 12, colour = "black")) 
    print(p)
    plot_absences_change_separate[[i]] <- p
}

```

```{r A.2.2.ii Student Absence Change sorted by income data, include=FALSE}

absences_change_income <- df_absences %>%
  filter(StudentGroup == "All Students" | 
           StudentGroup == "Low-Income"|
           StudentGroup == "Non-Low Income") %>%
  mutate(October = as.numeric(`10/2021`) - as.numeric(`10/2019`),
         November = as.numeric(`11/2021`) - as.numeric(`11/2019`),
         December = as.numeric(`12/2021`) - as.numeric(`12/2019`),
         January = as.numeric(`01/2021`) - as.numeric(`01/2019`),
         February = as.numeric(`02/2021`) - as.numeric(`02/2019`)) %>%
  select(c("GradeLevel", "StudentGroup", "October", "November", "December", "January", "February")) 

long_absences_change_income <- melt(absences_change_income, 
                            id.vars = c("GradeLevel", "StudentGroup"),
                            measure.vars = months_in_df,
                            variable.name = "Month",
                            value.name=c("% Change in Absences")) %>%
  mutate(`% Change in Absences` = as.numeric(`% Change in Absences`)) %>%
  mutate(`% Change in Absences` = formattable(`% Change in Absences`, digits = 1, format = "f")) %>%
  arrange(GradeLevel, StudentGroup, Month)

```

```{r A.2.2.ii Student Absence Change sorted by income, fig.height=12, fig.width=10, warning=FALSE}

plot_absences_change_income <- long_absences_change_income %>%
  ggplot(aes(x = StudentGroup, 
             y = `% Change in Absences`,
             fill = Month, 
             order = Month)) + 
  geom_col(position="dodge", stat="identity", width = 0.7) + #to separated bars for months 
  facet_wrap(~GradeLevel, ncol = 1) +
  ggtitle("Difference in Total Absences",
          subtitle = "between School Year 2018-19 and School Year 2020-21") +
        labs(x = "Student Groups", 
             y = "Difference in Absences") +
  geom_text(aes(label = `% Change in Absences`), position = position_dodge(0.9),
            hjust = 0.5, vjust = 0.5, colour = "black", size = 2) +
  scale_y_continuous(limits = c(-1, 2.5)) +
  scale_fill_manual(values = uw_palette(5))  +
  theme_light() +
  coord_flip() +
  theme(plot.title = element_text(face = "bold", size = 14, hjust = 0.5),
        plot.subtitle = element_text(size = 14, hjust = 0.5),
   #     legend.background = element_rect(fill = "white", size = 4, colour = "white"),
 #       legend.justification = c(0, 1),
  #      legend.position = c(0.9, 0.75),
        axis.text.x  = element_text(angle=0, vjust=0.5, size=9),
        axis.title.x  = element_text(size=14),
        axis.title.y  = element_text(size=14),
        strip.text.x = element_text(size = 12, colour = "black")) 

plot_absences_change_income

#ggsave("/Users/alexliu/Desktop/plot.png")

```

```{r A.2.2.ii Student Absence Change sorted by income separate}

grade_levels <- unique(long_absences_change_income$GradeLevel)
plot_absences_change_inc_separate <- list()

for (i in seq_along(grade_levels)) {
  df <- long_absences_change_income %>% filter(GradeLevel == grade_levels[i]) 
    p<- ggplot(df, aes(x = StudentGroup, 
                   y = `% Change in Absences`,
                   fill = Month, 
                   order = Month)) + 
      geom_col(position="dodge", width = 0.7) +
      facet_wrap(~GradeLevel, ncol = 1) +
      ggtitle("Difference in Total Absences",
              subtitle = "between School Year 2018-19 and School Year 2020-21") +
      labs(x = "Student Groups", y = "Difference in Absences") +
      scale_y_continuous(limits = c(-1, 2.5)) +
      geom_text(aes(label = `% Change in Absences`), position=position_dodge(width=0.9), 
            hjust = 0.5, vjust = 0.25, colour = "black", size = 1.5) +
      scale_fill_manual(values = uw_palette(5))  +
      theme_light() +
      coord_flip() +
      theme(plot.title = element_text(face = "bold", size = 16, hjust = 0.5),
            plot.subtitle = element_text(size = 14, hjust = 0.5),
            legend.background = element_rect(fill = "white", size = 4, colour = "white"),
            axis.text.x  = element_text(angle=0, vjust=0.5, size=9),
            axis.title.x  = element_text(size=14),
            axis.title.y  = element_text(size=14),
            strip.text.x = element_text(size = 12, colour = "black")) 
    print(p)
    plot_absences_change_inc_separate[[i]] <- p
}

```

```{r A.2.2.iii Student Absence PERCENTAGE Change sorted by races, fig.height=14, fig.width=10}

months_in_df <- c("October", "November", "December", "January", "February")
df_absences$"GradeLevel" <- factor(df_absences$"GradeLevel", 
                                   levels = c("Kindergarten", "3rd Grade", 
                                              "6th Grade", "8th Grade",
                                              "9th Grade", "10th Grade"))
  
absences_perc_change <- df_absences %>%
  filter(StudentGroup == "All Students" | 
           StudentGroup == "American Indian/ Alaskan Native"|
           StudentGroup == "Asian"|
           StudentGroup == "Black/ African American"|
           StudentGroup == "Hispanic/ Latino of any race(s)"|
           StudentGroup == "Native Hawaian/ Other Pacific Islander"|
           StudentGroup == "Two or More Races"|
           StudentGroup == "White") %>%
  mutate(October = (as.numeric(`10/2021`) - as.numeric(`10/2019`))/as.numeric(`10/2019`),
         November = (as.numeric(`11/2021`) - as.numeric(`11/2019`))/as.numeric(`11/2019`),
         December = (as.numeric(`12/2021`) - as.numeric(`12/2019`))/as.numeric(`12/2019`),
         January = (as.numeric(`01/2021`) - as.numeric(`01/2019`))/as.numeric(`01/2019`),
         February = (as.numeric(`02/2021`) - as.numeric(`02/2019`))/as.numeric(`02/2019`)) %>%
  select(c("GradeLevel", "StudentGroup", "October", "November", "December", "January", "February")) 


long_absences_perc_change <- melt(absences_perc_change, 
                            id.vars = c("GradeLevel", "StudentGroup"),
                            measure.vars = months_in_df,
                            variable.name = "Month",
                            value.name=c("% Change in Absences")) %>%
  mutate(`% Change in Absences` = as.numeric(`% Change in Absences`)) %>%
  mutate(`% Change in Absences` = formattable(`% Change in Absences`, digits = 1, format = "f")) %>%
  arrange(GradeLevel, StudentGroup, Month)

plot_absences_perc_change_bygrades <- long_absences_perc_change %>%
  ggplot(aes(x = StudentGroup, 
             y = `% Change in Absences`,
             fill = Month, 
             order = Month)) + 
  geom_col(position="dodge", stat="identity", width = 0.7) + #to separated bars for months 
#  geom_bar(stat="identity", width = 0.4) +
  facet_wrap(~GradeLevel, ncol = 1) +
  ggtitle("Percentage Change in Total Absences",
          subtitle = "from School Year 2018-19 to School Year 2020-21") +
        labs(x = "Student Groups", 
             y = "Difference in Absences") +
  scale_y_continuous(limits = c(-1, 2)) +
  geom_text(aes(label = `% Change in Absences`), position=position_dodge(width=0.9), 
            hjust = 0.5, vjust = 0.25, colour = "black", size = 1.5) +
  scale_fill_manual(values = uw_palette(5))  +
  theme_light() +
  coord_flip() +
  theme(plot.title = element_text(face = "bold", size = 16, hjust = 0.5),
        plot.subtitle = element_text(size = 14, hjust = 0.5),
        legend.background = element_rect(fill = "white", size = 4, colour = "white"),
 #       legend.justification = c(0, 1),
        legend.position = c(0.9, 0.75),
        axis.text.x  = element_text(angle=0, vjust=0.5, size=9),
        axis.title.x  = element_text(size=14),
        axis.title.y  = element_text(size=14),
        strip.text.x = element_text(size = 12, colour = "black")) 

plot_absences_perc_change_bygrades

#ggsave("/Users/alexliu/Desktop/plot.png")
```

```{r A.2.2.iii Student Absence PERCENTAGE Change sorted by income, fig.height=12, fig.width=10}
absences_perc_change_income <- df_absences %>%
  filter(StudentGroup == "All Students" | 
           StudentGroup == "Low-Income"|
           StudentGroup == "Non-Low Income") %>%
  mutate(October = (as.numeric(`10/2021`) - as.numeric(`10/2019`))/as.numeric(`10/2019`),
         November = (as.numeric(`11/2021`) - as.numeric(`11/2019`))/as.numeric(`11/2019`),
         December = (as.numeric(`12/2021`) - as.numeric(`12/2019`))/as.numeric(`12/2019`),
         January = (as.numeric(`01/2021`) - as.numeric(`01/2019`))/as.numeric(`01/2019`),
         February = (as.numeric(`02/2021`) - as.numeric(`02/2019`))/as.numeric(`02/2019`)) %>%
  select(c("GradeLevel", "StudentGroup", "October", "November", "December", "January", "February")) 

long_absences_perc_change_income <- melt(absences_perc_change_income, 
                            id.vars = c("GradeLevel", "StudentGroup"),
                            measure.vars = months_in_df,
                            variable.name = "Month",
                            value.name=c("% Change in Absences")) %>%
  mutate(`% Change in Absences` = as.numeric(`% Change in Absences`)) %>%
  mutate(`% Change in Absences` = formattable(`% Change in Absences`, digits = 1, format = "f")) %>%
  arrange(GradeLevel, StudentGroup, Month)

plot_absences_perc_change_income <- long_absences_perc_change_income %>%
  ggplot(aes(x = StudentGroup, 
             y = `% Change in Absences`,
             fill = Month, 
             order = Month)) + 
  geom_col(position="dodge", stat="identity", width = 0.7) + #to separated bars for months 
  facet_wrap(~GradeLevel, ncol = 1) +
  ggtitle("Percentage Change in Total Absences",
          subtitle = "between School Year 2018-19 and School Year 2020-21") +
        labs(x = "Student Groups", 
             y = "Difference in Absences") +
  geom_text(aes(label = `% Change in Absences`), position = position_dodge(0.9),
            hjust = 0.5, vjust = 0.5, colour = "black", size = 2) +
  scale_y_continuous(limits = c(-1.5, 1.5)) +
  scale_fill_manual(values = uw_palette(5))  +
  theme_light() +
  coord_flip() +
  theme(plot.title = element_text(face = "bold", size = 14, hjust = 0.5),
        plot.subtitle = element_text(size = 14, hjust = 0.5),
   #     legend.background = element_rect(fill = "white", size = 4, colour = "white"),
 #       legend.justification = c(0, 1),
  #      legend.position = c(0.9, 0.75),
        axis.text.x  = element_text(angle=0, vjust=0.5, size=9),
        axis.title.x  = element_text(size=14),
        axis.title.y  = element_text(size=14),
        strip.text.x = element_text(size = 12, colour = "black")) 

plot_absences_perc_change_income

#ggsave("/Users/alexliu/Desktop/plot_inc.png")
```

***

# A.3. Course Taking 

## A.3.1. Statewide breakdown by groups

> A.3.1. Statewide breakdown by groups

* for Percentage of All Courses Taken Resulted in Non-Passing Grade
  + state average decreased in sy2019-20 and increased in sy2020-21
  + state ave in sy2021 is higher than state ave in sy2018-19 (before covid-19)
  + the same groups have higher non-passing rate than state ave before and after covid-19 
  + in addition, gaps between those groups and the others increased from sy2018-19 to sy-2020-21

```{r A.3.1. Statewide breakdown by groups, message=FALSE, warning=FALSE}
course_by_race <- df_course_outcomes_by_outcome %>%
  filter(`Organization Name` == "Washington State" & 
           !is.na(`All Non-Passing Grades`)) %>%
  select_if(~!all(is.na(.))) %>%
  mutate(`All Non-Passing Grades` =  percent(`All Non-Passing Grades`))

state_ave_20_21 <- percent('11.0%')
  
course_by_race$`Grade Level` <- 
  factor(course_by_race$`Grade Level`, levels = c("9", "10", "11", "12", "All Grades"))
course_by_race$`School Year` <- 
  factor(course_by_race$`School Year`, levels = c("2020-21", "2019-20", "2018-19"))

plot_non_pass_20_21 <- course_by_race %>%
  filter(`School Year` == "2020-21") %>%
  ggplot(aes(fill= `Grade Level`,
             x= `Student Group`, 
             y=`All Non-Passing Grades`)) + 
  geom_col(position="dodge", width = 0.7) +
  geom_hline(yintercept = 0.11, linetype = "dashed") +
  geom_text(aes(0, 0.11, label = "state average = 11%"), size = 3, vjust = -0.5) +
  ggtitle("Percentage of All Courses Taken Resulted in Non-Passing Grade", 
          subtitle = "for school year 2020-21") +
  labs(x = "Student Groups", y = "All Non-Passing Grades") +
  scale_y_continuous(labels = percent, limits = c(0, 0.3)) +
  scale_fill_manual(values = uw_palette(5)) +
  geom_text(aes(label = `All Non-Passing Grades`), position = position_dodge(0.9),
            hjust = 0, vjust = 0.25, colour = "black", size = 1.5) +
  theme_light() +
  coord_flip() +
  theme(plot.title = element_text(face = "bold", size = 13, hjust = 0.5),
        plot.subtitle = element_text(hjust = 0.5),
        legend.background = element_rect(fill = "white", size = 1, colour = "white"),
        legend.title=element_text(size = 10),
        legend.text=element_text(size = 7),
 #       legend.justification = c(0, 1),
 #       legend.position = c(0.9, 0.75),
        axis.text.x  = element_text(angle=45, vjust=0.5, size=7),
        axis.title.x  = element_text(size=14),
        axis.title.y  = element_text(size=14),
        strip.text.x = element_text(size = 12, colour = "black")) 

plot_non_pass_19_20 <- course_by_race %>%
  filter(`School Year` == "2019-20") %>%
  ggplot(aes(fill= `Grade Level`,
             x= `Student Group`, 
             y=`All Non-Passing Grades`)) + 
  geom_col(position="dodge", width = 0.7) +
  geom_hline(yintercept = 0.048, linetype = "dashed") +
  geom_text(aes(0, 0.048, label = "state average = 4.8%"), size = 3, vjust = -0.5) +
  ggtitle("Percentage of All Courses Taken Resulted in Non-Passing Grade", 
          subtitle = "for school year 2019-20") +
  labs(x = "Student Groups", y = "All Non-Passing Grades") +
  scale_y_continuous(labels = percent, limits = c(0, 0.3)) +
  scale_fill_manual(values = uw_palette(5)) +
  geom_text(aes(label = `All Non-Passing Grades`), position = position_dodge(0.9),
            hjust = 0, vjust = 0.25, colour = "black", size = 1.5) +
  theme_light() +
  coord_flip() +
  theme(plot.title = element_text(face = "bold", size = 13, hjust = 0.5),
        plot.subtitle = element_text(hjust = 0.5),
        legend.background = element_rect(fill = "white", size = 1, colour = "white"),
        legend.title=element_text(size = 10),
        legend.text=element_text(size = 7),
 #       legend.justification = c(0, 1),
 #       legend.position = c(0.9, 0.75),
        axis.text.x  = element_text(angle=45, vjust=0.5, size=7),
        axis.title.x  = element_text(size=14),
        axis.title.y  = element_text(size=14),
        strip.text.x = element_text(size = 12, colour = "black"))

 plot_non_pass_18_19 <- course_by_race %>%
  filter(`School Year` == "2018-19") %>%
  ggplot(aes(fill= `Grade Level`,
             x= `Student Group`, 
             y=`All Non-Passing Grades`)) + 
  geom_col(position="dodge", width = 0.7) +
  geom_hline(yintercept = 0.074, linetype = "dashed") +
  geom_text(aes(0, 0.074, label = "state average = 7.4%"), size = 3, vjust = -0.5) +
  ggtitle("Percentage of All Courses Taken Resulted in Non-Passing Grade", 
          subtitle = "for school year 2018-19") +
   labs(x = "Student Groups", y = "All Non-Passing Grades") +
  scale_y_continuous(labels = percent, limits = c(0, 0.3)) +
  scale_fill_manual(values = uw_palette(5)) +
  geom_text(aes(label = `All Non-Passing Grades`), position = position_dodge(0.9),
            hjust = 0, vjust = 0.25, colour = "black", size = 1.5) +
  theme_light() +
  coord_flip() +
  theme(plot.title = element_text(face = "bold", size = 13, hjust = 0.5),
        plot.subtitle = element_text(hjust = 0.5),
        legend.background = element_rect(fill = "white", size = 1, colour = "white"),
        legend.title=element_text(size = 10),
        legend.text=element_text(size = 7),
 #       legend.justification = c(0, 1),
 #       legend.position = c(0.9, 0.75),
        axis.text.x  = element_text(angle=45, vjust=0.5, size=7),
        axis.title.x  = element_text(size=14),
        axis.title.y  = element_text(size=14),
        strip.text.x = element_text(size = 12, colour = "black"))

plot_non_pass_20_21
plot_non_pass_19_20
plot_non_pass_18_19

```

```{r A.3.1. Statewide breakdown by groups grid, eval=FALSE, message=FALSE, warning=FALSE, include=FALSE}

get_legend<-function(myggplot){
  tmp <- ggplot_gtable(ggplot_build(myggplot))
  leg <- which(sapply(tmp$grobs, function(x) x$name) == "guide-box")
  legend <- tmp$grobs[[leg]]
  return(legend)
}

legend <- get_legend(plot_non_pass_20_21)
lwidth <- sum(legend$width)

plot_all_nonpass <- grid.arrange(arrangeGrob(plot_non_pass_20_21 + theme(legend.position="none"),
                                 plot_non_pass_19_20 + theme(legend.position="none"),
                                 plot_non_pass_18_19 + theme(legend.position="none")),
                                 legend,
                                 widths=unit.c(unit(1, "npc") - lwidth, lwidth),
                                 nrow=1)

plot_all_nonpass

ggsave("section_a_analysis_files/figures/A.3.1. Statewide breakdown by groups.png", plot_all_nonpass,
       width = 20, height = 40, units = "cm")

```

```{r r A.3.1.ii Statewide breakdown by income, message=FALSE, warning=FALSE}

course_by_income <- read_csv("/Users/alexliu/Documents/GitHub/evidenceforequity/A/enrollment_absence_dataset/nonpass_state_byinc.csv") %>%
  mutate(`All Non-Passing Grades` = percent(`All Non-Passing Grades`/100))

state_ave_20_21 <- percent('11.0%')
  
course_by_income$`Grade Level` <- 
  factor(course_by_income$`Grade Level`, levels = c("9", "10", "11", "12", "All Grades"))
course_by_income$`School Year` <- 
  factor(course_by_income$`School Year`, levels = c("2020-21", "2019-20", "2018-19"))

plot_nonpass_inc_20_21 <- course_by_income %>%
  filter(`School Year` == "2020-21") %>%
  ggplot(aes(fill= `Grade Level`,
             x= `Student Group`, 
             y=`All Non-Passing Grades`)) + 
  geom_col(position="dodge", width = 0.7) +
  geom_hline(yintercept = 0.11, linetype = "dashed") +
  geom_text(aes(0, 0.11, label = "state average = 11%"), size = 3, vjust = -0.5) +
  ggtitle("Percentage of All Courses Taken Resulted in Non-Passing Grade", 
          subtitle = "for school year 2020-21") +
  labs(x = "Student Groups", y = "All Non-Passing Grades") +
  scale_y_continuous(labels = percent, limits = c(0, 0.2)) +
  scale_fill_manual(values = uw_palette(5)) +
  geom_text(aes(label = `All Non-Passing Grades`), position = position_dodge(0.75),
            hjust = -0.1, vjust = 0.5, colour = "black", size = 2) +
  theme_light() +
  coord_flip() +
  theme(plot.title = element_text(face = "bold", size = 13, hjust = 0.5),
        plot.subtitle = element_text(hjust = 0.5),
        legend.background = element_rect(fill = "white", size = 1, colour = "white"),
        legend.title=element_text(size = 10),
        legend.text=element_text(size = 7),
        axis.text.x  = element_text(angle=45, vjust=0.5, size=7),
        axis.title.x  = element_text(size=14),
        axis.title.y  = element_text(size=14),
        strip.text.x = element_text(size = 12, colour = "black")) 

#ggsave("/Users/alexliu/Desktop/A.3.1.ii Statewide breakdown by income SY2021.png")

plot_nonpass_inc_19_20 <- course_by_income %>%
  filter(`School Year` == "2019-20") %>%
  ggplot(aes(fill= `Grade Level`,
             x= `Student Group`, 
             y=`All Non-Passing Grades`)) + 
  geom_col(position="dodge", width = 0.7) +
  geom_hline(yintercept = 0.048, linetype = "dashed") +
  geom_text(aes(0, 0.048, label = "state average = 4.8%"), size = 3, vjust = -0.5) +
  ggtitle("Percentage of All Courses Taken Resulted in Non-Passing Grade", 
          subtitle = "for school year 2019-20") +
  labs(x = "Student Groups", y = "All Non-Passing Grades") +
  scale_y_continuous(labels = percent, limits = c(0, 0.2)) +
  scale_fill_manual(values = uw_palette(5)) +
  geom_text(aes(label = `All Non-Passing Grades`), position = position_dodge(0.75),
            hjust = -0.1, vjust = 0.5, colour = "black", size = 2) +
  theme_light() +
  coord_flip() +
  theme(plot.title = element_text(face = "bold", size = 13, hjust = 0.5),
        plot.subtitle = element_text(hjust = 0.5),
        legend.background = element_rect(fill = "white", size = 1, colour = "white"),
        legend.title=element_text(size = 10),
        legend.text=element_text(size = 7),
        axis.text.x  = element_text(angle=45, vjust=0.5, size=7),
        axis.title.x  = element_text(size=14),
        axis.title.y  = element_text(size=14),
        strip.text.x = element_text(size = 12, colour = "black"))

#ggsave("/Users/alexliu/Desktop/A.3.1.ii Statewide breakdown by income SY1920.png")

 plot_nonpass_inc_18_19 <- course_by_income %>%
  filter(`School Year` == "2018-19") %>%
  ggplot(aes(fill= `Grade Level`,
             x= `Student Group`, 
             y=`All Non-Passing Grades`)) + 
  geom_col(position="dodge", width = 0.7) +
  geom_hline(yintercept = 0.074, linetype = "dashed") +
  geom_text(aes(0, 0.074, label = "state average = 7.4%"), size = 3, vjust = -0.5) +
  ggtitle("Percentage of All Courses Taken Resulted in Non-Passing Grade", 
          subtitle = "for school year 2018-19") +
   labs(x = "Student Groups", y = "All Non-Passing Grades") +
  scale_y_continuous(labels = percent, limits = c(0, 0.2)) +
  scale_fill_manual(values = uw_palette(5)) +
  geom_text(aes(label = `All Non-Passing Grades`), position = position_dodge(0.75),
            hjust = -0.1, vjust = 0.5, colour = "black", size = 2) +
  theme_light() +
  coord_flip() +
  theme(plot.title = element_text(face = "bold", size = 13, hjust = 0.5),
        plot.subtitle = element_text(hjust = 0.5),
        legend.background = element_rect(fill = "white", size = 1, colour = "white"),
        legend.title=element_text(size = 10),
        legend.text=element_text(size = 7),
        axis.text.x  = element_text(angle=45, vjust=0.5, size=7),
        axis.title.x  = element_text(size=14),
        axis.title.y  = element_text(size=14),
        strip.text.x = element_text(size = 12, colour = "black"))

#ggsave("/Users/alexliu/Desktop/A.3.1.ii Statewide breakdown by income SY1819.png")

plot_nonpass_inc_20_21
plot_nonpass_inc_19_20
plot_nonpass_inc_18_19

```

**Change/Difference is calculated by `All Non-Passing Grades`[`School Year` == "2020-21"] - `All Non-Passing Grades`[`School Year` == "2018-19"]**

## A.3.1. Statewide change (SY 2020-21 - SY 2018-19)

```{r A.3.1.2.i Statewide breakdown by race CHANGE, message=FALSE, warning=FALSE}

course_by_race <- course_by_race %>%
  group_by(`Student Group`, `Grade Level`) %>%
  mutate(Change = `All Non-Passing Grades`[`School Year` == "2020-21"] - `All Non-Passing Grades`[`School Year` == "2018-19"])

course_by_race %>%
  filter(`School Year` == "2020-21") %>%
  ggplot(aes(fill= `Grade Level`,
             x= `Student Group`, 
             y= Change)) + 
  geom_col(position="dodge", width = 0.7) +
  geom_hline(yintercept = 0, linetype = "dashed") +
  ggtitle("Change in Percent of All Courses Taken Resulted in Non-Passing Grade", 
          subtitle = "between SY2018-19 and SY2020-21") +
  labs(x = "Student Groups", 
       y = "Change in Percentage",
       caption = "A positive value means that the percentage of all courses taken resulted in 
       non-passing grade has increased between 2018-19 and 2020-21 for the given student group") +
  scale_y_continuous(labels = percent, limits = c(-0.005, 0.12)) +
  scale_fill_manual(values = uw_palette(5)) +
  geom_text(aes(label = `Change`), position = position_dodge(0.75),
            hjust = -0.1, vjust = 0.5, colour = "black", size = 1.5) +
  theme_light() +
  coord_flip() +
  theme(plot.title = element_text(face = "bold", size = 12, hjust = 0.45),
        plot.subtitle = element_text(hjust = 0.5),
        plot.caption = element_text(hjust = 1, size = 9, color = "grey50"),
        legend.background = element_rect(fill = "white", size = 1, colour = "white"),
        legend.title=element_text(size = 10),
        legend.text=element_text(size = 7),
        axis.text.x  = element_text(angle=45, vjust=0.5, size=7),
        axis.title.x  = element_text(size=12),
        axis.title.y  = element_text(size=12),
        strip.text.x = element_text(size = 12, colour = "black"))

#ggsave("/Users/alexliu/Desktop/A.3.1.2.i Statewide breakdown by race change.png")

```

```{r A.3.1.2.ii Statewide breakdown by income CHANGE, message=FALSE, warning=FALSE}

course_by_income <- course_by_income %>%
  group_by(`Student Group`, `Grade Level`) %>%
  mutate(Change = `All Non-Passing Grades`[`School Year` == "2020-21"] - `All Non-Passing Grades`[`School Year` == "2018-19"])

course_by_income %>%
  filter(`School Year` == "2020-21") %>%
  ggplot(aes(fill= `Grade Level`,
             x= `Student Group`, 
             y= Change)) + 
  geom_col(position="dodge", width = 0.7) +
 # geom_hline(yintercept = 0, linetype = "dashed") +
  ggtitle("Change in Percent of All Courses Taken Resulted in Non-Passing Grade", 
          subtitle = "between SY2018-19 and SY2020-21") +
  labs(x = "Student Groups", 
       y = "Change in Percentage",
       caption = "A positive value means that the percent of all courses taken resulted in 
       non-passing grade has increased between 2018-19 and 2020-21 for the given student group") +
  scale_y_continuous(labels = percent, limits = c(0, 0.08)) +
  scale_fill_manual(values = uw_palette(5)) +
  geom_text(aes(label = `Change`), position = position_dodge(0.75),
            hjust = -0.1, vjust = 0.5, colour = "black", size = 2) +
  theme_light() +
  coord_flip() +
  theme(plot.title = element_text(face = "bold", size = 13, hjust = 0.5),
        plot.subtitle = element_text(hjust = 0.5),
        plot.caption = element_text(hjust = 1, size = 9, color = "grey50"),
        legend.background = element_rect(fill = "white", size = 1, colour = "white"),
        legend.title=element_text(size = 10),
        legend.text=element_text(size = 7),
        axis.text.x  = element_text(angle=45, vjust=0.5, size=7),
        axis.title.x  = element_text(size=12),
        axis.title.y  = element_text(size=12),
        strip.text.x = element_text(size = 12, colour = "black"))

#ggsave("/Users/alexliu/Desktop/A.3.1.2.ii Statewide breakdown by income change.png")

```

## A.3.2 Spatial Maps 

> A.3.2.1 Geographical differences across districts in all non-passing grade and numerical failing grade  (SY2020-21 - SY2018-19)

students of color (excluding Asian)

For spatial plots: missing data (grey areas) results from 

1. missing and suppression at district level; e.g. Olympia School District
2. some districts have data for only one of the SYs, then the changes are going to be NAs; e.g. Rainier Valley Leadership Academy; e.g. Everett School District
3. some districts in the shape file do not appear in the ospi data (shows in "match district names with shape file" section), vice versa; e.g. Rainier Valley Leadership Academy

*data for comparison among ethnicity groups was downloaded directly from OSPI website.*

*data for comparison between income groups was downloaded and scraped for each district and manually compiled*

* Difference calculated by %nonpass (or %numerical failing) in SY2020-21 minus %nonpass (or %numerical failing) in SY 2018-19
  + darker purple color indicates more increase in %nonpass (or %numerical failing) in SY2020-21

```{r A.3.2.1.i The Difference in all non-passing grade from 2018-19 to 2020-21 (white and nonwhite), echo=FALSE, message=FALSE, warning=FALSE}

df_nonpass_race_raw <- df_course_outcomes_by_outcome %>%
  select(c(`Organization Name`, `School Year`, 
           `Student Group`, `Grade Level`, 
           `All Non-Passing Grades`)) %>%
  filter(!is.na(`All Non-Passing Grades`) &
           `School Year` != "2019-20") %>% 
  mutate(`All Non-Passing Grades` =  percent(`All Non-Passing Grades`))

#cannot use dcast due to uneven length for each year:
#split the df by school year; rename `All Non-Passing Grades` column by SY; 
df_nonpass_race_1819 <- filter(df_nonpass_race_raw, `School Year` != "2020-21") 
colnames(df_nonpass_race_1819)[5] <- "SY2018-19"
  
df_nonpass_race_2021 <- filter(df_nonpass_race_raw, `School Year` == "2020-21")
colnames(df_nonpass_race_2021)[5] <- "SY2020-21"

#merge yearly dfs and calculate the change
df_nonpass_race <- merge(x = df_nonpass_race_2021, y = df_nonpass_race_1819, 
                         by = c("Organization Name", "Student Group", "Grade Level"), 
                         all = TRUE) %>%
  select(!c("School Year.x", "School Year.y")) %>%
  mutate(Change = `SY2020-21` - `SY2018-19` ) %>%
  filter(!is.na(Change)) %>%
  #filter(Change >= -1) %>%
  mutate(Race = NA) 

for (i in 1:nrow(df_nonpass_race)) {
  if (df_nonpass_race[i, "Student Group"] == "White") {
    df_nonpass_race[i, "Race"] <- "White"
  } else if (df_nonpass_race[i, "Student Group"] == "Asian") {
    df_nonpass_race[i, "Race"] <- "Asian"
  } else {
    df_nonpass_race[i, "Race"] <- "Non-white"
  }
}

df_nonpass_race_grouped <- aggregate(df_nonpass_race$Change, 
                           list(df_nonpass_race$`Organization Name`, 
                                df_nonpass_race$`Grade Level`,
                                df_nonpass_race$Race), 
                           FUN=mean)

names(df_nonpass_race_grouped) <- c("Districts", "Grade Level", "Race", "Change")
df_nonpass_race_grouped <- df_nonpass_race_grouped %>%
  arrange(`Grade Level`, Districts, Race) %>%
  filter(`Grade Level` == "All Grades")

# Shape file
wa <- lea_get("wa")%>% 
  sf::st_as_sf() 

df_nonpass_white <- filter(df_nonpass_race_grouped, Race == "White") 
wa_nonpass_white <- full_join(wa, df_nonpass_white, by = c("NAME" = "Districts"), copy=TRUE)

df_nonpass_nonwhite <- filter(df_nonpass_race_grouped, Race == "Non-white") 
wa_nonpass_nonwhite <- full_join(wa, df_nonpass_nonwhite, by = c("NAME" = "Districts"), copy=TRUE)

wa_nonpass_white %>% 
  sf::st_as_sf() %>% 
  ggplot() +
  geom_sf(aes(fill = Change), size = .25) +
  scale_fill_gradient2(low="#e8e3d3", high="#4b2e83", name="") +
  theme_void() +
  labs(title="Change in Percent of All Courses Taken Resulted in No Credit",
       subtitle = "for white students between SY2018-19 and SY2020-21",
       caption = "Note: grey areas indicate districts with unavaible data")

#ggsave("/Users/alexliu/Desktop/A.3.2.1.i nonpass diff year white.png")

wa_nonpass_nonwhite %>% 
  sf::st_as_sf() %>% 
  ggplot() +
  geom_sf(aes(fill = Change), size = .25) +
  scale_fill_gradient2(low="#e8e3d3", high="#4b2e83", name="") +
  theme_void() +
  labs(title="Change in Percent of All Courses Taken Resulted in No Credit",
       subtitle = "for students of color between SY2018-19 and SY2020-21",
       caption = "Note: grey areas indicate districts with unavaible data")

#ggsave("/Users/alexliu/Desktop/A.3.2.1.i nonpass diff year nonwhite.png")

```

```{r 3.2 match district names with shape file, eval=FALSE, include=FALSE}
#matching district names
df_name <- unique(df_nonpass_race_grouped$Districts)
shape_name <- sort(unique(wa$NAME))
`%!in%` <- Negate(`%in%`)
for (i in 1:length(df_name)) {
  if (df_name[i] %!in% shape_name) {
    print(i)
    print(df_name[i])
  }
}
for (j in 1:length(shape_name)) {
  if (shape_name[j] %!in% df_name) {
    print(j)
    print(shape_name[j])
  }
}
#district names need to be(can be) manually adjusted for geometry data: 
#df_name[108]"North Beach School District No. 64" = shape_name[159] "North Beach School District"
#df_name[151]"Seattle School District No. 1" = shape_name[220]"Seattle Public Schools"
#df_name[187]"Wellpinit School District #49" = shape_name[279]"Wellpinit School District"
## 7 schools in our dataset have no matches in shape file
```
  
```{r A.3.2.1.ii The Difference in num fail grade from 2018-19 to 2020-21 (white and nonwhite), echo=FALSE, message=FALSE, warning=FALSE}

df_numfail_race_raw <- df_course_outcomes_by_outcome %>%
  select(c(`Organization Name`, `School Year`, 
           `Student Group`, `Grade Level`, 
           `Numerical Failing Grades`)) %>%
  filter(!is.na(`Numerical Failing Grades`) &
           `School Year` != "2019-20") %>% 
  mutate(`Numerical Failing Grades` =  percent(`Numerical Failing Grades`))

#cannot use dcast due to uneven length for each year:
#split the df by school year; rename `All Non-Passing Grades` column by SY; 
df_numfail_race_1819 <- filter(df_numfail_race_raw, `School Year` != "2020-21") 
colnames(df_numfail_race_1819)[5] <- "SY2018-19"
  
df_numfail_race_2021 <- filter(df_numfail_race_raw, `School Year` == "2020-21")
colnames(df_numfail_race_2021)[5] <- "SY2020-21"

#merge yearly dfs and calculate the change
df_numfail_race <- merge(x = df_numfail_race_2021, y = df_numfail_race_1819, 
                         by = c("Organization Name", "Student Group", "Grade Level"), 
                         all = TRUE) %>%
  select(!c("School Year.x", "School Year.y")) %>%
  mutate(Change = `SY2020-21` - `SY2018-19` ) %>%
  filter(!is.na(Change)) %>%
  #filter(Change >= -1) %>%
  mutate(Race = NA) 

for (i in 1:nrow(df_numfail_race)) {
  if (df_numfail_race[i, "Student Group"] == "White") {
    df_numfail_race[i, "Race"] <- "White"
  } else if (df_numfail_race[i, "Student Group"] == "Asian") {
    df_numfail_race[i, "Race"] <- "Asian"
  } else {
    df_numfail_race[i, "Race"] <- "Non-white"
  }
}

df_numfail_race_grouped <- aggregate(df_numfail_race$Change, 
                           list(df_numfail_race$`Organization Name`, 
                                df_numfail_race$`Grade Level`,
                                df_numfail_race$Race), 
                           FUN=mean)

names(df_numfail_race_grouped) <- c("Districts", "Grade Level", "Race", "Change")
df_numfail_race_grouped <- df_numfail_race_grouped %>%
  arrange(`Grade Level`, Districts, Race) %>%
  filter(`Grade Level` == "All Grades")

# Shape file
wa <- lea_get("wa")%>% 
  sf::st_as_sf() 

df_numfail_white <- filter(df_numfail_race_grouped, Race == "White") 
wa_numfail_white <- full_join(wa, df_numfail_white, by = c("NAME" = "Districts"), copy=TRUE)

df_numfail_nonwhite <- filter(df_numfail_race_grouped, Race == "Non-white") 
wa_numfail_nonwhite <- full_join(wa, df_numfail_nonwhite, by = c("NAME" = "Districts"), copy=TRUE)

wa_numfail_white %>% 
  sf::st_as_sf() %>% 
  ggplot() +
  geom_sf(aes(fill = Change), size = .25) +
  scale_fill_gradient2(low="#e8e3d3", high="#4b2e83", name="") +
  theme_void() +
  labs(title="Change in Percent of All Courses Taken Resulted in Numerical Failing Grade",
       subtitle = "for white students between SY2018-19 and SY2020-21",
       caption = "Note: grey areas indicate districts with unavaible data")

#ggsave("/Users/alexliu/Desktop/A.3.2.1.ii numfail diff year white.png")

wa_numfail_nonwhite %>% 
  sf::st_as_sf() %>% 
  ggplot() +
  geom_sf(aes(fill = Change), size = .25) +
  scale_fill_gradient2(low="#e8e3d3", high="#4b2e83", name="") +
  theme_void() +
  labs(title="Change in Percent of All Courses Taken Resulted in Numerical Failing Grade",
       subtitle = "for students of color between SY2018-19 and SY2020-21",
       caption = "Note: grey areas indicate districts with unavaible data")

# ggsave("/Users/alexliu/Desktop/A.3.2.1.ii numfail diff year nonwhite.png")

```

```{r A.3.2.1.iii The Difference in all non-passing grade from 2018-19 to 2020-21 (low-income and non-low income), message=FALSE}

wa <- lea_get("wa")%>% 
  sf::st_as_sf() 

df_nonpass_inc_raw <- read_csv("/Users/alexliu/Documents/GitHub/evidenceforequity/A/enrollment_absence_dataset/raw/raw_nonpass_district_byinc.csv")

for (i in 1:nrow(df_nonpass_inc_raw)) {
  if (is.na(df_nonpass_inc_raw$`2018-19`[i]) & !is.na(df_nonpass_inc_raw$add2[i])) {
    df_nonpass_inc_raw$`2018-19`[i] <- df_nonpass_inc_raw$`2019-20`[i]
    df_nonpass_inc_raw$`2019-20`[i] <- df_nonpass_inc_raw$`2020-21`[i]
    df_nonpass_inc_raw$`2020-21`[i] <- df_nonpass_inc_raw$add2[i]
  }
}

df_nonpass_inc <- df_nonpass_inc_raw %>%
  select(c("StudentGroup", "District", "2018-19", "2019-20", "2020-21")) %>%
  mutate(`2018-19` = percent(`2018-19`),
         `2019-20` = percent(`2019-20`),
         `2020-21` = percent(`2020-21`)) %>%
  mutate(diff_2021_1819 = `2020-21` - `2018-19`) %>%
  arrange(District) %>%
  group_by(District) %>% 
  mutate(diff_low_nonlow = (`2020-21`[StudentGroup == "Non-Low Income"] - `2020-21`[StudentGroup == "Low-Income"])*-1)

#write.csv(df_nonpass_inc, "/Users/alexliu/Documents/GitHub/evidenceforequity/A/enrollment_absence_dataset/nonpass_byincome.csv",row.names=FALSE)

df_nonpass_low <- filter(df_nonpass_inc, StudentGroup == "Low-Income")
wa_nonpass_low <- full_join(wa, df_nonpass_low, by = c("NAME" = "District"), copy=TRUE) 
df_nonpass_nonlow <- filter(df_nonpass_inc, StudentGroup == "Non-Low Income")
wa_nonpass_nonlow <- full_join(wa, df_nonpass_nonlow, by = c("NAME" = "District"), copy=TRUE) 

wa_nonpass_low %>% 
  sf::st_as_sf() %>% 
  ggplot() +
  geom_sf(aes(fill = diff_2021_1819), size = .25) +
  scale_fill_gradient2(low="#e8e3d3", high="#4b2e83", name="") +
  theme_void() +
  labs(title="Change in Percent of All Courses Taken Resulted in No Credit",
       subtitle = "for low-income student group between SY2018-19 and SY2020-21",
       caption = "Note: grey areas indicate districts with unavaible data")

#ggsave("/Users/alexliu/Desktop/A.3.2.1.iii nonpass diff year low income.png")

wa_nonpass_nonlow %>% 
  sf::st_as_sf() %>% 
  ggplot() +
  geom_sf(aes(fill = diff_2021_1819), size = .25) +
  scale_fill_gradient2(low="#e8e3d3", high="#4b2e83", name="") +
  theme_void() +
  labs(title="Change in Percent of All Courses Taken Resulted in No Credit",
       subtitle = "for non-low income student group between SY2018-19 and SY2020-21",
       caption = "Note: grey areas indicate districts with unavaible data")

#ggsave("/Users/alexliu/Desktop/A.3.2.1.iii nonpass diff year nonlow income.png")

```

```{r A.3.2.1.iii match district names with shape file, eval=FALSE, include=FALSE}
df_name <- unique(df_nonpass_inc$District)
shape_name <- sort(unique(wa$NAME))
`%!in%` <- Negate(`%in%`)
for (i in 1:length(df_name)) {
  if (df_name[i] %!in% shape_name) {
    print(i)
    print(df_name[i])
  }
}
for (j in 1:length(shape_name)) {
  if (shape_name[j] %!in% df_name) {
    print(j)
    print(shape_name[j])
  }
}

```

```{r A.3.2.1.iv The Difference in numerical fail grade from 2018-19 to 2020-21 (low-income and non-low income), message=FALSE, warning=FALSE}

wa <- lea_get("wa")%>% 
  sf::st_as_sf() 

df_numfail_inc_raw <- read_csv("/Users/alexliu/Documents/GitHub/evidenceforequity/A/enrollment_absence_dataset/raw/raw_numfail_district_byinc.csv")

for (i in 1:nrow(df_numfail_inc_raw)) {
  if (is.na(df_numfail_inc_raw$`2018-19`[i]) & !is.na(df_numfail_inc_raw$add2[i])) {
    df_numfail_inc_raw$`2018-19`[i] <- df_numfail_inc_raw$`2019-20`[i]
    df_numfail_inc_raw$`2019-20`[i] <- df_numfail_inc_raw$`2020-21`[i]
    df_numfail_inc_raw$`2020-21`[i] <- df_numfail_inc_raw$add2[i]
  }
}

df_numfail_inc <- df_numfail_inc_raw %>%
  select(c("StudentGroup", "District", "2018-19", "2019-20", "2020-21")) %>%
  mutate(`2018-19` = percent(`2018-19`),
         `2019-20` = percent(`2019-20`),
         `2020-21` = percent(`2020-21`)) %>%
  mutate(diff_2021_1819 = `2020-21` - `2018-19`) %>%
  arrange(District) %>%
  group_by(District) %>% 
  mutate(diff_low_nonlow = (`2020-21`[StudentGroup == "Non-Low Income"] - `2020-21`[StudentGroup == "Low-Income"])*-1)

df_numfail_low <- filter(df_numfail_inc, StudentGroup == "Low-Income")
wa_numfail_low <- full_join(wa, df_numfail_low, by = c("NAME" = "District"), copy=TRUE) 
df_numfail_nonlow <- filter(df_numfail_inc, StudentGroup == "Non-Low Income")
wa_numfail_nonlow <- full_join(wa, df_numfail_nonlow, by = c("NAME" = "District"), copy=TRUE) 

wa_numfail_low %>% 
  sf::st_as_sf() %>% 
  ggplot() +
  geom_sf(aes(fill = diff_2021_1819), size = .25) +
  scale_fill_gradient2(low="#e8e3d3", high="#4b2e83", name="") +
  theme_void() +
  labs(title="Change in Percent of All Courses Taken Resulted in Numerical Failing Grade",
       subtitle = "for low-income student group between SY2018-19 and SY2020-21",
       caption = "Note: grey areas indicate districts with unavaible data")

#ggsave("/Users/alexliu/Desktop/A.3.2.1.iv num fail diff year low income.png")

wa_numfail_nonlow %>% 
  sf::st_as_sf() %>% 
  ggplot() +
  geom_sf(aes(fill = diff_2021_1819), size = .25) +
  scale_fill_gradient2(low="#e8e3d3", high="#4b2e83", name="") +
  theme_void() +
  labs(title="Change in Percent of All Courses Taken Resulted in Numerical Failing Grade",
       subtitle = "for non-low income student group between SY2018-19 and SY2020-21",
       caption = "Note: grey areas indicate districts with unavaible data")

#ggsave("/Users/alexliu/Desktop/A.3.2.1.iv num fail diff year nonlow income.png")

```

```{r A.3.2.1.iv match district names with shape file, eval=FALSE, include=FALSE}
df_name <- unique(df_numfail_inc$District)
shape_name <- sort(unique(wa$NAME))
`%!in%` <- Negate(`%in%`)
for (i in 1:length(df_name)) {
  if (df_name[i] %!in% shape_name) {
    print(i)
    print(df_name[i])
  }
}
for (j in 1:length(shape_name)) {
  if (shape_name[j] %!in% df_name) {
    print(j)
    print(shape_name[j])
  }
}
```

> A.3.2.2 The gap in all non-passing and numerical failing in SY2020-21 between students of color and white for each district

* Gap calculated by %nonpass among low-income minus %nonpass among non-low income in SY2020-21
  + darker purple color indicates more nonpass/num failing grades among students of color
  + darker purple color indicates more nonpass/num failing grades among low-income students

```{r A.3.2.2.i The gap in all non-passing in 2020-21 between students of color and white for each district, echo=FALSE, message=FALSE, warning=FALSE}

df_nonpass_race_gap_raw <- df_course_outcomes_by_outcome %>%
  select(c(`Organization Name`, `School Year`, 
           `Student Group`, `Grade Level`, 
           `All Non-Passing Grades`)) %>%
  mutate(`All Non-Passing Grades` =  percent(`All Non-Passing Grades`)) %>%
  filter(!is.na(`All Non-Passing Grades`) &
          `School Year` == "2020-21" &
          `Student Group` != "Asian") 

for (i in 1:nrow(df_nonpass_race_gap_raw)) {
  if (df_nonpass_race_gap_raw[i, "Student Group"] == "White") {
    df_nonpass_race_gap_raw[i, "Race"] <- "White"
  } else {
    df_nonpass_race_gap_raw[i, "Race"] <- "Non-white"
  }
}
df_nonpass_race_gap_grouped <- aggregate(df_nonpass_race_gap_raw$`All Non-Passing Grades`, 
                           list(df_nonpass_race_gap_raw$`Organization Name`, 
                                df_nonpass_race_gap_raw$`Grade Level`,
                                df_nonpass_race_gap_raw$Race), 
                           FUN=mean)
names(df_nonpass_race_gap_grouped) <- c("Districts", 
                                        "Grade Level", 
                                        "Race", 
                                        "Ave All Non-Passing Grades")

df_nonpass_gap_white <- filter(df_nonpass_race_gap_grouped, Race == "White") 
colnames(df_nonpass_gap_white)[4] <- "Ave All Non-Passing Grades White"
df_nonpass_gap_nonwhite <- filter(df_nonpass_race_gap_grouped, Race == "Non-white") 
colnames(df_nonpass_gap_nonwhite)[4] <- "Ave All Non-Passing Grades Non_White"

df_nonpass_race_gap <- merge(x = df_nonpass_gap_white, 
                             y = df_nonpass_gap_nonwhite, 
                             by = c("Districts", "Grade Level"), 
                             all = TRUE) %>%
  select(!c("Race.x", "Race.y")) %>%
  mutate(Change = `Ave All Non-Passing Grades Non_White` - `Ave All Non-Passing Grades White`) %>%
  arrange(`Grade Level`, Districts) %>%
  filter(`Grade Level` == "All Grades") 

wa <- lea_get("wa")%>% 
  sf::st_as_sf() 

wa_nonpass_race_gap <- full_join(wa, df_nonpass_race_gap, by = c("NAME" = "Districts"), copy=TRUE)

wa_nonpass_race_gap %>% 
  sf::st_as_sf() %>% 
  ggplot() +
  geom_sf(aes(fill = Change), size = .25) +
  scale_fill_gradient2(low="#e8e3d3", high="#4b2e83", name="") +
  theme_void() +
  labs(title="Gap in All Courses Taken Resulted in No Credit",
       subtitle = "between students of color and white students in SY2020-21",
       caption = "Note: grey areas indicate districts with unavaible data")

#ggsave("/Users/alexliu/Desktop/A.3.2.2.i nonpass gap nonwhite white.png")

```

```{r A.3.2.2.ii The gap in num fail grade in 2020-21 between students of color and white for each district, echo=FALSE, message=FALSE, warning=FALSE}

df_numfail_race_gap_raw <- df_course_outcomes_by_outcome %>%
  select(c(`Organization Name`, `School Year`, 
           `Student Group`, `Grade Level`, 
           `Numerical Failing Grades`)) %>%
  mutate(`Numerical Failing Grades` =  percent(`Numerical Failing Grades`)) %>%
  filter(!is.na(`Numerical Failing Grades`) &
          `School Year` == "2020-21" &
          `Student Group` != "Asian") 

for (i in 1:nrow(df_numfail_race_gap_raw)) {
  if (df_numfail_race_gap_raw[i, "Student Group"] == "White") {
    df_numfail_race_gap_raw[i, "Race"] <- "White"
  } else {
    df_numfail_race_gap_raw[i, "Race"] <- "Non-white"
  }
}
df_numfail_race_gap_grouped <- aggregate(df_numfail_race_gap_raw$`Numerical Failing Grades`, 
                           list(df_numfail_race_gap_raw$`Organization Name`, 
                                df_numfail_race_gap_raw$`Grade Level`,
                                df_numfail_race_gap_raw$Race), 
                           FUN=mean)
names(df_numfail_race_gap_grouped) <- c("Districts", 
                                        "Grade Level", 
                                        "Race", 
                                        "Ave All Num Fail Grades")

df_numfail_gap_white <- filter(df_numfail_race_gap_grouped, Race == "White") 
colnames(df_numfail_gap_white)[4] <- "Ave All Num Fail Grades White"
df_numfail_gap_nonwhite <- filter(df_nonpass_race_gap_grouped, Race == "Non-white") 
colnames(df_numfail_gap_nonwhite)[4] <- "Ave All Num Fail Grades Non_White"

df_numfail_race_gap <- merge(x = df_numfail_gap_white, 
                             y = df_numfail_gap_nonwhite, 
                             by = c("Districts", "Grade Level"), 
                             all = TRUE) %>%
  select(!c("Race.x", "Race.y")) %>%
  mutate(Change = `Ave All Num Fail Grades Non_White` - `Ave All Num Fail Grades White`) %>%
  arrange(`Grade Level`, Districts) %>%
  filter(`Grade Level` == "All Grades") 

wa <- lea_get("wa")%>% 
  sf::st_as_sf() 

wa_numfail_race_gap <- full_join(wa, df_numfail_race_gap, by = c("NAME" = "Districts"), copy=TRUE)

wa_numfail_race_gap %>% 
  sf::st_as_sf() %>% 
  ggplot() +
  geom_sf(aes(fill = Change), size = .25) +
  scale_fill_gradient2(low="#e8e3d3", high="#4b2e83", name="") +
  theme_void() +
  labs(title="Gap in All Courses Taken Resulted in Numerical Failing Grade",
       subtitle = "between students of color and white students in SY2020-21",
       caption = "Note: grey areas indicate districts with unavaible data")

#ggsave("/Users/alexliu/Desktop/A.3.2.2.ii num fail gap nonwhite white.png")

```

> A.3.2.2 The gap in all non-passing and numerical failing in SY2020-21 between low-income and non-low income students for each district

```{r A.3.2.2.iii The gap in all non-passing in 2020-21 between students of low-income and non-low income for each district}

wa_nonpass_gap <- full_join(wa, df_nonpass_inc, by = c("NAME" = "District"), copy=TRUE) 

wa_nonpass_gap %>% 
  sf::st_as_sf() %>% 
  ggplot() +
  geom_sf(aes(fill = diff_low_nonlow), size = .25) +
  scale_fill_gradient2(low="#e8e3d3", high="#4b2e83", name="") +
  theme_void() +
  labs(title="Gap in All Courses Taken Resulted in No Credit",
       subtitle = "between low-income student group and non-low income student group in SY2020-21",
       caption = "Note: grey areas indicate districts with unavaible data")

#ggsave("/Users/alexliu/Desktop/A.3.2.2.iii nonpass gap sy2020-21.png")


```

```{r A.3.2.2.iv The gap in num fail grade in 2020-21 between students of low-income and non-low income for each district}

wa_numfail_gap <- full_join(wa, df_numfail_inc, by = c("NAME" = "District"), copy=TRUE) 

wa_numfail_gap %>% 
  sf::st_as_sf() %>% 
  ggplot() +
  geom_sf(aes(fill = diff_low_nonlow), size = .25) +
  scale_fill_gradient2(low="#e8e3d3", high="#4b2e83", name="") +
  theme_void() +
  labs(title="Gap in All Courses Taken Resulted in Numerical Failing Grade",
       subtitle = "between low-income student group and non-low income student group in SY2020-21",
       caption = "Note: grey areas indicate districts with unavaible data")

#ggsave("/Users/alexliu/Desktop/A.3.2.2.iv num fail gap sy2020-21.png")

```

# A.4. SQSS

We will do two types of analyses for the following three measures: (1) by racial-ethnic groups; (b) by income; (c) geographical distribution of gaps between groups (white vs students of color; low versus high income) across districts. 

## 9th grade on track

> State total breakdown by race-ethinicity and income 

```{r A.4.1.i 9th grade on track state total by race, message=FALSE, warning=FALSE}

# 9th grade on track: did not get a grade of D or F. The % of students that received grades of A,B, C.

df_state_ontrack_race <- df_sqss %>%
  filter(DistrictName == "State Total") %>%
  filter(Measure == "Ninth Grade on Track",
         `Grade Level` == 9) %>%
  filter(StudentGroupType %in% c("AllStudents", "FederalRaceEthnicity")) %>%
  mutate(`% On Track` = percent(Numerator/Denominator)) %>%
  mutate(SchoolYear = as.character(SchoolYear))

df_state_ontrack_race %>%
  ggplot(aes(fill= `SchoolYear`,
             x= `StudentGroup`, 
             y= `% On Track`)) + 
  geom_col(position="dodge", width = 0.7) +
  ggtitle("Percentage of 9th Grade Students on Track") +
  labs(x = "Student Groups", 
       y = "Percentage of Students on Track",
       caption = "Missing values are suppressed") +
  scale_y_continuous(labels = percent, limits = c(0, 1)) +
  scale_fill_manual(values = uw_reverse(3)) +
  geom_text(aes(label = `% On Track` ), position = position_dodge(0.75),
            hjust = -0.1, vjust = 0.5, colour = "black", size = 2) +
  theme_light() +
  coord_flip() +
  guides(fill = guide_legend(reverse = TRUE, title="School Year")) +
  theme(plot.title = element_text(face = "bold", size = 14, hjust = 0.45),
        plot.subtitle = element_text(hjust = 0.5),
        plot.caption = element_text(hjust = 1, size = 9, color = "grey50"),
        legend.background = element_rect(fill = "white", size = 1, colour = "white"),
        legend.title=element_text(size = 10),
        legend.text=element_text(size = 7),
        axis.text.x  = element_text(angle=45, vjust=0.5, size=7),
        axis.title.x  = element_text(size=12),
        axis.title.y  = element_text(size=12),
        strip.text.x = element_text(size = 12, colour = "black"))

#ggsave("/Users/alexliu/Desktop/A.4.1.i 9th grade on track state total by race sy.png")

df_state_ontrack_race %>%
  ggplot(aes(fill= `StudentGroup`,
             x= `SchoolYear`, 
             y= `% On Track`)) + 
  geom_col(position="dodge", width = 0.7) +
  ggtitle("Percentage of 9th Grade Students on Track") +
  labs(x = "School Years", 
       y = "Percentage of Students on Track",
       caption = "Missing values are suppressed") +
  scale_y_continuous(labels = percent, limits = c(0, 1)) +
  scale_fill_manual(values = uw_reverse(8)) +
  geom_text(aes(label = `% On Track` ), position = position_dodge(0.75),
            hjust = -0.1, vjust = 0.5, colour = "black", size = 2) +
  theme_light() +
  coord_flip() +
  guides(fill = guide_legend(reverse = TRUE, title="Student Group")) +
  theme(plot.title = element_text(face = "bold", size = 14, hjust = 0.45),
        plot.subtitle = element_text(hjust = 0.5),
        plot.caption = element_text(hjust = 1, size = 9, color = "grey50"),
        legend.background = element_rect(fill = "white", size = 1, colour = "white"),
        legend.title=element_text(size = 10),
        legend.text=element_text(size = 7),
        axis.text.x  = element_text(angle=45, vjust=0.5, size=7),
        axis.title.x  = element_text(size=12),
        axis.title.y  = element_text(size=12),
        strip.text.x = element_text(size = 12, colour = "black"))

#ggsave("/Users/alexliu/Desktop/A.4.1.i 9th grade on track state total by race stugroup.png")


```

```{r A.4.1.ii 9th grade on track state total by income}

df_state_ontrack_inc <- df_sqss %>%
  filter(DistrictName == "State Total") %>%
  filter(Measure == "Ninth Grade on Track",
         `Grade Level` == 9) %>%
  filter(StudentGroupType %in% c("AllStudents", "Income")) %>%
  mutate(`% On Track` = percent(Numerator/Denominator)) %>%
  mutate(SchoolYear = as.character(SchoolYear))

df_state_ontrack_inc %>%
  ggplot(aes(fill= `SchoolYear`,
             x= `StudentGroup`, 
             y= `% On Track`)) + 
  geom_col(position="dodge", width = 0.7) +
  ggtitle("Percentage of 9th Grade Students on Track") +
  labs(x = "Student Groups", 
       y = "Percentage of Students on Track") +
  scale_y_continuous(labels = percent, limits = c(0, 1)) +
  scale_fill_manual(values = uw_reverse(3)) +
  geom_text(aes(label = `% On Track` ), position = position_dodge(0.75),
            hjust = -0.1, vjust = 0.5, colour = "black", size = 2) +
  theme_light() +
  coord_flip() +
  guides(fill = guide_legend(reverse = TRUE, title="School Year")) +
  theme(plot.title = element_text(face = "bold", size = 14, hjust = 0.45),
        plot.subtitle = element_text(hjust = 0.5),
        plot.caption = element_text(hjust = 1, size = 9, color = "grey50"),
        legend.background = element_rect(fill = "white", size = 1, colour = "white"),
        legend.title=element_text(size = 10),
        legend.text=element_text(size = 7),
        axis.text.x  = element_text(angle=45, vjust=0.5, size=7),
        axis.title.x  = element_text(size=12),
        axis.title.y  = element_text(size=12),
        strip.text.x = element_text(size = 12, colour = "black"))

#ggsave("/Users/alexliu/Desktop/A.4.1.ii 9th grade on track state total by income sy.png")

df_state_ontrack_inc %>%
  ggplot(aes(fill= `StudentGroup`,
             x= `SchoolYear`, 
             y= `% On Track`)) + 
  geom_col(position="dodge", width = 0.7) +
  ggtitle("Percentage of 9th Grade Students on Track") +
  labs(x = "School Years", 
       y = "Percentage of Students on Track",
       caption = "Missing values are suppressed") +
  scale_y_continuous(labels = percent, limits = c(0, 1)) +
  scale_fill_manual(values = uw_reverse(3)) +
  geom_text(aes(label = `% On Track` ), position = position_dodge(0.75),
            hjust = -0.1, vjust = 0.5, colour = "black", size = 2) +
  theme_light() +
  coord_flip() +
  guides(fill = guide_legend(reverse = TRUE, title="Student Group")) +
  theme(plot.title = element_text(face = "bold", size = 14, hjust = 0.45),
        plot.subtitle = element_text(hjust = 0.5),
        plot.caption = element_text(hjust = 1, size = 9, color = "grey50"),
        legend.background = element_rect(fill = "white", size = 1, colour = "white"),
        legend.title=element_text(size = 10),
        legend.text=element_text(size = 7),
        axis.text.x  = element_text(angle=45, vjust=0.5, size=7),
        axis.title.x  = element_text(size=12),
        axis.title.y  = element_text(size=12),
        strip.text.x = element_text(size = 12, colour = "black"))

# ggsave("/Users/alexliu/Desktop/A.4.1.ii 9th grade on track state total by race stugroup.png")

```

> Change in 9th grade on track pre- and post-COVID 

```{r A.4.1.iii 9th grade on track state total by race CHANGE, message=FALSE, warning=FALSE}

state_ontrack_race_change <- df_state_ontrack_race %>%
    group_by(`StudentGroup`) %>%
    mutate(Change = `% On Track`[SchoolYear == 2020] - `% On Track`[SchoolYear == 2018])

state_ontrack_race_change %>%
  ggplot(aes(x= `StudentGroup`, 
             y= `Change`)) + 
  geom_col(position="dodge", width = 0.7, fill = "#4b2e83") +
  ggtitle("Change in Percentage of 9th Grade Students on Track",
          subtitle = "between SY2018-19 and SY2020-21") +
  labs(x = "Student Groups",
       y = "Change in Percentage",
       caption = "A negative value means that the percentage of 9th grade students on track 
       has decreased between 2018-19 and 2020-21 for the given student group;
       Missing values are suppressed") +
  scale_y_continuous(labels = percent, limits = c(-0.08, 0)) +
  geom_text(aes(label = `Change` ), position = position_dodge(0.75),
            hjust = 1, vjust = 0.5, colour = "black", size = 2) +
  theme_light() +
  coord_flip() +
  guides(fill = guide_legend(reverse = TRUE, title="School Year")) +
  theme(plot.title = element_text(face = "bold", size = 14, hjust = 0.8),
        plot.subtitle = element_text(hjust = 0.5),
        plot.caption = element_text(hjust = 1, size = 9, color = "grey50"),
        legend.background = element_rect(fill = "white", size = 1, colour = "white"),
        legend.title=element_text(size = 10),
        legend.text=element_text(size = 7),
        axis.text.x  = element_text(angle=45, vjust=0.5, size=7),
        axis.title.x  = element_text(size=12),
        axis.title.y  = element_text(size=12),
        strip.text.x = element_text(size = 12, colour = "black"))

#ggsave("/Users/alexliu/Desktop/A.4.1.iii 9th grade on track state total by race CHANGE.png")

```

```{r A.4.1.iv 9th grade on track state total by income CHANGE}

state_ontrack_inc_change <- df_state_ontrack_inc %>%
    group_by(`StudentGroup`) %>%
    mutate(Change = `% On Track`[SchoolYear == 2020] - `% On Track`[SchoolYear == 2018])

state_ontrack_inc_change %>%
  ggplot(aes(x= `StudentGroup`, 
             y= `Change`)) + 
  geom_col(position="dodge", width = 0.7, fill = "#4b2e83") +
  ggtitle("Change in Percentage of 9th Grade Students on Track",
          subtitle = "between SY2018-19 and SY2020-21") +
  labs(x = "Student Groups",
       y = "Change in Percentage",
       caption = "A negative value means that the percentage of 9th grade students on track 
       has decreased between 2018-19 and 2020-21 for the given student group") +
  scale_y_continuous(labels = percent, limits = c(-0.04, 0)) +
  geom_text(aes(label = `Change` ), position = position_dodge(0.75),
            hjust = 1, vjust = 0.5, colour = "black", size = 2) +
  theme_light() +
  coord_flip() +
  guides(fill = guide_legend(reverse = TRUE, title="School Year")) +
  theme(plot.title = element_text(face = "bold", size = 14, hjust = 0.8),
        plot.subtitle = element_text(hjust = 0.5),
        plot.caption = element_text(hjust = 1, size = 9, color = "grey50"),
        legend.background = element_rect(fill = "white", size = 1, colour = "white"),
        legend.title=element_text(size = 10),
        legend.text=element_text(size = 7),
        axis.text.x  = element_text(angle=45, vjust=0.5, size=7),
        axis.title.x  = element_text(size=12),
        axis.title.y  = element_text(size=12),
        strip.text.x = element_text(size = 12, colour = "black"))

#ggsave("/Users/alexliu/Desktop/A.4.1.iv 9th grade on track state total by inc CHANGE.png")
```

## Regular attendance

> State total regular attendance for "all grades" (data at grade level is available)

```{r A.4.2.i Regular attendance state total by race}

# Regular attendance, meaning that has more than 90% attendance during the year
df_state_regattend_race <- df_sqss %>%
  filter(DistrictName == "State Total") %>%
  filter(Measure == "Regular Attendance") %>%
  filter(StudentGroupType %in% c("AllStudents", "FederalRaceEthnicity")) %>%
  mutate(`% Regular Attend` = percent(Numerator/Denominator)) %>%
  mutate(SchoolYear = as.character(SchoolYear))

df_state_regattend_race %>%
  filter(`Grade Level` == "All Grades") %>%
  ggplot(aes(fill= `SchoolYear`,
             x= `StudentGroup`, 
             y= `% Regular Attend`)) + 
  geom_col(position="dodge", width = 0.7) +
  ggtitle("Percentage of Regular Attendence",
          subtitle = "for all grades") +
  labs(x = "Student Groups", 
       y = "% Regular Attendance") +
  scale_y_continuous(labels = percent, limits = c(0, 1)) +
  scale_fill_manual(values = uw_reverse(3)) +
  geom_text(aes(label = `% Regular Attend` ), position = position_dodge(0.75),
            hjust = -0.1, vjust = 0.5, colour = "black", size = 2) +
  theme_light() +
  coord_flip() +
  guides(fill = guide_legend(reverse = TRUE, title="School Year")) +
  theme(plot.title = element_text(face = "bold", size = 14, hjust = 0.45),
        plot.subtitle = element_text(hjust = 0.5),
        plot.caption = element_text(hjust = 1, size = 9, color = "grey50"),
        legend.background = element_rect(fill = "white", size = 1, colour = "white"),
        legend.title=element_text(size = 10),
        legend.text=element_text(size = 7),
        axis.text.x  = element_text(angle=45, vjust=0.5, size=7),
        axis.title.x  = element_text(size=12),
        axis.title.y  = element_text(size=12),
        strip.text.x = element_text(size = 12, colour = "black"))

#ggsave("/Users/alexliu/Desktop/A.4.2.i Regular attendance state total by race sy all.png")

df_state_regattend_race %>%
  filter(`Grade Level` == "All Grades") %>%
  ggplot(aes(fill= `StudentGroup`,
             x= `SchoolYear`, 
             y= `% Regular Attend`)) + 
  geom_col(position="dodge", width = 0.7) +
  ggtitle("Percentage of Regular Attendence",
          subtitle = "for all grades") +
  labs(x = "School Years", 
       y = "% Regular Attendance") +
  scale_y_continuous(labels = percent, limits = c(0, 1)) +
  scale_fill_manual(values = uw_reverse(8)) +
  geom_text(aes(label = `% Regular Attend` ), position = position_dodge(0.75),
            hjust = -0.1, vjust = 0.5, colour = "black", size = 2) +
  theme_light() +
  coord_flip() +
  guides(fill = guide_legend(reverse = TRUE, title="Student Group")) +
  theme(plot.title = element_text(face = "bold", size = 14, hjust = 0.45),
        plot.subtitle = element_text(hjust = 0.5),
        plot.caption = element_text(hjust = 1, size = 9, color = "grey50"),
        legend.background = element_rect(fill = "white", size = 1, colour = "white"),
        legend.title=element_text(size = 10),
        legend.text=element_text(size = 7),
        axis.text.x  = element_text(angle=45, vjust=0.5, size=7),
        axis.title.x  = element_text(size=12),
        axis.title.y  = element_text(size=12),
        strip.text.x = element_text(size = 12, colour = "black"))

#ggsave("/Users/alexliu/Desktop/A.4.2.i Regular attendance state total by race stugroup all.png")


```

```{r A.4.2.ii Regular attendance state total by income}

df_state_regattend_inc <- df_sqss %>%
  filter(DistrictName == "State Total") %>%
  filter(Measure == "Regular Attendance") %>%
  filter(StudentGroupType %in% c("AllStudents", "Income")) %>%
  arrange(`Grade Level`, SchoolYear) %>%
  mutate(`% Regular Attend` = percent(Numerator/Denominator)) %>%
  mutate(SchoolYear = as.character(SchoolYear))

df_state_regattend_inc %>%
  filter(`Grade Level` == "All Grades") %>%
  ggplot(aes(fill= `SchoolYear`,
             x= `StudentGroup`, 
             y= `% Regular Attend`)) + 
  geom_col(position="dodge", width = 0.7) +
  ggtitle("Percentage of Regular Attendence",
          subtitle = "for all grades") +
  labs(x = "Student Groups", 
       y = "% Regular Attendance") +
  scale_y_continuous(labels = percent, limits = c(0, 1)) +
  scale_fill_manual(values = uw_reverse(3)) +
  geom_text(aes(label = `% Regular Attend` ), position = position_dodge(0.75),
            hjust = -0.1, vjust = 0.5, colour = "black", size = 2) +
  theme_light() +
  coord_flip() +
  guides(fill = guide_legend(reverse = TRUE, title="School Year")) +
  theme(plot.title = element_text(face = "bold", size = 14, hjust = 0.45),
        plot.subtitle = element_text(hjust = 0.5),
        plot.caption = element_text(hjust = 1, size = 9, color = "grey50"),
        legend.background = element_rect(fill = "white", size = 1, colour = "white"),
        legend.title=element_text(size = 10),
        legend.text=element_text(size = 7),
        axis.text.x  = element_text(angle=45, vjust=0.5, size=7),
        axis.title.x  = element_text(size=12),
        axis.title.y  = element_text(size=12),
        strip.text.x = element_text(size = 12, colour = "black"))

#ggsave("/Users/alexliu/Desktop/A.4.2.ii Regular attendance state total by inc sy all.png")

df_state_regattend_inc %>%
  filter(`Grade Level` == "All Grades") %>%
  ggplot(aes(fill= `StudentGroup`,
             x= `SchoolYear`, 
             y= `% Regular Attend`)) + 
  geom_col(position="dodge", width = 0.7) +
  ggtitle("Percentage of Regular Attendence",
          subtitle = "for all grades") +
  labs(x = "Student Groups", 
       y = "% Regular Attendance") +
  scale_y_continuous(labels = percent, limits = c(0, 1)) +
  scale_fill_manual(values = uw_reverse(3)) +
  geom_text(aes(label = `% Regular Attend` ), position = position_dodge(0.75),
            hjust = -0.1, vjust = 0.5, colour = "black", size = 2) +
  theme_light() +
  coord_flip() +
  guides(fill = guide_legend(reverse = TRUE, title="Student Group")) +
  theme(plot.title = element_text(face = "bold", size = 14, hjust = 0.45),
        plot.subtitle = element_text(hjust = 0.5),
        plot.caption = element_text(hjust = 1, size = 9, color = "grey50"),
        legend.background = element_rect(fill = "white", size = 1, colour = "white"),
        legend.title=element_text(size = 10),
        legend.text=element_text(size = 7),
        axis.text.x  = element_text(angle=45, vjust=0.5, size=7),
        axis.title.x  = element_text(size=12),
        axis.title.y  = element_text(size=12),
        strip.text.x = element_text(size = 12, colour = "black"))

#ggsave("/Users/alexliu/Desktop/A.4.2.ii Regular attendance state total by inc stugroup all.png")

```

> Change in regular attendance pre- and post-COVID for "all grades"

change in percentage (%2021 - %1819), NOT percentage change (%2021 - %1819)/%1819

```{r A.4.2.iii Regular attendance state total by race CHANGE, message=FALSE, warning=FALSE}

state_regatt_race_change <- df_state_regattend_race %>%
  group_by(StudentGroup, `Grade Level`) %>%
  filter(`Grade Level` == "All Grades") %>%
  mutate(Change = `% Regular Attend`[SchoolYear == 2020] - `% Regular Attend`[SchoolYear == 2018], )

state_regatt_race_change %>%
  ggplot(aes(x= `StudentGroup`, 
             y= `Change`)) + 
  geom_col(position="dodge", width = 0.7, fill = "#4b2e83") +
  ggtitle("Change in Percentage of Regular Attendance",
          subtitle = "between SY2018-19 and SY2020-21 for all grades") +
  labs(x = "Student Groups",
       y = "Change in Percentage",
       caption = "A negative value means that the percentage of 9th grade students on track 
       has decreased between 2018-19 and 2020-21 for the given student group") +
  scale_y_continuous(labels = percent, limits = c(-0.08, 0.02)) +
  geom_text(aes(label = `Change` ), position = position_dodge(0.75),
            hjust = 1, vjust = 0.5, colour = "black", size = 2) +
  geom_hline(yintercept = 0, linetype = "dashed") +
  theme_light() +
  coord_flip() +
  guides(fill = guide_legend(reverse = TRUE, title="School Year")) +
  theme(plot.title = element_text(face = "bold", size = 14, hjust = 0.5),
        plot.subtitle = element_text(hjust = 0.5),
        plot.caption = element_text(hjust = 1, size = 9, color = "grey50"),
        legend.background = element_rect(fill = "white", size = 1, colour = "white"),
        legend.title=element_text(size = 10),
        legend.text=element_text(size = 7),
        axis.text.x  = element_text(angle=45, vjust=0.5, size=7),
        axis.title.x  = element_text(size=12),
        axis.title.y  = element_text(size=12),
        strip.text.x = element_text(size = 12, colour = "black"))

#ggsave("/Users/alexliu/Desktop/A.4.2.iii Regular attendance state total by race CHANGE.png")

```

```{r A.4.2.iv Regular attendance state total by income CHANGE}

state_regatt_inc_change <- df_state_regattend_inc %>%
  group_by(StudentGroup, `Grade Level`) %>%
  filter(`Grade Level` == "All Grades") %>%
  mutate(Change = `% Regular Attend`[SchoolYear == 2020] - `% Regular Attend`[SchoolYear == 2018], )

state_regatt_inc_change %>%
  ggplot(aes(x= `StudentGroup`, 
             y= `Change`)) + 
  geom_col(position="dodge", width = 0.7, fill = "#4b2e83") +
  ggtitle("Change in Percentage of Regular Attendance",
          subtitle = "between SY2018-19 and SY2020-21 for all grades") +
  labs(x = "Student Groups",
       y = "Change in Percentage",
       caption = "A negative value means that the percentage of 9th grade students on track 
       has decreased between 2018-19 and 2020-21 for the given student group") +
  scale_y_continuous(labels = percent, limits = c(-0.04, 0.0)) +
  geom_text(aes(label = `Change` ), position = position_dodge(0.75),
            hjust = 1, vjust = 0.5, colour = "black", size = 2) +
  theme_light() +
  coord_flip() +
  guides(fill = guide_legend(reverse = TRUE, title="School Year")) +
  theme(plot.title = element_text(face = "bold", size = 14, hjust = 0.5),
        plot.subtitle = element_text(hjust = 0.5),
        plot.caption = element_text(hjust = 1, size = 9, color = "grey50"),
        legend.background = element_rect(fill = "white", size = 1, colour = "white"),
        legend.title=element_text(size = 10),
        legend.text=element_text(size = 7),
        axis.text.x  = element_text(angle=45, vjust=0.5, size=7),
        axis.title.x  = element_text(size=12),
        axis.title.y  = element_text(size=12),
        strip.text.x = element_text(size = 12, colour = "black"))

#ggsave("/Users/alexliu/Desktop/A.4.2.iv Regular attendance state total by inc CHANGE.png")
```

## Dual credits

> State total (dual credits, AP, IB) for all grades (data at grade level 10-12 available)  

Dual credits: (AP/IB courses is more prestigious). Interviewees suggested variation in how dual credits have been implemented in schools.

* Overall % students taking dual credits increased
  + decrease in % taking AP and IB
  + increase in % taking College in The High School and CTE Tech Prep. 
  + around 1% taking Cambridge and Running Start (not plotted)
  + number of students taking certain dual credits courses: 
      + CTE Tech Prep > AP > College in The High School > Running Start > IB > Cambridge

```{r A.4.3.i Dual credit state total by race}

df_state_dual_race <- df_sqss %>%
  filter(DistrictName == "State Total") %>%
  filter(Measure == "Dual Credit") %>%
  filter(StudentGroupType %in% c("AllStudents", "FederalRaceEthnicity")) %>%
  mutate(PercentTakingAP = percent(PercentTakingAP),
         PercentTakingIB = percent(PercentTakingIB),
         PercentTakingCTETechPrep = percent(PercentTakingCTETechPrep),
         PercentTakingCollegeInTheHighSchool = percent(PercentTakingCollegeInTheHighSchool),
         PercentDualCredits = percent(Numerator/Denominator),
         SchoolYear = as.character(SchoolYear)) 

df_state_dual_race %>%
  filter(`Grade Level` == "All Grades") %>%
  ggplot(aes(fill= `SchoolYear`,
             x= `StudentGroup`, 
             y= `PercentDualCredits`)) + 
  geom_col(position="dodge", width = 0.7) +
  ggtitle("Percent of Students Taking Dual Credits",
          subtitle = "for all grades") +
  labs(x = "Student Groups", 
       y = "% Taking Dual Credits") +
  scale_y_continuous(labels = percent, limits = c(0, 1)) +
  scale_fill_manual(values = uw_reverse(3)) +
  geom_text(aes(label = `PercentDualCredits` ), position = position_dodge(0.75),
            hjust = -0.1, vjust = 0.5, colour = "black", size = 2) +
  theme_light() +
  coord_flip() +
  guides(fill = guide_legend(reverse = TRUE, title="School Year")) +
  theme(plot.title = element_text(face = "bold", size = 14, hjust = 0.45),
        plot.subtitle = element_text(hjust = 0.5),
        plot.caption = element_text(hjust = 1, size = 9, color = "grey50"),
        legend.background = element_rect(fill = "white", size = 1, colour = "white"),
        legend.title=element_text(size = 10),
        legend.text=element_text(size = 7),
        axis.text.x  = element_text(angle=45, vjust=0.5, size=7),
        axis.title.x  = element_text(size=12),
        axis.title.y  = element_text(size=12),
        strip.text.x = element_text(size = 12, colour = "black"))

#ggsave("/Users/alexliu/Desktop/A.4.3.i Dual credit state total by race Dual Credits.png")

df_state_dual_race %>%
  filter(`Grade Level` == "All Grades") %>%
  ggplot(aes(fill= `SchoolYear`,
             x= `StudentGroup`, 
             y= `PercentTakingAP`)) + 
  geom_col(position="dodge", width = 0.7) +
  ggtitle("Percent of Students Taking AP",
          subtitle = "for all grades") +
  labs(x = "Student Groups", 
       y = "% Taking AP") +
  scale_y_continuous(labels = percent, limits = c(0, 1)) +
  scale_fill_manual(values = uw_reverse(3)) +
  geom_text(aes(label = PercentTakingAP), position = position_dodge(0.75),
            hjust = -0.1, vjust = 0.5, colour = "black", size = 2) +
  theme_light() +
  coord_flip() +
  guides(fill = guide_legend(reverse = TRUE, title="School Year")) +
  theme(plot.title = element_text(face = "bold", size = 14, hjust = 0.45),
        plot.subtitle = element_text(hjust = 0.5),
        plot.caption = element_text(hjust = 1, size = 9, color = "grey50"),
        legend.background = element_rect(fill = "white", size = 1, colour = "white"),
        legend.title=element_text(size = 10),
        legend.text=element_text(size = 7),
        axis.text.x  = element_text(angle=45, vjust=0.5, size=7),
        axis.title.x  = element_text(size=12),
        axis.title.y  = element_text(size=12),
        strip.text.x = element_text(size = 12, colour = "black"))

#ggsave("/Users/alexliu/Desktop/A.4.3.i Dual credit state total by race AP.png")

df_state_dual_race %>%
  filter(`Grade Level` == "All Grades") %>%
  ggplot(aes(fill= `SchoolYear`,
             x= `StudentGroup`, 
             y= `PercentTakingIB`)) + 
  geom_col(position="dodge", width = 0.7) +
  ggtitle("Percent of Students Taking IB",
          subtitle = "for all grades") +
  labs(x = "Student Groups", 
       y = "% Taking IB") +
  scale_y_continuous(labels = percent, limits = c(0, 1)) +
  scale_fill_manual(values = uw_reverse(3)) +
  geom_text(aes(label = PercentTakingIB), position = position_dodge(0.75),
            hjust = -0.1, vjust = 0.5, colour = "black", size = 2) +
  theme_light() +
  coord_flip() +
  guides(fill = guide_legend(reverse = TRUE, title="School Year")) +
  theme(plot.title = element_text(face = "bold", size = 14, hjust = 0.45),
        plot.subtitle = element_text(hjust = 0.5),
        plot.caption = element_text(hjust = 1, size = 9, color = "grey50"),
        legend.background = element_rect(fill = "white", size = 1, colour = "white"),
        legend.title=element_text(size = 10),
        legend.text=element_text(size = 7),
        axis.text.x  = element_text(angle=45, vjust=0.5, size=7),
        axis.title.x  = element_text(size=12),
        axis.title.y  = element_text(size=12),
        strip.text.x = element_text(size = 12, colour = "black"))

#ggsave("/Users/alexliu/Desktop/A.4.3.i Dual credit state total by race IB.png")

df_state_dual_race %>%
  filter(`Grade Level` == "All Grades") %>%
  ggplot(aes(fill= `SchoolYear`,
             x= `StudentGroup`, 
             y= `PercentTakingCollegeInTheHighSchool`)) + 
  geom_col(position="dodge", width = 0.7) +
  ggtitle("Percent of Students Taking College in The High School",
          subtitle = "for all grades") +
  labs(x = "Student Groups", 
       y = "% Taking College in The High School") +
  scale_y_continuous(labels = percent, limits = c(0, 1)) +
  scale_fill_manual(values = uw_reverse(3)) +
  geom_text(aes(label = PercentTakingAP), position = position_dodge(0.75),
            hjust = -0.1, vjust = 0.5, colour = "black", size = 2) +
  theme_light() +
  coord_flip() +
  guides(fill = guide_legend(reverse = TRUE, title="School Year")) +
  theme(plot.title = element_text(face = "bold", size = 14, hjust = 0.45),
        plot.subtitle = element_text(hjust = 0.5),
        plot.caption = element_text(hjust = 1, size = 9, color = "grey50"),
        legend.background = element_rect(fill = "white", size = 1, colour = "white"),
        legend.title=element_text(size = 10),
        legend.text=element_text(size = 7),
        axis.text.x  = element_text(angle=45, vjust=0.5, size=7),
        axis.title.x  = element_text(size=12),
        axis.title.y  = element_text(size=12),
        strip.text.x = element_text(size = 12, colour = "black"))

#ggsave("/Users/alexliu/Desktop/A.4.3.i Dual credit state total by race CollegeInTheHighSchool.png")

df_state_dual_race %>%
  filter(`Grade Level` == "All Grades") %>%
  ggplot(aes(fill= `SchoolYear`,
             x= `StudentGroup`, 
             y= `PercentTakingCTETechPrep`)) + 
  geom_col(position="dodge", width = 0.7) +
  ggtitle("Percent of Students Taking CTE Tech Prep",
          subtitle = "for all grades") +
  labs(x = "Student Groups", 
       y = "% Taking CTE Tech Prep") +
  scale_y_continuous(labels = percent, limits = c(0, 1)) +
  scale_fill_manual(values = uw_reverse(3)) +
  geom_text(aes(label = PercentTakingAP), position = position_dodge(0.75),
            hjust = -0.1, vjust = 0.5, colour = "black", size = 2) +
  theme_light() +
  coord_flip() +
  guides(fill = guide_legend(reverse = TRUE, title="School Year")) +
  theme(plot.title = element_text(face = "bold", size = 14, hjust = 0.45),
        plot.subtitle = element_text(hjust = 0.5),
        plot.caption = element_text(hjust = 1, size = 9, color = "grey50"),
        legend.background = element_rect(fill = "white", size = 1, colour = "white"),
        legend.title=element_text(size = 10),
        legend.text=element_text(size = 7),
        axis.text.x  = element_text(angle=45, vjust=0.5, size=7),
        axis.title.x  = element_text(size=12),
        axis.title.y  = element_text(size=12),
        strip.text.x = element_text(size = 12, colour = "black"))

#ggsave("/Users/alexliu/Desktop/A.4.3.i Dual credit state total by race CTETechPrep.png")


```

```{r A.4.3.ii Dual credit state total by income}

df_state_dual_inc <- df_sqss %>%
  filter(DistrictName == "State Total") %>%
  filter(Measure == "Dual Credit") %>%
  filter(StudentGroupType %in% c("AllStudents", "Income")) %>%
  mutate(PercentTakingAP = percent(PercentTakingAP),
         PercentTakingIB = percent(PercentTakingIB),
         PercentTakingCTETechPrep = percent(PercentTakingCTETechPrep),
         PercentTakingCollegeInTheHighSchool = percent(PercentTakingCollegeInTheHighSchool),
         PercentDualCredits = percent(Numerator/Denominator),
         SchoolYear = as.character(SchoolYear)) 

df_state_dual_inc %>%
  filter(`Grade Level` == "All Grades") %>%
  ggplot(aes(fill= `SchoolYear`,
             x= `StudentGroup`, 
             y= `PercentDualCredits`)) + 
  geom_col(position="dodge", width = 0.7) +
  ggtitle("Percent of Students Taking Dual Credits",
          subtitle = "for all grades") +
  labs(x = "Student Groups", 
       y = "% Taking Dual Credits") +
  scale_y_continuous(labels = percent, limits = c(0, 1)) +
  scale_fill_manual(values = uw_reverse(3)) +
  geom_text(aes(label = `PercentDualCredits` ), position = position_dodge(0.75),
            hjust = -0.1, vjust = 0.5, colour = "black", size = 2) +
  theme_light() +
  coord_flip() +
  guides(fill = guide_legend(reverse = TRUE, title="School Year")) +
  theme(plot.title = element_text(face = "bold", size = 14, hjust = 0.45),
        plot.subtitle = element_text(hjust = 0.5),
        plot.caption = element_text(hjust = 1, size = 9, color = "grey50"),
        legend.background = element_rect(fill = "white", size = 1, colour = "white"),
        legend.title=element_text(size = 10),
        legend.text=element_text(size = 7),
        axis.text.x  = element_text(angle=45, vjust=0.5, size=7),
        axis.title.x  = element_text(size=12),
        axis.title.y  = element_text(size=12),
        strip.text.x = element_text(size = 12, colour = "black"))

#ggsave("/Users/alexliu/Desktop/A.4.3.ii Dual credit state total by inc Dual Credits.png")

df_state_dual_inc %>%
  filter(`Grade Level` == "All Grades") %>%
  ggplot(aes(fill= `SchoolYear`,
             x= `StudentGroup`, 
             y= `PercentTakingAP`)) + 
  geom_col(position="dodge", width = 0.7) +
  ggtitle("Percent of Students Taking AP",
          subtitle = "for all grades") +
  labs(x = "Student Groups", 
       y = "% Taking AP") +
  scale_y_continuous(labels = percent, limits = c(0, 1)) +
  scale_fill_manual(values = uw_reverse(3)) +
  geom_text(aes(label = PercentTakingAP), position = position_dodge(0.75),
            hjust = -0.1, vjust = 0.5, colour = "black", size = 2) +
  theme_light() +
  coord_flip() +
  guides(fill = guide_legend(reverse = TRUE, title="School Year")) +
  theme(plot.title = element_text(face = "bold", size = 14, hjust = 0.45),
        plot.subtitle = element_text(hjust = 0.5),
        plot.caption = element_text(hjust = 1, size = 9, color = "grey50"),
        legend.background = element_rect(fill = "white", size = 1, colour = "white"),
        legend.title=element_text(size = 10),
        legend.text=element_text(size = 7),
        axis.text.x  = element_text(angle=45, vjust=0.5, size=7),
        axis.title.x  = element_text(size=12),
        axis.title.y  = element_text(size=12),
        strip.text.x = element_text(size = 12, colour = "black"))

#ggsave("/Users/alexliu/Desktop/A.4.3.ii Dual credit state total by inc AP.png")

df_state_dual_inc %>%
  filter(`Grade Level` == "All Grades") %>%
  ggplot(aes(fill= `SchoolYear`,
             x= `StudentGroup`, 
             y= `PercentTakingIB`)) + 
  geom_col(position="dodge", width = 0.7) +
  ggtitle("Percent of Students Taking IB",
          subtitle = "for all grades") +
  labs(x = "Student Groups", 
       y = "% Taking IB") +
  scale_y_continuous(labels = percent, limits = c(0, 1)) +
  scale_fill_manual(values = uw_reverse(3)) +
  geom_text(aes(label = PercentTakingIB), position = position_dodge(0.75),
            hjust = -0.1, vjust = 0.5, colour = "black", size = 2) +
  theme_light() +
  coord_flip() +
  guides(fill = guide_legend(reverse = TRUE, title="School Year")) +
  theme(plot.title = element_text(face = "bold", size = 14, hjust = 0.45),
        plot.subtitle = element_text(hjust = 0.5),
        plot.caption = element_text(hjust = 1, size = 9, color = "grey50"),
        legend.background = element_rect(fill = "white", size = 1, colour = "white"),
        legend.title=element_text(size = 10),
        legend.text=element_text(size = 7),
        axis.text.x  = element_text(angle=45, vjust=0.5, size=7),
        axis.title.x  = element_text(size=12),
        axis.title.y  = element_text(size=12),
        strip.text.x = element_text(size = 12, colour = "black"))

#ggsave("/Users/alexliu/Desktop/A.4.3.ii Dual credit state total by inc IB.png")

df_state_dual_inc %>%
  filter(`Grade Level` == "All Grades") %>%
  ggplot(aes(fill= `SchoolYear`,
             x= `StudentGroup`, 
             y= `PercentTakingCollegeInTheHighSchool`)) + 
  geom_col(position="dodge", width = 0.7) +
  ggtitle("Percent of Students Taking College in The High School",
          subtitle = "for all grades") +
  labs(x = "Student Groups", 
       y = "% Taking College in The High School") +
  scale_y_continuous(labels = percent, limits = c(0, 1)) +
  scale_fill_manual(values = uw_reverse(3)) +
  geom_text(aes(label = PercentTakingAP), position = position_dodge(0.75),
            hjust = -0.1, vjust = 0.5, colour = "black", size = 2) +
  theme_light() +
  coord_flip() +
  guides(fill = guide_legend(reverse = TRUE, title="School Year")) +
  theme(plot.title = element_text(face = "bold", size = 14, hjust = 0.45),
        plot.subtitle = element_text(hjust = 0.5),
        plot.caption = element_text(hjust = 1, size = 9, color = "grey50"),
        legend.background = element_rect(fill = "white", size = 1, colour = "white"),
        legend.title=element_text(size = 10),
        legend.text=element_text(size = 7),
        axis.text.x  = element_text(angle=45, vjust=0.5, size=7),
        axis.title.x  = element_text(size=12),
        axis.title.y  = element_text(size=12),
        strip.text.x = element_text(size = 12, colour = "black"))

ggsave("/Users/alexliu/Desktop/A.4.3.ii Dual credit state total by inc CollegeInTheHighSchool.png")

df_state_dual_inc %>%
  filter(`Grade Level` == "All Grades") %>%
  ggplot(aes(fill= `SchoolYear`,
             x= `StudentGroup`, 
             y= `PercentTakingCTETechPrep`)) + 
  geom_col(position="dodge", width = 0.7) +
  ggtitle("Percent of Students Taking CTE Tech Prep",
          subtitle = "for all grades") +
  labs(x = "Student Groups", 
       y = "% Taking CTE Tech Prep") +
  scale_y_continuous(labels = percent, limits = c(0, 1)) +
  scale_fill_manual(values = uw_reverse(3)) +
  geom_text(aes(label = PercentTakingAP), position = position_dodge(0.75),
            hjust = -0.1, vjust = 0.5, colour = "black", size = 2) +
  theme_light() +
  coord_flip() +
  guides(fill = guide_legend(reverse = TRUE, title="School Year")) +
  theme(plot.title = element_text(face = "bold", size = 14, hjust = 0.45),
        plot.subtitle = element_text(hjust = 0.5),
        plot.caption = element_text(hjust = 1, size = 9, color = "grey50"),
        legend.background = element_rect(fill = "white", size = 1, colour = "white"),
        legend.title=element_text(size = 10),
        legend.text=element_text(size = 7),
        axis.text.x  = element_text(angle=45, vjust=0.5, size=7),
        axis.title.x  = element_text(size=12),
        axis.title.y  = element_text(size=12),
        strip.text.x = element_text(size = 12, colour = "black"))

ggsave("/Users/alexliu/Desktop/A.4.3.ii Dual credit state total by inc CTETechPrep.png")

```

# A.5. Graduation (the class of 2020)

https://www.k12.wa.us/data-reporting/data-displays/graduation-pathways-display
We have individual school level data. 
Different pathways by income and students of color (only state level as the first step)

> State level

* Includes all students in the Class of 2020; including those who graduated, are continuing their education, or have left school.

```{r A.5.1.i Graduation pathway at state level by race}

df_state_grad_path <- read.csv("/Users/alexliu/Documents/GitHub/evidenceforequity/A/enrollment_absence_dataset/Class of 2020 Graduation Pathways.csv") 

colnames(df_state_grad_path) <- c("StudentGroup", 
                                  "% Completed ELA/Math Pathway",
                                  "% Completed ASVAB Pathway",
                                  "% Completed CTE Graduation Pathway",
                                  "% Completed CIA",
                                  "% No Pathway")

long_state_grad_path <- melt(df_state_grad_path, 
                             id.vars = "StudentGroup",
                             measure.vars = colnames(df_state_grad_path)[2:6],
                             variable.name = "Pathways",
                             value.name="% Completed") %>%
  arrange(StudentGroup, Pathways)

long_state_grad_path$`% Completed` <- percent(long_state_grad_path$`% Completed`/100)

long_state_grad_path$Pathways <- factor(long_state_grad_path$Pathways, 
                                        levels=c("% No Pathway",
                                                 "% Completed CIA",
                                                 "% Completed CTE Graduation Pathway",
                                                 "% Completed ASVAB Pathway",
                                                 "% Completed ELA/Math Pathway"))

long_state_grad_path %>%
  filter(`StudentGroup` != "Low-Income ") %>%
  ggplot(aes(fill= `Pathways`,
             x= `StudentGroup`, 
             y= `% Completed`)) + 
  geom_col(position="dodge", width = 0.9) +
  ggtitle("Class of 2020 Graduation Pathways",
          subtitle = "includes all students in the Class of 2020") +
  labs(x = "Student Groups", 
       y = "Percentage of Students Completed") +
  scale_y_continuous(labels = percent, limits = c(0, 0.9)) +
  scale_fill_manual(values = uw_reverse(5)) +
  geom_text(aes(label = `% Completed` ), position = position_dodge(0.9),
            hjust = -0.1, vjust = 0.4, colour = "black", size = 1.5) +
  theme_light() +
  coord_flip() +
  guides(fill = guide_legend(reverse = TRUE)) +
  theme(plot.title = element_text(face = "bold", size = 14, hjust = 0.45),
        plot.subtitle = element_text(hjust = 0.5),
        plot.caption = element_text(hjust = 0.5, size = 9),
        legend.background = element_rect(fill = "white", size = 1, colour = "white"),
        legend.title=element_text(size = 10),
        legend.text=element_text(size = 7),
        axis.text.x  = element_text(angle=45, vjust=0.5, size=7),
        axis.title.x  = element_text(size=12),
        axis.title.y  = element_text(size=12),
        strip.text.x = element_text(size = 12, colour = "black"))

#ggsave("/Users/alexliu/Desktop/A.5.1.i Graduation pathway at state level by race.png")
```

```{r A.5.1.ii Graduation pathway at state level by income}

long_state_grad_path %>%
  filter(`StudentGroup` %in% c("All Students ", "Low-Income ")) %>%
  ggplot(aes(fill= `Pathways`,
             x= `StudentGroup`, 
             y= `% Completed`)) + 
  geom_col(position="dodge", width = 0.7) +
  ggtitle("Class of 2020 Graduation Pathways",
          subtitle = "includes all students in the Class of 2020") +
  labs(x = "Student Groups", 
       y = "Percentage of Students Completed") +
  scale_y_continuous(labels = percent, limits = c(0, 0.9)) +
  scale_fill_manual(values = uw_reverse(5)) +
  geom_text(aes(label = `% Completed` ), position = position_dodge(0.75),
            hjust = -0.1, vjust = 0.5, colour = "black", size = 2) +
  theme_light() +
  coord_flip() +
  guides(fill = guide_legend(reverse = TRUE)) +
  theme(plot.title = element_text(face = "bold", size = 14, hjust = 0.45),
        plot.subtitle = element_text(hjust = 0.5),
        plot.caption = element_text(hjust = 0.5, size = 9),
        legend.background = element_rect(fill = "white", size = 1, colour = "white"),
        legend.title=element_text(size = 10),
        legend.text=element_text(size = 7),
        axis.text.x  = element_text(angle=45, vjust=0.5, size=7),
        axis.title.x  = element_text(size=12),
        axis.title.y  = element_text(size=12),
        strip.text.x = element_text(size = 12, colour = "black"))

#ggsave("/Users/alexliu/Desktop/A.5.1.ii Graduation pathway at state level by income.png")
```