---
title: 'Section A: Student-level Changes during COVID-19'
author: "Alex Liu"
date: "`r format(Sys.Date(), format = '%B %d, %Y')`"
output: html_document
        toc: true
        toc_float: true
        fig_width: 8
---

```{r include=FALSE}
knitr::opts_chunk$set(echo = FALSE,
                      comment = NA, 
                      cache = TRUE,
                      warning = FALSE,
                      message = FALSE, 
                      cache.lazy = FALSE,
                      fig.align = "center"
                      )
```

#Notes
## 10/26 
### issues: obtain grade level df (affect enrollment and absences)
### to-do: ask about reference line; generalize codes; touch up plots; work on spatial plots.

# Introduction

```{r data, include=FALSE}
library(tidyverse)
library(googledrive)

id_enrollment <- drive_get(as_id("https://drive.google.com/file/d/1hfVC_BgnUF6lBJYcGf6lhtMQOxEdig2v/view?usp=sharing"))
id_graduation_pathways <- drive_get(as_id("https://drive.google.com/file/d/1hgO_VNQ2DdDtPBAa_Mtdkq1JhwPSD4uI/view?usp=sharing"))
id_reopening_survey <- drive_get(as_id("https://drive.google.com/file/d/1YbyBi1LfHz36aLyVItJs6mJ4nNWxuUkd/view?usp=sharing"))
id_course_outcomes_by_student <- drive_get(as_id("https://drive.google.com/file/d/1hfA_RgRAldfsLXzH6hg776kV_x96xDgI/view?usp=sharing"))
id_course_outcomes_by_outcome <- drive_get(as_id("https://drive.google.com/file/d/1hcUTvX5xYIVyejpyS73z0Xo-64w2uRCZ/view?usp=sharing"))
id_discipline <- drive_get(as_id("https://drive.google.com/file/d/1hkh1eV3QJ0ZkJRRB1VIlUIaJDE4yYoYF/view?usp=sharing"))

df_enrollment <- id_enrollment %>%
  drive_read_string() %>%
  read_csv(col_names=TRUE)
#https://data.wa.gov/Education/OSPI-Enrollment-Changes-2019-20-to-2020-21/5u4d-iirb

df_graduation_pathways <- id_graduation_pathways %>%
  drive_read_string() %>%
  read_csv(col_names=TRUE)
#https://data.wa.gov/Education/Data-Displays-Graduation-Pathways-OSPI/nxmy-bggx

df_reopening_survey <- id_reopening_survey %>%
  drive_read_string() %>%
  read_csv(col_names=TRUE)
#https://data.wa.gov/dataset/School-Facility-ReOpening-Survey/9i5d-c2m8

df_course_outcomes_by_student <- id_course_outcomes_by_student %>%
  drive_read_string() %>%
  read_csv(col_names=TRUE)
#https://data.wa.gov/Education/Student-Course-Outcomes-by-Student/f4u4-uezp

df_course_outcomes_by_outcome <- id_course_outcomes_by_outcome %>%
  drive_read_string() %>%
  read_csv(col_names=TRUE)
#https://data.wa.gov/dataset/Student-Course-Outcomes-by-Outcome/cjza-wqsm

df_discpline <- id_discipline %>%
  drive_read_string() %>%
  read_csv(col_name=TRUE)

#OSPI Suppression Rules
#https://k12.wa.us/sites/default/files/public/StudentInformation/SuppressionRulesforPublicReporting.pdf

```

```{r libraries, include=FALSE}
library(tidyverse)
library(ggplot2)
library(formattable)
#library(rJava)
#library(tabulizer) 
```

# Enrollment
### Have trouble with grade-specific df, need to work on scrape from nested pdf (doable but need time consuming). once the datasets ready, the plot I &II code can be used with minimal editing 10/26

## plot I: counts; year 2021; sorted by races; sorted by income levels; bar = month; grades = kindergaiden & 6th & 9th

```{r enrollment, include=FALSE}

enrollment_by_races <- df_enrollment %>%
  filter(StudentGroupType == "Race" | StudentGroupType == "All") %>%
  filter(Measure == "2021 Enrolled") %>%
  select(!c(StudentGroupType, Measure)) 

enrollment_by_races <- as.data.frame(t(enrollment_by_races)) 
names(enrollment_by_races) <- enrollment_by_races[1, ]
enrollment_by_races <- enrollment_by_races[-1, ] 

chars <- sapply(enrollment_by_races, is.character)
enrollment_by_races[ , chars] <- as.data.frame(apply(enrollment_by_races[ , chars], 
                                                     2, as.numeric))

ggplot(enrollment_by_races,
       aes(fill= ,
                          x= `Student Group`, 
                          y=`All Non-Passing Grades`)) + 
  geom_bar(position="dodge", stat="identity") +
  geom_hline(yintercept = state_ave_18_19) + 
  theme_minimal() +
  coord_flip()
  
```

## plot II: try pie charts? datatype: % = each race/all student; year 2021; each monthly; comparison across different grades
```{r enrollment, include=FALSE}
enrollment_perc_races <- data.frame(matrix(NA,    
                          nrow = nrow(enrollment_by_races),
                          ncol = ncol(enrollment_by_races)))

dimnames(enrollment_perc_races) <- list(rownames(enrollment_by_races), 
                                        colnames(enrollment_by_races))

for (i in 1:nrow(enrollment_by_races)) {
  for (j in ncol(enrollment_by_races):1) {
    enrollment_perc_races[i, j] = percent(enrollment_by_races[i, j]/enrollment_by_races[i,1]*100)
  }
}

#add col "other" for pie charts

```


## plot III: splitted bar w/ % changes; low-income vs. non-low-income; sorted by years or races?

# Absent

### same issue with scraping 10/26

## plot I: year 2021 by races; grades: kindergargen, 3, 6, 8, 9, 10; same as the enrollment plot I

## plot II: datatype: % changed; 2019 vs 2021 (ignore 2020); grades: kindergargen, 3, 6, 8, 9, 10; sorted by races and income levels
```{r graduation, include=FALSE}

df_graduation_pathways

```


```{r reopening, include=FALSE}

df_reopening_survey

```

# Course Taking 
## plot I: counts; only use "non-passing grades"; (sorted by races (Excluding Asian); sorted by income levels; 2020-21; bar; w/ and w/o reference; reference = state ave 

###state ave of all grades? or each grade?? dfs do not have income variables
```{r course taking}
#code need to be generalized and plots need to be touched up

course_by_race <- df_course_outcomes_by_outcome %>%
  filter(`Organization Name` == "Washington State" 
         & `School Year` == "2020-21" 
         & `Student Group` != "Asian"
         & !is.na(`All Non-Passing Grades`)) %>%
  select_if(~!all(is.na(.))) %>%
  mutate(`All Non-Passing Grades` =  percent(`All Non-Passing Grades`))

state_ave_20_21 <- percent('11.0%')
  
course_by_race$`Grade Level` <- 
  factor(course_by_race$`Grade Level`, levels = c("9", "10", "11", "12", "All Grades"))

ggplot(course_by_race,
       aes(fill= `Grade Level`,
                          x= `Student Group`, 
                          y=`All Non-Passing Grades`)) + 
  geom_bar(position="dodge", stat="identity") +
  geom_hline(yintercept = state_ave_20_21) + 
  theme_minimal() +
  coord_flip()


course_by_race <- df_course_outcomes_by_outcome %>%
  filter(`Organization Name` == "Washington State" 
         & `School Year` == "2019-20" 
         & `Student Group` != "Asian"
         & !is.na(`All Non-Passing Grades`)) %>%
  select_if(~!all(is.na(.))) %>%
  mutate(`All Non-Passing Grades` =  percent(`All Non-Passing Grades`))

state_ave_19_20 <- percent('4.8%')
  
course_by_race$`Grade Level` <- 
  factor(course_by_race$`Grade Level`, levels = c("9", "10", "11", "12", "All Grades"))

ggplot(course_by_race,
       aes(fill= `Grade Level`,
                          x= `Student Group`, 
                          y=`All Non-Passing Grades`)) + 
  geom_bar(position="dodge", stat="identity") +
  geom_hline(yintercept = state_ave_19_20) + 
  theme_minimal() +
  coord_flip()


course_by_race <- df_course_outcomes_by_outcome %>%
  filter(`Organization Name` == "Washington State" 
         & `School Year` == "2018-19" 
         & `Student Group` != "Asian"
         & !is.na(`All Non-Passing Grades`)) %>%
  select_if(~!all(is.na(.))) %>%
  mutate(`All Non-Passing Grades` =  percent(`All Non-Passing Grades`))

state_ave_18_19 <- percent('7.4%')
  
course_by_race$`Grade Level` <- 
  factor(course_by_race$`Grade Level`, levels = c("9", "10", "11", "12", "All Grades"))

ggplot(course_by_race,
       aes(fill= `Grade Level`,
                          x= `Student Group`, 
                          y=`All Non-Passing Grades`)) + 
  geom_bar(position="dodge", stat="identity") +
  geom_hline(yintercept = state_ave_18_19) + 
  theme_minimal() +
  coord_flip()
```



### for II and III, need district shape data, follow instruction on Googledoc
### found shapefiles and uploaaded to googledrive 10/26
## plot II: spatial; 


## plot III: spatial;
```{r course_outcomes, include=FALSE}

df_course_outcomes_by_student

df_course_outcomes_by_outcome
```

